{
  "id": "a55a22e9-a3d3-42ce-bd48-2653adb8f7a9",
  "name": "Domain Account and Group Manipulate",
  "description": "Create a random atr-nnnnnnnn account and add it to a domain group (by default, Domain Admins). \n\nThe quickest way to run it is against a domain controller, using `-Session` of `Invoke-AtomicTest`. Alternatively,\nyou need to install PS Module ActiveDirectory (in prereqs) and run the script with appropriare AD privileges to \ncreate the user and alter the group. Automatic installation of the dependency requires an elevated session, \nand is unlikely to work with Powershell Core (untested).\n\nIf you consider running this test against a production Active Directory, the good practise is to create a dedicated\nservice account whose delegation is given onto a dedicated OU for user creation and deletion, as well as delegated\nas group manager of the target group.\n\nExample: `Invoke-AtomicTest -Session $session 'T1098' -TestNames \"Domain Account and Group Manipulate\" -InputArgs @{\"group\" = \"DNSAdmins\" }`\n",
  "platforms": [
    "windows"
  ],
  "steps": [
    {
      "id": "a09ca079-3b27-469e-9d24-0da4d4971094",
      "type": "execute-command",
      "data": {
        "command": "$x = Get-Random -Minimum 2 -Maximum 99\n$y = Get-Random -Minimum 2 -Maximum 99\n$z = Get-Random -Minimum 2 -Maximum 99\n$w = Get-Random -Minimum 2 -Maximum 99\n\nImport-Module ActiveDirectory\n$account = \"#{account_prefix}-$x$y$z\"\nNew-ADUser -Name $account -GivenName \"Test\" -DisplayName $account -SamAccountName $account -Surname $account -Enabled:$False #{create_args}\nAdd-ADGroupMember \"#{group}\" $account",
        "command_type": "powershell"
      },
      "elevation_required": false
    },
    {
      "id": "c7b238dc-e1f4-419d-81a4-90b5947a189a",
      "type": "execute-command",
      "data": {
        "command": "Get-ADUser -LDAPFilter \"(\u0026(samaccountname=#{account_prefix}-*)(givenName=Test))\" | Remove-ADUser -Confirm:$False",
        "command_type": "powershell"
      },
      "elevation_required": false
    },
    {
      "id": "f3dbb31b-1463-4f35-8fd6-84278e58c718",
      "name": "Check dependency 1/1",
      "description": "PS Module ActiveDirectory\n",
      "type": "execute-command",
      "data": {
        "command": "Try {\n    Import-Module ActiveDirectory -ErrorAction Stop | Out-Null\n    exit 0\n} \nCatch {\n    exit 1\n}",
        "command_type": "powershell"
      },
      "elevation_required": false
    },
    {
      "id": "7067a230-99cf-49fc-8d28-f9d57e56c54c",
      "name": "Resolve dependency 1/1",
      "description": "PS Module ActiveDirectory\n",
      "type": "execute-command",
      "data": {
        "command": "if((Get-CimInstance -ClassName Win32_OperatingSystem).ProductType -eq 1) {\n  Add-WindowsCapability -Name (Get-WindowsCapability -Name RSAT.ActiveDirectory.DS* -Online).Name -Online\n} else {\n  Install-WindowsFeature RSAT-AD-PowerShell\n}",
        "command_type": "powershell"
      },
      "elevation_required": false
    },
    {
      "id": "227c05fd-70f2-4ea6-acef-6de6a5bb10ce",
      "name": "Re-check dependency 1/1",
      "description": "PS Module ActiveDirectory\n",
      "type": "execute-command",
      "data": {
        "command": "Try {\n    Import-Module ActiveDirectory -ErrorAction Stop | Out-Null\n    exit 0\n} \nCatch {\n    exit 1\n}",
        "command_type": "powershell"
      },
      "elevation_required": false
    }
  ],
  "flows": [
    {
      "s": "a09ca079-3b27-469e-9d24-0da4d4971094",
      "p": "on-success",
      "o": "c7b238dc-e1f4-419d-81a4-90b5947a189a"
    },
    {
      "s": "a09ca079-3b27-469e-9d24-0da4d4971094",
      "p": "on-failure",
      "o": "c7b238dc-e1f4-419d-81a4-90b5947a189a"
    },
    {
      "s": "f3dbb31b-1463-4f35-8fd6-84278e58c718",
      "p": "on-success",
      "o": "a09ca079-3b27-469e-9d24-0da4d4971094"
    },
    {
      "s": "f3dbb31b-1463-4f35-8fd6-84278e58c718",
      "p": "on-failure",
      "o": "7067a230-99cf-49fc-8d28-f9d57e56c54c"
    },
    {
      "s": "7067a230-99cf-49fc-8d28-f9d57e56c54c",
      "p": "on-success",
      "o": "227c05fd-70f2-4ea6-acef-6de6a5bb10ce"
    },
    {
      "s": "227c05fd-70f2-4ea6-acef-6de6a5bb10ce",
      "p": "on-failure",
      "o": "a09ca079-3b27-469e-9d24-0da4d4971094"
    }
  ],
  "tags": [
    "T1098"
  ],
  "input_arguments": [
    {
      "name": "account_prefix",
      "type": "string",
      "description": "Prefix string of the random username (by default, atr-). Because the cleanup deletes such account based on\na match `(\u0026(samaccountname=#{account_prefix}-*)(givenName=Test))`, if you are to change it, be careful.\n",
      "value": "atr-"
    },
    {
      "name": "group",
      "type": "string",
      "description": "Name of the group to alter",
      "value": "Domain Admins"
    },
    {
      "name": "create_args",
      "type": "string",
      "description": "Additional string appended to New-ADUser call",
      "value": ""
    }
  ]
}