{
  "id": "450e7218-7915-4be4-8b9b-464a49eafcec",
  "name": "Execute base64-encoded PowerShell from Windows Registry",
  "description": "Stores base64-encoded PowerShell code in the Windows Registry and deobfuscates it for execution. This is used by numerous adversaries and malicious tools.\n\nUpon successful execution, powershell will execute encoded command and read/write from the registry.\n",
  "platforms": [
    "windows"
  ],
  "steps": [
    {
      "id": "e88e5139-80d2-4c47-8bfe-127d8b3a7cec",
      "type": "execute-command",
      "data": {
        "command": "$OriginalCommand = '#{powershell_command}'\n$Bytes = [System.Text.Encoding]::Unicode.GetBytes($OriginalCommand)\n$EncodedCommand =[Convert]::ToBase64String($Bytes)\n$EncodedCommand\n\nSet-ItemProperty -Force -Path #{registry_key_storage} -Name #{registry_entry_storage} -Value $EncodedCommand\npowershell.exe -Command \"IEX ([Text.Encoding]::UNICODE.GetString([Convert]::FromBase64String((gp #{registry_key_storage} #{registry_entry_storage}).#{registry_entry_storage})))\"\n",
        "command_type": "powershell"
      },
      "elevation_required": false
    },
    {
      "id": "1ccd1137-534d-4061-bb14-d29046231035",
      "type": "execute-command",
      "data": {
        "command": "Remove-ItemProperty -Force -ErrorAction Ignore -Path #{registry_key_storage} -Name #{registry_entry_storage}\n",
        "command_type": "powershell"
      },
      "elevation_required": false
    }
  ],
  "flows": [
    {
      "s": "e88e5139-80d2-4c47-8bfe-127d8b3a7cec",
      "p": "on-success",
      "o": "1ccd1137-534d-4061-bb14-d29046231035"
    },
    {
      "s": "e88e5139-80d2-4c47-8bfe-127d8b3a7cec",
      "p": "on-failure",
      "o": "1ccd1137-534d-4061-bb14-d29046231035"
    }
  ],
  "tags": [
    "T1027"
  ],
  "input_arguments": [
    {
      "name": "registry_key_storage",
      "type": "string",
      "description": "Windows Registry Key to store code",
      "value": "HKCU:Software\\Microsoft\\Windows\\CurrentVersion"
    },
    {
      "name": "powershell_command",
      "type": "string",
      "description": "PowerShell command to encode",
      "value": "Write-Host \"Hey, Atomic!\""
    },
    {
      "name": "registry_entry_storage",
      "type": "string",
      "description": "Windows Registry entry to store code under key",
      "value": "Debug"
    }
  ]
}