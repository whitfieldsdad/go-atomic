{
  "id": "2748ab4a-1e0b-4cf2-a2b0-8ef765bec7be",
  "name": "Command Execution with NirCmd",
  "description": "NirCmd is used by threat actors to execute commands, which can include recon and privilege escalation via running commands via the SYSTEM account\nSee https://www.kroll.com/en/insights/publications/cyber/black-basta-technical-analysis\n",
  "platforms": [
    "windows"
  ],
  "steps": [
    {
      "id": "21d1355b-e58b-4b84-bfb1-1a46920e82c5",
      "type": "execute-command",
      "data": {
        "command": "cmd /c \"#{nircmd_location}\" #{command_to_execute}\n",
        "command_type": "powershell"
      },
      "elevation_required": false
    },
    {
      "id": "a30b9eb3-ecc5-4bf9-ad1c-eaaf2c57d814",
      "type": "execute-command",
      "data": {
        "command": "cmd /c \"#{nircmd_location}\" #{cleanup_command_to_execute} -erroraction silentlycontinue | out-null\n",
        "command_type": "powershell"
      },
      "elevation_required": false
    },
    {
      "id": "daf5c3a4-6c38-497e-bdce-cb9ea8aacd74",
      "name": "Check dependency 1/1",
      "description": "The Nircmd executable must exist at (#{nircmd_location})\n",
      "type": "execute-command",
      "data": {
        "command": "if (Test-Path \"#{nircmd_location}\") {exit 0} else {exit 1}\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "5ca882ec-27df-4dde-a66f-a4919332fc9d",
      "name": "Resolve dependency 1/1",
      "description": "The Nircmd executable must exist at (#{nircmd_location})\n",
      "type": "execute-command",
      "data": {
        "command": "New-Item -Type Directory \"PathToAtomicsFolder\\..\\ExternalPayloads\\\" -ErrorAction Ignore -Force | Out-Null\ninvoke-webrequest \"https://www.nirsoft.net/utils/nircmd-x64.zip\" -outfile \"PathToAtomicsFolder\\..\\ExternalPayloads\\nircmd.zip\" \nexpand-archive -path \"PathToAtomicsFolder\\..\\ExternalPayloads\\nircmd.zip\" -destinationpath \"PathToAtomicsFolder\\..\\ExternalPayloads\\\"\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "8a5ad8ca-cd49-4737-9870-38e9ef20c488",
      "name": "Re-check dependency 1/1",
      "description": "The Nircmd executable must exist at (#{nircmd_location})\n",
      "type": "execute-command",
      "data": {
        "command": "if (Test-Path \"#{nircmd_location}\") {exit 0} else {exit 1}\n",
        "command_type": ""
      },
      "elevation_required": false
    }
  ],
  "flows": [
    {
      "s": "21d1355b-e58b-4b84-bfb1-1a46920e82c5",
      "p": "on-success",
      "o": "a30b9eb3-ecc5-4bf9-ad1c-eaaf2c57d814"
    },
    {
      "s": "21d1355b-e58b-4b84-bfb1-1a46920e82c5",
      "p": "on-failure",
      "o": "a30b9eb3-ecc5-4bf9-ad1c-eaaf2c57d814"
    },
    {
      "s": "daf5c3a4-6c38-497e-bdce-cb9ea8aacd74",
      "p": "on-success",
      "o": "21d1355b-e58b-4b84-bfb1-1a46920e82c5"
    },
    {
      "s": "daf5c3a4-6c38-497e-bdce-cb9ea8aacd74",
      "p": "on-failure",
      "o": "5ca882ec-27df-4dde-a66f-a4919332fc9d"
    },
    {
      "s": "5ca882ec-27df-4dde-a66f-a4919332fc9d",
      "p": "on-success",
      "o": "8a5ad8ca-cd49-4737-9870-38e9ef20c488"
    },
    {
      "s": "8a5ad8ca-cd49-4737-9870-38e9ef20c488",
      "p": "on-failure",
      "o": "21d1355b-e58b-4b84-bfb1-1a46920e82c5"
    }
  ],
  "tags": [
    "T1564",
    "atomic-red-team"
  ],
  "input_arguments": [
    {
      "name": "command_to_execute",
      "type": "Path",
      "description": "Command for nircmd to execute",
      "value": "win child class \"Shell_TrayWnd\" hide class \"TrayClockWClass\""
    },
    {
      "name": "cleanup_command_to_execute",
      "type": "Path",
      "description": "Cleanup command to undo the arbitrary command ran by nircmd",
      "value": "win child class \"Shell_TrayWnd\" show class \"TrayClockWClass\""
    },
    {
      "name": "nircmd_location",
      "type": "Path",
      "description": "Location of nircmd executable",
      "value": "PathToAtomicsFolder\\..\\ExternalPayloads\\nircmd.exe"
    }
  ]
}