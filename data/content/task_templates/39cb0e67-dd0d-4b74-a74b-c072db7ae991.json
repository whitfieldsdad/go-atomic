{
  "id": "39cb0e67-dd0d-4b74-a74b-c072db7ae991",
  "name": "Shared Library Injection via /etc/ld.so.preload",
  "description": "This test adds a shared library to the `ld.so.preload` list to execute and intercept API calls. This technique was used by threat actor Rocke during the exploitation of Linux web servers. This requires the `glibc` package.\n\nUpon successful execution, bash will echo `../bin/T1574.006.so` to /etc/ld.so.preload. \n",
  "platforms": [
    "linux"
  ],
  "steps": [
    {
      "id": "5e345158-d161-4ddc-a827-33f4e38d8459",
      "type": "execute-command",
      "data": {
        "command": "sudo sh -c 'echo #{path_to_shared_library} \u003e /etc/ld.so.preload'\n",
        "command_type": "bash"
      },
      "elevation_required": false
    },
    {
      "id": "d1a2e92a-a414-4423-88f4-9cd902ae825e",
      "type": "execute-command",
      "data": {
        "command": "sudo sed -i 's##{path_to_shared_library}##' /etc/ld.so.preload\n",
        "command_type": "bash"
      },
      "elevation_required": false
    },
    {
      "id": "7a9f9ef7-128d-438e-acf3-55faedfc4086",
      "name": "Check dependency 1/1",
      "description": "The shared library must exist on disk at specified location (#{path_to_shared_library})\n",
      "type": "execute-command",
      "data": {
        "command": "if [ -f #{path_to_shared_library} ]; then exit 0; else exit 1; fi;\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "d862e318-d9a9-404e-870f-0aa9ad70a859",
      "name": "Resolve dependency 1/1",
      "description": "The shared library must exist on disk at specified location (#{path_to_shared_library})\n",
      "type": "execute-command",
      "data": {
        "command": "gcc -shared -fPIC -o #{path_to_shared_library} #{path_to_shared_library_source}\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "3383acd2-f798-4cfd-ba47-1ef9261920da",
      "name": "Re-check dependency 1/1",
      "description": "The shared library must exist on disk at specified location (#{path_to_shared_library})\n",
      "type": "execute-command",
      "data": {
        "command": "if [ -f #{path_to_shared_library} ]; then exit 0; else exit 1; fi;\n",
        "command_type": ""
      },
      "elevation_required": false
    }
  ],
  "flows": [
    {
      "s": "5e345158-d161-4ddc-a827-33f4e38d8459",
      "p": "on-success",
      "o": "d1a2e92a-a414-4423-88f4-9cd902ae825e"
    },
    {
      "s": "5e345158-d161-4ddc-a827-33f4e38d8459",
      "p": "on-failure",
      "o": "d1a2e92a-a414-4423-88f4-9cd902ae825e"
    },
    {
      "s": "7a9f9ef7-128d-438e-acf3-55faedfc4086",
      "p": "on-success",
      "o": "5e345158-d161-4ddc-a827-33f4e38d8459"
    },
    {
      "s": "7a9f9ef7-128d-438e-acf3-55faedfc4086",
      "p": "on-failure",
      "o": "d862e318-d9a9-404e-870f-0aa9ad70a859"
    },
    {
      "s": "d862e318-d9a9-404e-870f-0aa9ad70a859",
      "p": "on-success",
      "o": "3383acd2-f798-4cfd-ba47-1ef9261920da"
    },
    {
      "s": "3383acd2-f798-4cfd-ba47-1ef9261920da",
      "p": "on-failure",
      "o": "5e345158-d161-4ddc-a827-33f4e38d8459"
    }
  ],
  "tags": [
    "T1574.006",
    "atomic-red-team"
  ],
  "input_arguments": [
    {
      "name": "path_to_shared_library_source",
      "type": "path",
      "description": "Path to a shared library source code",
      "value": "PathToAtomicsFolder/T1574.006/src/Linux/T1574.006.c"
    },
    {
      "name": "path_to_shared_library",
      "type": "path",
      "description": "Path to a shared library object",
      "value": "/tmp/T1574006.so"
    }
  ]
}