{
  "id": "26a18d3d-f8bc-486b-9a33-d6df5d78a594",
  "name": "Azure Security Scan with SkyArk",
  "description": "Upon successful execution, this test will utilize a valid read-only Azure AD user's credentials to conduct a security scan and determine what users exist in a given tenant, as well as identify any admin users. \nOnce the test is complete, a folder will be output to the temp directory that contains 3 csv files which provide info on the discovered users. \nSee https://github.com/cyberark/SkyArk \n",
  "platforms": [
    "azure-ad"
  ],
  "steps": [
    {
      "id": "e27245c3-974a-4a20-809e-c002c233ec9c",
      "type": "execute-command",
      "data": {
        "command": "Import-Module \"PathToAtomicsFolder\\..\\ExternalPayloads\\AzureStealth.ps1\" -force      \n$Password = ConvertTo-SecureString -String \"#{password}\" -AsPlainText -Force\n$Credential = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList \"#{username}\", $Password\nConnect-AzAccount -Credential $Credential\nConnect-AzureAD -Credential $Credential\nScan-AzureAdmins -UseCurrentCred\n",
        "command_type": "powershell"
      },
      "elevation_required": false
    },
    {
      "id": "61b35fdd-fadd-4211-bd2b-8e10e4cb8904",
      "type": "execute-command",
      "data": {
        "command": "$resultstime = Get-Date -Format \"yyyyMMdd\"\n$resultsfolder = (\"Results-\" + $resultstime)\nremove-item $env:temp\\$resultsfolder -recurse -force -erroraction silentlycontinue\n",
        "command_type": "powershell"
      },
      "elevation_required": false
    },
    {
      "id": "8e5acb0d-8968-4505-aa23-2f34b1cefe03",
      "name": "Check dependency 1/3",
      "description": "The SkyArk AzureStealth module must exist in PathToAtomicsFolder\\..\\ExternalPayloads.\n",
      "type": "execute-command",
      "data": {
        "command": "if (test-path \"PathToAtomicsFolder\\..\\ExternalPayloads\\AzureStealth.ps1\"){exit 0} else {exit 1}\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "108eb886-f1f5-4d63-916d-b1246b2ba473",
      "name": "Resolve dependency 1/3",
      "description": "The SkyArk AzureStealth module must exist in PathToAtomicsFolder\\..\\ExternalPayloads.\n",
      "type": "execute-command",
      "data": {
        "command": "New-Item -Type Directory \"PathToAtomicsFolder\\..\\ExternalPayloads\\\" -ErrorAction Ignore -Force | Out-Null\ninvoke-webrequest \"https://raw.githubusercontent.com/cyberark/SkyArk/3293ee145e95061a8980dd7b5da0030edc4da5c0/AzureStealth/AzureStealth.ps1\" -outfile \"PathToAtomicsFolder\\..\\ExternalPayloads\\AzureStealth.ps1\"\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "3afa82fe-360e-4177-bf6c-580e8e1ac5ed",
      "name": "Re-check dependency 1/3",
      "description": "The SkyArk AzureStealth module must exist in PathToAtomicsFolder\\..\\ExternalPayloads.\n",
      "type": "execute-command",
      "data": {
        "command": "if (test-path \"PathToAtomicsFolder\\..\\ExternalPayloads\\AzureStealth.ps1\"){exit 0} else {exit 1}\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "ebf34a3f-c3de-4353-91cc-149e2b366d76",
      "name": "Check dependency 2/3",
      "description": "The AzureAD module must be installed.\n",
      "type": "execute-command",
      "data": {
        "command": "try {if (Get-InstalledModule -Name AzureAD -ErrorAction SilentlyContinue) {exit 0} else {exit 1}} catch {exit 1}\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "0a419f45-74f6-4de7-8f48-659d41eee9e3",
      "name": "Resolve dependency 2/3",
      "description": "The AzureAD module must be installed.\n",
      "type": "execute-command",
      "data": {
        "command": "Install-Module -Name AzureAD -Force\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "a9655a29-7430-4dfd-9234-fb8b4e7fe110",
      "name": "Re-check dependency 2/3",
      "description": "The AzureAD module must be installed.\n",
      "type": "execute-command",
      "data": {
        "command": "try {if (Get-InstalledModule -Name AzureAD -ErrorAction SilentlyContinue) {exit 0} else {exit 1}} catch {exit 1}\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "69bfcd60-9b76-4c98-a8be-bc4da43e527f",
      "name": "Check dependency 3/3",
      "description": "The Az module must be installed.\n",
      "type": "execute-command",
      "data": {
        "command": "try {if (Get-InstalledModule -Name Az -ErrorAction SilentlyContinue) {exit 0} else {exit 1}} catch {exit 1}\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "8bb59023-d8fc-49a5-950c-52af98daf018",
      "name": "Resolve dependency 3/3",
      "description": "The Az module must be installed.\n",
      "type": "execute-command",
      "data": {
        "command": "Install-Module -Name Az -Force\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "0b038dab-2ada-45a2-a0f1-d875c9a6dd80",
      "name": "Re-check dependency 3/3",
      "description": "The Az module must be installed.\n",
      "type": "execute-command",
      "data": {
        "command": "try {if (Get-InstalledModule -Name Az -ErrorAction SilentlyContinue) {exit 0} else {exit 1}} catch {exit 1}\n",
        "command_type": ""
      },
      "elevation_required": false
    }
  ],
  "flows": [
    {
      "s": "e27245c3-974a-4a20-809e-c002c233ec9c",
      "p": "on-success",
      "o": "61b35fdd-fadd-4211-bd2b-8e10e4cb8904"
    },
    {
      "s": "e27245c3-974a-4a20-809e-c002c233ec9c",
      "p": "on-failure",
      "o": "61b35fdd-fadd-4211-bd2b-8e10e4cb8904"
    },
    {
      "s": "8e5acb0d-8968-4505-aa23-2f34b1cefe03",
      "p": "on-success",
      "o": "e27245c3-974a-4a20-809e-c002c233ec9c"
    },
    {
      "s": "8e5acb0d-8968-4505-aa23-2f34b1cefe03",
      "p": "on-failure",
      "o": "108eb886-f1f5-4d63-916d-b1246b2ba473"
    },
    {
      "s": "108eb886-f1f5-4d63-916d-b1246b2ba473",
      "p": "on-success",
      "o": "3afa82fe-360e-4177-bf6c-580e8e1ac5ed"
    },
    {
      "s": "3afa82fe-360e-4177-bf6c-580e8e1ac5ed",
      "p": "on-failure",
      "o": "e27245c3-974a-4a20-809e-c002c233ec9c"
    },
    {
      "s": "ebf34a3f-c3de-4353-91cc-149e2b366d76",
      "p": "on-success",
      "o": "e27245c3-974a-4a20-809e-c002c233ec9c"
    },
    {
      "s": "ebf34a3f-c3de-4353-91cc-149e2b366d76",
      "p": "on-failure",
      "o": "0a419f45-74f6-4de7-8f48-659d41eee9e3"
    },
    {
      "s": "0a419f45-74f6-4de7-8f48-659d41eee9e3",
      "p": "on-success",
      "o": "a9655a29-7430-4dfd-9234-fb8b4e7fe110"
    },
    {
      "s": "a9655a29-7430-4dfd-9234-fb8b4e7fe110",
      "p": "on-failure",
      "o": "e27245c3-974a-4a20-809e-c002c233ec9c"
    },
    {
      "s": "69bfcd60-9b76-4c98-a8be-bc4da43e527f",
      "p": "on-success",
      "o": "e27245c3-974a-4a20-809e-c002c233ec9c"
    },
    {
      "s": "69bfcd60-9b76-4c98-a8be-bc4da43e527f",
      "p": "on-failure",
      "o": "8bb59023-d8fc-49a5-950c-52af98daf018"
    },
    {
      "s": "8bb59023-d8fc-49a5-950c-52af98daf018",
      "p": "on-success",
      "o": "0b038dab-2ada-45a2-a0f1-d875c9a6dd80"
    },
    {
      "s": "0b038dab-2ada-45a2-a0f1-d875c9a6dd80",
      "p": "on-failure",
      "o": "e27245c3-974a-4a20-809e-c002c233ec9c"
    }
  ],
  "tags": [
    "T1082",
    "atomic-red-team"
  ],
  "input_arguments": [
    {
      "name": "password",
      "type": "string",
      "description": "Azure AD password",
      "value": "T1082Az"
    },
    {
      "name": "username",
      "type": "string",
      "description": "Azure AD username",
      "value": ""
    }
  ]
}