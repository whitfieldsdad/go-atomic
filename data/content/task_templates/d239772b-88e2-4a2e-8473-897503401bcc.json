{
  "id": "d239772b-88e2-4a2e-8473-897503401bcc",
  "name": "Download a file with Microsoft Connection Manager Auto-Download",
  "description": "Uses the cmdl32 to download arbitrary file from the internet. The cmdl32 package is allowed to install the profile used to launch the VPN connection. However, the config is modified to download the arbitary file. \nThe issue of cmdl32.exe detecting and deleting the payload by identifying it as not a VPN Servers profile is avoided by setting a temporary TMP folder and denying the delete permission to all files for the user.\nUpon successful execution the test will open calculator and Notepad executable for 10 seconds.\nreference:\nhttps://twitter.com/ElliotKillick/status/1455897435063074824\nhttps://github.com/LOLBAS-Project/LOLBAS/pull/151\nhttps://lolbas-project.github.io/lolbas/Binaries/Cmdl32/\nhttps://strontic.github.io/xcyclopedia/library/cmdl32.exe-FA1D5B8802FFF4A85B6F52A52C871BBB.html\n",
  "platforms": [
    "windows"
  ],
  "steps": [
    {
      "id": "c1225af3-b453-429f-bdcc-b5f86aa5cdbb",
      "type": "execute-command",
      "data": {
        "command": "\"#{Path_to_file}\" 1\u003eNUL \n",
        "command_type": "command_prompt"
      },
      "elevation_required": false
    },
    {
      "id": "c74c271c-451a-47ff-b311-1dc103f5b4d3",
      "type": "execute-command",
      "data": {
        "command": "del /f/s/q %temp%\\T1105 \u003enul 2\u003e\u00261\nrmdir /s/q %temp%\\T1105 \u003enul 2\u003e\u00261\n",
        "command_type": "command_prompt"
      },
      "elevation_required": false
    },
    {
      "id": "ce92830c-746c-4e35-8518-0aca3fd19a00",
      "name": "Check dependency 1/1",
      "description": "#{Path_to_file} must exist on system.\n",
      "type": "execute-command",
      "data": {
        "command": "if (Test-Path \"#{Path_to_file}\") {exit 0} else {exit 1}\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "d318cf9b-5bd0-46e9-889b-de5344686bf8",
      "name": "Resolve dependency 1/1",
      "description": "#{Path_to_file} must exist on system.\n",
      "type": "execute-command",
      "data": {
        "command": "New-Item -Type Directory (split-path \"#{Path_to_file}\") -ErrorAction ignore | Out-Null\nInvoke-WebRequest \"https://github.com/redcanaryco/atomic-red-team/raw/master/atomics/T1105/src/T1105.bat\" -OutFile \"#{Path_to_file}\"\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "be56d144-2796-4af2-9e4a-82404daf6bda",
      "name": "Re-check dependency 1/1",
      "description": "#{Path_to_file} must exist on system.\n",
      "type": "execute-command",
      "data": {
        "command": "if (Test-Path \"#{Path_to_file}\") {exit 0} else {exit 1}\n",
        "command_type": ""
      },
      "elevation_required": false
    }
  ],
  "flows": [
    {
      "s": "c1225af3-b453-429f-bdcc-b5f86aa5cdbb",
      "p": "on-success",
      "o": "c74c271c-451a-47ff-b311-1dc103f5b4d3"
    },
    {
      "s": "c1225af3-b453-429f-bdcc-b5f86aa5cdbb",
      "p": "on-failure",
      "o": "c74c271c-451a-47ff-b311-1dc103f5b4d3"
    },
    {
      "s": "ce92830c-746c-4e35-8518-0aca3fd19a00",
      "p": "on-success",
      "o": "c1225af3-b453-429f-bdcc-b5f86aa5cdbb"
    },
    {
      "s": "ce92830c-746c-4e35-8518-0aca3fd19a00",
      "p": "on-failure",
      "o": "d318cf9b-5bd0-46e9-889b-de5344686bf8"
    },
    {
      "s": "d318cf9b-5bd0-46e9-889b-de5344686bf8",
      "p": "on-success",
      "o": "be56d144-2796-4af2-9e4a-82404daf6bda"
    },
    {
      "s": "be56d144-2796-4af2-9e4a-82404daf6bda",
      "p": "on-failure",
      "o": "c1225af3-b453-429f-bdcc-b5f86aa5cdbb"
    }
  ],
  "tags": [
    "T1105",
    "atomic-red-team"
  ],
  "input_arguments": [
    {
      "name": "Path_to_file",
      "type": "path",
      "description": "Path to the Batch script",
      "value": "PathToAtomicsFolder\\T1105\\src\\T1105.bat"
    }
  ]
}