{
  "id": "7a48f482-246f-4aeb-9837-21c271ebf244",
  "name": "Cobalt Strike post-exploitation pipe (4.2 and later)",
  "description": "Uses the [Named Pipes Micro Emulation](https://github.com/center-for-threat-informed-defense/adversary_emulation_library/tree/master/micro_emulation_plans/src/named_pipes) executable from the Center for Threat Informed Defense to create a named pipe for inter-process communication.\n\nThe named pipe executable will pause for 30 seconds to allow the client and server to exchange a message through the pipe.\n",
  "platforms": [
    "windows"
  ],
  "steps": [
    {
      "id": "070bf3ad-c0dc-4eb4-b446-c786027c5120",
      "type": "execute-command",
      "data": {
        "command": "\"PathToAtomicsFolder\\..\\ExternalPayloads\\build\\namedpipes_executor.exe\" --pipe 4\n",
        "command_type": "command_prompt"
      },
      "elevation_required": false
    },
    {
      "id": "733219ee-888e-4ab0-b221-1ad735a30a79",
      "name": "Check dependency 1/1",
      "description": "Named pipe executors must exist on disk\n",
      "type": "execute-command",
      "data": {
        "command": "if ((Test-Path \"PathToAtomicsFolder\\..\\ExternalPayloads\\build\\namedpipes_executor.exe\") -and (Test-Path \"PathToAtomicsFolder\\..\\ExternalPayloads\\build\\namedpipes_client.exe\") -and (Test-Path \"PathToAtomicsFolder\\..\\ExternalPayloads\\build\\namedpipes_server.exe\")) {exit 0} else {exit 1}\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "a90e8977-6cf7-47ff-8619-cc638aa91eef",
      "name": "Resolve dependency 1/1",
      "description": "Named pipe executors must exist on disk\n",
      "type": "execute-command",
      "data": {
        "command": "New-Item -Type Directory \"PathToAtomicsFolder\\..\\ExternalPayloads\\\" -ErrorAction ignore -Force | Out-Null\n[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12\nIEX (iwr \"https://raw.githubusercontent.com/redcanaryco/invoke-atomicredteam/master/Public/Invoke-FetchFromZip.ps1\" -UseBasicParsing)\n$zipUrl  = \"https://github.com/center-for-threat-informed-defense/adversary_emulation_library/raw/master/micro_emulation_plans/src/named_pipes/named_pipes.zip\"\nInvoke-FetchFromZip $zipUrl \"*.exe\" \"PathToAtomicsFolder\\..\\ExternalPayloads\"\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "7371966c-b150-4505-be8a-9e1d14bc5703",
      "name": "Re-check dependency 1/1",
      "description": "Named pipe executors must exist on disk\n",
      "type": "execute-command",
      "data": {
        "command": "if ((Test-Path \"PathToAtomicsFolder\\..\\ExternalPayloads\\build\\namedpipes_executor.exe\") -and (Test-Path \"PathToAtomicsFolder\\..\\ExternalPayloads\\build\\namedpipes_client.exe\") -and (Test-Path \"PathToAtomicsFolder\\..\\ExternalPayloads\\build\\namedpipes_server.exe\")) {exit 0} else {exit 1}\n",
        "command_type": ""
      },
      "elevation_required": false
    }
  ],
  "flows": [
    {
      "s": "733219ee-888e-4ab0-b221-1ad735a30a79",
      "p": "on-success",
      "o": "070bf3ad-c0dc-4eb4-b446-c786027c5120"
    },
    {
      "s": "733219ee-888e-4ab0-b221-1ad735a30a79",
      "p": "on-failure",
      "o": "a90e8977-6cf7-47ff-8619-cc638aa91eef"
    },
    {
      "s": "a90e8977-6cf7-47ff-8619-cc638aa91eef",
      "p": "on-success",
      "o": "7371966c-b150-4505-be8a-9e1d14bc5703"
    },
    {
      "s": "7371966c-b150-4505-be8a-9e1d14bc5703",
      "p": "on-failure",
      "o": "070bf3ad-c0dc-4eb4-b446-c786027c5120"
    }
  ],
  "tags": [
    "T1559",
    "atomic-red-team"
  ]
}