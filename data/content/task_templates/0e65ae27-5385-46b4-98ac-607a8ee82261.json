{
  "id": "0e65ae27-5385-46b4-98ac-607a8ee82261",
  "name": "Azure AD - adding user to Azure AD role",
  "description": "The adversaries want to add user to some Azure AD role. Threat actor \nmay be interested primarily in highly privileged roles, e.g. Global Administrator, Application Administrator, \nPrivileged Authentication Administrator (this role can reset Global Administrator password!).\nBy default, the role Global Reader is assigned to the user principal in this test.\n\nThe account you use to run the PowerShell command should have Privileged Role Administrator or Global Administrator role in your Azure AD.\n\nDetection hint - check Activity \"Add member to role\" in Azure AD Audit Logs. In targer you will also see User as a type.\n",
  "platforms": [
    "azure-ad"
  ],
  "steps": [
    {
      "id": "b01586f3-3865-4df1-99ac-bd7b508a33b7",
      "type": "execute-command",
      "data": {
        "command": "Import-Module -Name AzureAD\n$PWord = ConvertTo-SecureString -String \"#{password}\" -AsPlainText -Force\n$Credential = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList \"#{username}\", $Pword\nConnect-AzureAD -Credential $Credential\n\n$user = Get-AzureADUser -Filter \"DisplayName eq '#{user_principal_name}' or UserPrincipalName eq '#{user_principal_name}'\"\nif ($user -eq $null) { Write-Warning \"User not found\"; exit }\n$role = Get-AzureADDirectoryRole -Filter \"DisplayName eq '#{role_name}'\"\nif ($role -eq $null) { Write-Warning \"Role not found\"; exit }\nAdd-AzureADDirectoryRoleMember -ObjectId $role.ObjectId -RefObjectId $user.ObjectId\nWrite-Host \"User $($user.DisplayName) was added to $($role.DisplayName) role\"",
        "command_type": "powershell"
      },
      "elevation_required": false
    },
    {
      "id": "8f98f66e-5d5e-45ad-aecd-45e4c5776fd0",
      "type": "execute-command",
      "data": {
        "command": "Import-Module -Name AzureAD -ErrorAction Ignore\n$PWord = ConvertTo-SecureString -String \"#{password}\" -AsPlainText -Force\n$Credential = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList \"#{username}\", $Pword\nConnect-AzureAD -Credential $Credential -ErrorAction Ignore\n\n$user = Get-AzureADUser -Filter \"DisplayName eq '#{user_principal_name}' or UserPrincipalName eq '#{user_principal_name}'\"\nif ($user -eq $null) { Write-Warning \"User not found\"; exit }\n$role = Get-AzureADDirectoryRole -Filter \"DisplayName eq '#{role_name}'\"\nif ($role -eq $null) { Write-Warning \"Role not found\"; exit }\n\nRemove-AzureADDirectoryRoleMember -ObjectId $role.ObjectId -MemberId $user.ObjectId\nWrite-Host \"User $($user.DisplayName) was removed from $($role.DisplayName) role\"",
        "command_type": "powershell"
      },
      "elevation_required": false
    },
    {
      "id": "dd7acf1d-71f8-4b6a-a13f-158f21b30d72",
      "name": "Check dependency 1/1",
      "description": "AzureAD module must be installed.\n",
      "type": "execute-command",
      "data": {
        "command": "try {if (Get-InstalledModule -Name AzureAD -ErrorAction SilentlyContinue) {exit 0} else {exit 1}} catch {exit 1}",
        "command_type": "powershell"
      },
      "elevation_required": false
    },
    {
      "id": "4f5228d0-c74f-4a4a-8b78-29e3ebf6dffa",
      "name": "Resolve dependency 1/1",
      "description": "AzureAD module must be installed.\n",
      "type": "execute-command",
      "data": {
        "command": "Install-Module -Name AzureAD -Force",
        "command_type": "powershell"
      },
      "elevation_required": false
    },
    {
      "id": "7821d52e-d6e6-4bd5-8669-4e0c2c19b213",
      "name": "Re-check dependency 1/1",
      "description": "AzureAD module must be installed.\n",
      "type": "execute-command",
      "data": {
        "command": "try {if (Get-InstalledModule -Name AzureAD -ErrorAction SilentlyContinue) {exit 0} else {exit 1}} catch {exit 1}",
        "command_type": "powershell"
      },
      "elevation_required": false
    }
  ],
  "flows": [
    {
      "s": "b01586f3-3865-4df1-99ac-bd7b508a33b7",
      "p": "on-success",
      "o": "8f98f66e-5d5e-45ad-aecd-45e4c5776fd0"
    },
    {
      "s": "b01586f3-3865-4df1-99ac-bd7b508a33b7",
      "p": "on-failure",
      "o": "8f98f66e-5d5e-45ad-aecd-45e4c5776fd0"
    },
    {
      "s": "dd7acf1d-71f8-4b6a-a13f-158f21b30d72",
      "p": "on-success",
      "o": "b01586f3-3865-4df1-99ac-bd7b508a33b7"
    },
    {
      "s": "dd7acf1d-71f8-4b6a-a13f-158f21b30d72",
      "p": "on-failure",
      "o": "4f5228d0-c74f-4a4a-8b78-29e3ebf6dffa"
    },
    {
      "s": "4f5228d0-c74f-4a4a-8b78-29e3ebf6dffa",
      "p": "on-success",
      "o": "7821d52e-d6e6-4bd5-8669-4e0c2c19b213"
    },
    {
      "s": "7821d52e-d6e6-4bd5-8669-4e0c2c19b213",
      "p": "on-failure",
      "o": "b01586f3-3865-4df1-99ac-bd7b508a33b7"
    }
  ],
  "tags": [
    "T1098"
  ],
  "input_arguments": [
    {
      "name": "username",
      "type": "string",
      "description": "Azure AD username",
      "value": "jonh@contoso.com"
    },
    {
      "name": "password",
      "type": "string",
      "description": "Azure AD password",
      "value": "p4sswd"
    },
    {
      "name": "user_principal_name",
      "type": "string",
      "description": "Display Name, or User Principal Name, of the targeted user principal",
      "value": "SuperUser"
    },
    {
      "name": "role_name",
      "type": "string",
      "description": "Name of the targeted Azure AD role",
      "value": "Global Reader"
    }
  ]
}