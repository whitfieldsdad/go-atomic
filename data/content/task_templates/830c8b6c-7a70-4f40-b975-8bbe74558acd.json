{
  "id": "830c8b6c-7a70-4f40-b975-8bbe74558acd",
  "name": "Cobalt Strike Lateral Movement (psexec_psh) pipe",
  "description": "Uses the [Named Pipes Micro Emulation](https://github.com/center-for-threat-informed-defense/adversary_emulation_library/tree/master/micro_emulation_plans/src/named_pipes) executable from the Center for Threat Informed Defense to create a named pipe for inter-process communication.\n\nThe named pipe executable will pause for 30 seconds to allow the client and server to exchange a message through the pipe.\n",
  "platforms": [
    "windows"
  ],
  "steps": [
    {
      "id": "9a36c139-2f15-4f58-a6c2-d22d573cd859",
      "type": "execute-command",
      "data": {
        "command": "\"PathToAtomicsFolder\\..\\ExternalPayloads\\build\\namedpipes_executor.exe\" --pipe 2\n",
        "command_type": "command_prompt"
      },
      "elevation_required": false
    },
    {
      "id": "655e6106-e078-4621-8103-55502c7e165e",
      "name": "Check dependency 1/1",
      "description": "Named pipe executors must exist on disk\n",
      "type": "execute-command",
      "data": {
        "command": "if ((Test-Path \"PathToAtomicsFolder\\..\\ExternalPayloads\\build\\namedpipes_executor.exe\") -and (Test-Path \"PathToAtomicsFolder\\..\\ExternalPayloads\\build\\namedpipes_client.exe\") -and (Test-Path \"PathToAtomicsFolder\\..\\ExternalPayloads\\build\\namedpipes_server.exe\")) {exit 0} else {exit 1}\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "1d2a48a5-7f83-4219-bcb3-9d0223e5c310",
      "name": "Resolve dependency 1/1",
      "description": "Named pipe executors must exist on disk\n",
      "type": "execute-command",
      "data": {
        "command": "New-Item -Type Directory \"PathToAtomicsFolder\\..\\ExternalPayloads\\\" -ErrorAction ignore -Force | Out-Null\n[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12\nIEX (iwr \"https://raw.githubusercontent.com/redcanaryco/invoke-atomicredteam/master/Public/Invoke-FetchFromZip.ps1\" -UseBasicParsing)\n$zipUrl  = \"https://github.com/center-for-threat-informed-defense/adversary_emulation_library/raw/master/micro_emulation_plans/src/named_pipes/named_pipes.zip\"\nInvoke-FetchFromZip $zipUrl \"*.exe\" \"PathToAtomicsFolder\\..\\ExternalPayloads\"\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "e09b1009-120f-4d24-b237-b9d6fe479e43",
      "name": "Re-check dependency 1/1",
      "description": "Named pipe executors must exist on disk\n",
      "type": "execute-command",
      "data": {
        "command": "if ((Test-Path \"PathToAtomicsFolder\\..\\ExternalPayloads\\build\\namedpipes_executor.exe\") -and (Test-Path \"PathToAtomicsFolder\\..\\ExternalPayloads\\build\\namedpipes_client.exe\") -and (Test-Path \"PathToAtomicsFolder\\..\\ExternalPayloads\\build\\namedpipes_server.exe\")) {exit 0} else {exit 1}\n",
        "command_type": ""
      },
      "elevation_required": false
    }
  ],
  "flows": [
    {
      "s": "655e6106-e078-4621-8103-55502c7e165e",
      "p": "on-success",
      "o": "9a36c139-2f15-4f58-a6c2-d22d573cd859"
    },
    {
      "s": "655e6106-e078-4621-8103-55502c7e165e",
      "p": "on-failure",
      "o": "1d2a48a5-7f83-4219-bcb3-9d0223e5c310"
    },
    {
      "s": "1d2a48a5-7f83-4219-bcb3-9d0223e5c310",
      "p": "on-success",
      "o": "e09b1009-120f-4d24-b237-b9d6fe479e43"
    },
    {
      "s": "e09b1009-120f-4d24-b237-b9d6fe479e43",
      "p": "on-failure",
      "o": "9a36c139-2f15-4f58-a6c2-d22d573cd859"
    }
  ],
  "tags": [
    "T1559",
    "atomic-red-team"
  ]
}