{
  "id": "873106b7-cfed-454b-8680-fa9f6400431c",
  "name": "Use PsExec to execute a command on a remote host",
  "description": "Requires having Sysinternals installed, path to sysinternals is one of the input input_arguments\nWill start a process on a remote host.\n\nUpon successful execution, cmd will utilize psexec.exe to spawn calc.exe on a remote endpoint (default:localhost).\n",
  "platforms": [
    "windows"
  ],
  "steps": [
    {
      "id": "33455d91-a00c-4e52-a288-20d38c06341d",
      "type": "execute-command",
      "data": {
        "command": "\"PathToAtomicsFolder\\..\\ExternalPayloads\\PsExec.exe\" \\\\#{remote_host} -u #{user_name} -p #{password} -accepteula \"C:\\Windows\\System32\\calc.exe\"\n",
        "command_type": "command_prompt"
      },
      "elevation_required": false
    },
    {
      "id": "045291d0-9e0f-4fba-9ef3-494a792a9500",
      "name": "Check dependency 1/1",
      "description": "PsExec tool from Sysinternals must exist in the ExternalPayloads directory\n",
      "type": "execute-command",
      "data": {
        "command": "if (Test-Path \"PathToAtomicsFolder\\..\\ExternalPayloads\\PsExec.exe\") { exit 0} else { exit 1}\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "dd0504d8-d8ff-47e0-86d9-71ebdeb704de",
      "name": "Resolve dependency 1/1",
      "description": "PsExec tool from Sysinternals must exist in the ExternalPayloads directory\n",
      "type": "execute-command",
      "data": {
        "command": "New-Item -Type Directory \"PathToAtomicsFolder\\..\\ExternalPayloads\\\" -ErrorAction Ignore -Force | Out-Null\nInvoke-WebRequest \"https://download.sysinternals.com/files/PSTools.zip\" -OutFile \"PathToAtomicsFolder\\..\\ExternalPayloads\\PsTools.zip\"\nExpand-Archive \"PathToAtomicsFolder\\..\\ExternalPayloads\\PsTools.zip\" \"PathToAtomicsFolder\\..\\ExternalPayloads\\PsTools\" -Force\nCopy-Item \"PathToAtomicsFolder\\..\\ExternalPayloads\\PsTools\\PsExec.exe\" \"PathToAtomicsFolder\\..\\ExternalPayloads\\PsExec.exe\" -Force\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "1f043552-0b46-41ae-bb36-c1f51eba7f73",
      "name": "Re-check dependency 1/1",
      "description": "PsExec tool from Sysinternals must exist in the ExternalPayloads directory\n",
      "type": "execute-command",
      "data": {
        "command": "if (Test-Path \"PathToAtomicsFolder\\..\\ExternalPayloads\\PsExec.exe\") { exit 0} else { exit 1}\n",
        "command_type": ""
      },
      "elevation_required": false
    }
  ],
  "flows": [
    {
      "s": "045291d0-9e0f-4fba-9ef3-494a792a9500",
      "p": "on-success",
      "o": "33455d91-a00c-4e52-a288-20d38c06341d"
    },
    {
      "s": "045291d0-9e0f-4fba-9ef3-494a792a9500",
      "p": "on-failure",
      "o": "dd0504d8-d8ff-47e0-86d9-71ebdeb704de"
    },
    {
      "s": "dd0504d8-d8ff-47e0-86d9-71ebdeb704de",
      "p": "on-success",
      "o": "1f043552-0b46-41ae-bb36-c1f51eba7f73"
    },
    {
      "s": "1f043552-0b46-41ae-bb36-c1f51eba7f73",
      "p": "on-failure",
      "o": "33455d91-a00c-4e52-a288-20d38c06341d"
    }
  ],
  "tags": [
    "T1569.002",
    "atomic-red-team"
  ],
  "input_arguments": [
    {
      "name": "remote_host",
      "type": "string",
      "description": "Remote hostname or IP address",
      "value": "localhost"
    },
    {
      "name": "user_name",
      "type": "string",
      "description": "Username",
      "value": "DOMAIN\\Administrator"
    },
    {
      "name": "password",
      "type": "string",
      "description": "Password",
      "value": "P@ssw0rd1"
    }
  ]
}