{
  "id": "811b3e76-c41b-430c-ac0d-e2380bfaa164",
  "name": "Unload Sysmon Filter Driver",
  "description": "Unloads the Sysinternals Sysmon filter driver without stopping the Sysmon service. To verify successful execution, o verify successful execution,\nrun the prereq_command's and it should fail with an error of \"sysmon filter must be loaded\".\n",
  "platforms": [
    "windows"
  ],
  "steps": [
    {
      "id": "e00bc576-5048-4d8d-86f5-45875682f59e",
      "type": "execute-command",
      "data": {
        "command": "fltmc.exe unload #{sysmon_driver}\n",
        "command_type": "command_prompt"
      },
      "elevation_required": false
    },
    {
      "id": "ad12493c-ac9d-4f69-bc76-b5d4a688a44c",
      "type": "execute-command",
      "data": {
        "command": "sysmon -u -i \u003e nul 2\u003e\u00261\nsysmon -i -accepteula -i \u003e nul 2\u003e\u00261\n\"PathToAtomicsFolder\\..\\ExternalPayloads\\Sysmon\\Sysmon.exe\" -u \u003e nul 2\u003e\u00261\n\"PathToAtomicsFolder\\..\\ExternalPayloads\\Sysmon\\Sysmon.exe\" -accepteula -i \u003e nul 2\u003e\u00261\n",
        "command_type": "command_prompt"
      },
      "elevation_required": false
    },
    {
      "id": "e338d8a5-de6f-45ea-a7a5-50024e6cfe60",
      "name": "Check dependency 1/3",
      "description": "Sysmon must be downloaded\n",
      "type": "execute-command",
      "data": {
        "command": "if (-not (cmd.exe /c \"where.exe Sysmon.exe 2\u003e nul | findstr Sysmon 2\u003e nul\") -or (Test-Path \"PathToAtomicsFolder\\..\\ExternalPayloads\\Sysmon\\Sysmon.exe\")) { exit 0 } else { exit 1 }\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "daf58b26-a2ff-4c12-b770-93d49c507a3f",
      "name": "Resolve dependency 1/3",
      "description": "Sysmon must be downloaded\n",
      "type": "execute-command",
      "data": {
        "command": "New-Item -Type Directory \"PathToAtomicsFolder\\..\\ExternalPayloads\\\" -ErrorAction Ignore -Force | Out-Null\nInvoke-WebRequest \"https://download.sysinternals.com/files/Sysmon.zip\" -OutFile \"PathToAtomicsFolder\\..\\ExternalPayloads\\Sysmon.zip\"\nExpand-Archive \"PathToAtomicsFolder\\..\\ExternalPayloads\\Sysmon.zip\" \"PathToAtomicsFolder\\..\\ExternalPayloads\\Sysmon\" -Force\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "89ddf750-85bb-411b-be77-bf980f3e0c41",
      "name": "Re-check dependency 1/3",
      "description": "Sysmon must be downloaded\n",
      "type": "execute-command",
      "data": {
        "command": "if (-not (cmd.exe /c \"where.exe Sysmon.exe 2\u003e nul | findstr Sysmon 2\u003e nul\") -or (Test-Path \"PathToAtomicsFolder\\..\\ExternalPayloads\\Sysmon\\Sysmon.exe\")) { exit 0 } else { exit 1 }\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "7a9a61fe-7e01-49e4-9f23-6f8e31c8c56f",
      "name": "Check dependency 2/3",
      "description": "sysmon must be Installed\n",
      "type": "execute-command",
      "data": {
        "command": "if(sc.exe query sysmon | findstr sysmon) { exit 0 } else { exit 1 }\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "c1e2ea91-30b3-49e0-b745-5d32acfe1f3a",
      "name": "Resolve dependency 2/3",
      "description": "sysmon must be Installed\n",
      "type": "execute-command",
      "data": {
        "command": "if(cmd.exe /c \"where.exe Sysmon.exe 2\u003e nul | findstr Sysmon 2\u003e nul\") { C:\\Windows\\Sysmon.exe -accepteula -i } else\n{ \u0026 \"PathToAtomicsFolder\\..\\ExternalPayloads\\Sysmon\\Sysmon.exe\" -accepteula -i}\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "0bbbe4e8-ac13-4d5f-b3b0-2256f0b71716",
      "name": "Re-check dependency 2/3",
      "description": "sysmon must be Installed\n",
      "type": "execute-command",
      "data": {
        "command": "if(sc.exe query sysmon | findstr sysmon) { exit 0 } else { exit 1 }\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "01287a79-8085-49c4-aa72-e39874985cc3",
      "name": "Check dependency 3/3",
      "description": "sysmon filter must be loaded\n",
      "type": "execute-command",
      "data": {
        "command": "if(fltmc.exe filters | findstr #{sysmon_driver}) { exit 0 } else { exit 1 }\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "3437d7a7-9281-4d81-992a-d2cc83b1edd9",
      "name": "Resolve dependency 3/3",
      "description": "sysmon filter must be loaded\n",
      "type": "execute-command",
      "data": {
        "command": "if(Test-Path \"PathToAtomicsFolder\\..\\ExternalPayloads\\Sysmon\\Sysmon.exe\"){\n  \u0026 \"PathToAtomicsFolder\\..\\ExternalPayloads\\Sysmon\\Sysmon.exe\" -u\n  \u0026 \"PathToAtomicsFolder\\..\\ExternalPayloads\\Sysmon\\Sysmon.exe\" -accepteula -i\n}else{\n  sysmon -u\n  sysmon -accepteula -i\n}\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "2487826b-5185-40dc-8ef9-b2e86992fb93",
      "name": "Re-check dependency 3/3",
      "description": "sysmon filter must be loaded\n",
      "type": "execute-command",
      "data": {
        "command": "if(fltmc.exe filters | findstr #{sysmon_driver}) { exit 0 } else { exit 1 }\n",
        "command_type": ""
      },
      "elevation_required": false
    }
  ],
  "flows": [
    {
      "s": "e00bc576-5048-4d8d-86f5-45875682f59e",
      "p": "on-success",
      "o": "ad12493c-ac9d-4f69-bc76-b5d4a688a44c"
    },
    {
      "s": "e00bc576-5048-4d8d-86f5-45875682f59e",
      "p": "on-failure",
      "o": "ad12493c-ac9d-4f69-bc76-b5d4a688a44c"
    },
    {
      "s": "e338d8a5-de6f-45ea-a7a5-50024e6cfe60",
      "p": "on-success",
      "o": "e00bc576-5048-4d8d-86f5-45875682f59e"
    },
    {
      "s": "e338d8a5-de6f-45ea-a7a5-50024e6cfe60",
      "p": "on-failure",
      "o": "daf58b26-a2ff-4c12-b770-93d49c507a3f"
    },
    {
      "s": "daf58b26-a2ff-4c12-b770-93d49c507a3f",
      "p": "on-success",
      "o": "89ddf750-85bb-411b-be77-bf980f3e0c41"
    },
    {
      "s": "89ddf750-85bb-411b-be77-bf980f3e0c41",
      "p": "on-failure",
      "o": "e00bc576-5048-4d8d-86f5-45875682f59e"
    },
    {
      "s": "7a9a61fe-7e01-49e4-9f23-6f8e31c8c56f",
      "p": "on-success",
      "o": "e00bc576-5048-4d8d-86f5-45875682f59e"
    },
    {
      "s": "7a9a61fe-7e01-49e4-9f23-6f8e31c8c56f",
      "p": "on-failure",
      "o": "c1e2ea91-30b3-49e0-b745-5d32acfe1f3a"
    },
    {
      "s": "c1e2ea91-30b3-49e0-b745-5d32acfe1f3a",
      "p": "on-success",
      "o": "0bbbe4e8-ac13-4d5f-b3b0-2256f0b71716"
    },
    {
      "s": "0bbbe4e8-ac13-4d5f-b3b0-2256f0b71716",
      "p": "on-failure",
      "o": "e00bc576-5048-4d8d-86f5-45875682f59e"
    },
    {
      "s": "01287a79-8085-49c4-aa72-e39874985cc3",
      "p": "on-success",
      "o": "e00bc576-5048-4d8d-86f5-45875682f59e"
    },
    {
      "s": "01287a79-8085-49c4-aa72-e39874985cc3",
      "p": "on-failure",
      "o": "3437d7a7-9281-4d81-992a-d2cc83b1edd9"
    },
    {
      "s": "3437d7a7-9281-4d81-992a-d2cc83b1edd9",
      "p": "on-success",
      "o": "2487826b-5185-40dc-8ef9-b2e86992fb93"
    },
    {
      "s": "2487826b-5185-40dc-8ef9-b2e86992fb93",
      "p": "on-failure",
      "o": "e00bc576-5048-4d8d-86f5-45875682f59e"
    }
  ],
  "tags": [
    "T1562.001",
    "atomic-red-team"
  ],
  "input_arguments": [
    {
      "name": "sysmon_driver",
      "type": "string",
      "description": "The name of the Sysmon filter driver (this can change from the default)",
      "value": "SysmonDrv"
    }
  ]
}