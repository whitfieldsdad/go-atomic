{
  "id": "987c9b4d-a637-42db-b1cb-e9e242c3991b",
  "name": "ESXi - Terminates VMs using pkill",
  "description": "In VMWARE ESXi, process names starting with vmx are associated with running VMs. An adversary can use the pkill command to kill all processes with a prefix vmx.\n[Reference](https://www.crowdstrike.com/blog/hypervisor-jackpotting-ecrime-actors-increase-targeting-of-esxi-servers/)\n",
  "platforms": [
    "linux"
  ],
  "steps": [
    {
      "id": "3979d254-22c2-4685-b41a-dbac8f6b7d56",
      "type": "execute-command",
      "data": {
        "command": "echo \"\" | \"#{plink_file}\" \"#{vm_host}\" -ssh  -l \"#{vm_user}\" -pw \"#{vm_pass}\" -m \"#{cli_script}\"\n",
        "command_type": "command_prompt"
      },
      "elevation_required": false
    },
    {
      "id": "0f371977-20cc-464a-9164-337c76f14f9c",
      "name": "Check dependency 1/1",
      "description": "Check if plink is available.\n",
      "type": "execute-command",
      "data": {
        "command": "if (Test-Path \"#{plink_file}\") {exit 0} else {exit 1}\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "d448a608-523c-4815-a3c3-bce7d31e0491",
      "name": "Resolve dependency 1/1",
      "description": "Check if plink is available.\n",
      "type": "execute-command",
      "data": {
        "command": "New-Item -Type Directory \"PathToAtomicsFolder\\..\\ExternalPayloads\\\" -ErrorAction Ignore -Force | Out-Null\nInvoke-WebRequest \"https://the.earth.li/~sgtatham/putty/latest/w64/plink.exe\" -OutFile \"#{plink_file}\"\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "96ca699c-8f5b-46d5-b4e2-71b76a9d6608",
      "name": "Re-check dependency 1/1",
      "description": "Check if plink is available.\n",
      "type": "execute-command",
      "data": {
        "command": "if (Test-Path \"#{plink_file}\") {exit 0} else {exit 1}\n",
        "command_type": ""
      },
      "elevation_required": false
    }
  ],
  "flows": [
    {
      "s": "0f371977-20cc-464a-9164-337c76f14f9c",
      "p": "on-success",
      "o": "3979d254-22c2-4685-b41a-dbac8f6b7d56"
    },
    {
      "s": "0f371977-20cc-464a-9164-337c76f14f9c",
      "p": "on-failure",
      "o": "d448a608-523c-4815-a3c3-bce7d31e0491"
    },
    {
      "s": "d448a608-523c-4815-a3c3-bce7d31e0491",
      "p": "on-success",
      "o": "96ca699c-8f5b-46d5-b4e2-71b76a9d6608"
    },
    {
      "s": "96ca699c-8f5b-46d5-b4e2-71b76a9d6608",
      "p": "on-failure",
      "o": "3979d254-22c2-4685-b41a-dbac8f6b7d56"
    }
  ],
  "tags": [
    "T1529",
    "atomic-red-team"
  ],
  "input_arguments": [
    {
      "name": "plink_file",
      "type": "path",
      "description": "Path to plink",
      "value": "PathToAtomicsFolder\\..\\ExternalPayloads\\plink.exe"
    },
    {
      "name": "cli_script",
      "type": "path",
      "description": "Path to text with commands",
      "value": "PathToAtomicsFolder\\T1529\\src\\esx_pkill.txt"
    },
    {
      "name": "vm_host",
      "type": "string",
      "description": "Specify the host name of the ESXi Server",
      "value": "atomic.local"
    },
    {
      "name": "vm_user",
      "type": "string",
      "description": "Specify the privilege user account on ESXi Server",
      "value": "root"
    },
    {
      "name": "vm_pass",
      "type": "string",
      "description": "Specify the privilege user password on ESXi Server",
      "value": "pass"
    }
  ]
}