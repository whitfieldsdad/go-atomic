{
  "id": "29786d7e-8916-4de6-9c55-be7b093b2706",
  "name": "Windows MOFComp.exe Load MOF File",
  "description": "The following Atomic will utilize MOFComp.exe to load a local MOF file.\nThe Managed Object Format (MOF) compiler parses a file containing MOF statements and adds the classes and class instances defined in the file to the WMI repository. \nTo query for the class:  gwmi __eventfilter -namespace root\\subscription\nA successful execution will add the class to WMI root namespace.\nReference: https://pentestlab.blog/2020/01/21/persistence-wmi-event-subscription/ and https://thedfirreport.com/2022/07/11/select-xmrig-from-sqlserver/.\n",
  "platforms": [
    "windows"
  ],
  "steps": [
    {
      "id": "30e2771e-2f89-4625-9c17-76935876a889",
      "type": "execute-command",
      "data": {
        "command": "#{mofcomp_path} \"#{mof_file}\"\n",
        "command_type": "powershell"
      },
      "elevation_required": false
    },
    {
      "id": "cea3315c-bf2a-4c9d-b3b7-e54c82753a1b",
      "type": "execute-command",
      "data": {
        "command": "$EventConsumerToCleanup = Get-WmiObject -Namespace root/subscription -Class CommandLineEventConsumer -Filter \"Name = 'AtomicRedTeam_consumer'\"\n$EventFilterToCleanup = Get-WmiObject -Namespace root/subscription -Class __EventFilter -Filter \"Name = 'AtomicRedTeam_filter'\"\n$FilterConsumerBindingToCleanup = Get-WmiObject -Namespace root/subscription -Query \"REFERENCES OF {$($EventConsumerToCleanup.__RELPATH)} WHERE ResultClass = __FilterToConsumerBinding\" -ErrorAction SilentlyContinue\n$FilterConsumerBindingToCleanup | Remove-WmiObject\n$EventConsumerToCleanup | Remove-WmiObject\n$EventFilterToCleanup | Remove-WmiObject\n",
        "command_type": "powershell"
      },
      "elevation_required": false
    },
    {
      "id": "e27c7d86-78b5-4d4c-a7db-156b4c8b6b45",
      "name": "Check dependency 1/2",
      "description": "MofComp.exe must exist on disk at specified location (#{mofcomp_path})\n",
      "type": "execute-command",
      "data": {
        "command": "if (Test-Path \"#{mofcomp_path}\") { exit 0} else { exit 1}\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "c5300963-3641-466a-aa4a-f4dc5324de88",
      "name": "Resolve dependency 1/2",
      "description": "MofComp.exe must exist on disk at specified location (#{mofcomp_path})\n",
      "type": "execute-command",
      "data": {
        "command": "Validate MOFComp.exe is on disk somewhere and update input argument.\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "e3b33d5f-4985-48c3-96ec-c589a6ec54aa",
      "name": "Re-check dependency 1/2",
      "description": "MofComp.exe must exist on disk at specified location (#{mofcomp_path})\n",
      "type": "execute-command",
      "data": {
        "command": "if (Test-Path \"#{mofcomp_path}\") { exit 0} else { exit 1}\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "58a5a4ee-1dc5-4c17-9f27-deca381995d4",
      "name": "Check dependency 2/2",
      "description": "MofComp.exe must exist on disk at specified location (#{mof_file})\n",
      "type": "execute-command",
      "data": {
        "command": "if (Test-Path \"#{mof_file}\") { exit 0} else { exit 1}\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "e9a1dfc0-7e1a-443a-bb08-6312cdc3712e",
      "name": "Resolve dependency 2/2",
      "description": "MofComp.exe must exist on disk at specified location (#{mof_file})\n",
      "type": "execute-command",
      "data": {
        "command": "New-Item -Type Directory (split-path \"#{mof_file}\") -ErrorAction ignore | Out-Null\nInvoke-WebRequest \"https://github.com/redcanaryco/atomic-red-team/raw/master/atomics/T1546.003/src/T1546.003.mof\" -OutFile \"#{mof_file}\"\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "a7213b7a-6cf5-41ab-960e-f5d001899901",
      "name": "Re-check dependency 2/2",
      "description": "MofComp.exe must exist on disk at specified location (#{mof_file})\n",
      "type": "execute-command",
      "data": {
        "command": "if (Test-Path \"#{mof_file}\") { exit 0} else { exit 1}\n",
        "command_type": ""
      },
      "elevation_required": false
    }
  ],
  "flows": [
    {
      "s": "30e2771e-2f89-4625-9c17-76935876a889",
      "p": "on-success",
      "o": "cea3315c-bf2a-4c9d-b3b7-e54c82753a1b"
    },
    {
      "s": "30e2771e-2f89-4625-9c17-76935876a889",
      "p": "on-failure",
      "o": "cea3315c-bf2a-4c9d-b3b7-e54c82753a1b"
    },
    {
      "s": "e27c7d86-78b5-4d4c-a7db-156b4c8b6b45",
      "p": "on-success",
      "o": "30e2771e-2f89-4625-9c17-76935876a889"
    },
    {
      "s": "e27c7d86-78b5-4d4c-a7db-156b4c8b6b45",
      "p": "on-failure",
      "o": "c5300963-3641-466a-aa4a-f4dc5324de88"
    },
    {
      "s": "c5300963-3641-466a-aa4a-f4dc5324de88",
      "p": "on-success",
      "o": "e3b33d5f-4985-48c3-96ec-c589a6ec54aa"
    },
    {
      "s": "e3b33d5f-4985-48c3-96ec-c589a6ec54aa",
      "p": "on-failure",
      "o": "30e2771e-2f89-4625-9c17-76935876a889"
    },
    {
      "s": "58a5a4ee-1dc5-4c17-9f27-deca381995d4",
      "p": "on-success",
      "o": "30e2771e-2f89-4625-9c17-76935876a889"
    },
    {
      "s": "58a5a4ee-1dc5-4c17-9f27-deca381995d4",
      "p": "on-failure",
      "o": "e9a1dfc0-7e1a-443a-bb08-6312cdc3712e"
    },
    {
      "s": "e9a1dfc0-7e1a-443a-bb08-6312cdc3712e",
      "p": "on-success",
      "o": "a7213b7a-6cf5-41ab-960e-f5d001899901"
    },
    {
      "s": "a7213b7a-6cf5-41ab-960e-f5d001899901",
      "p": "on-failure",
      "o": "30e2771e-2f89-4625-9c17-76935876a889"
    }
  ],
  "tags": [
    "T1546.003",
    "atomic-red-team"
  ],
  "input_arguments": [
    {
      "name": "mofcomp_path",
      "type": "string",
      "description": "Location of mofcomp.exe",
      "value": "c:\\windows\\system32\\wbem\\mofcomp.exe"
    },
    {
      "name": "mof_file",
      "type": "string",
      "description": "Local location MOF file",
      "value": "PathToAtomicsFolder\\T1546.003\\src\\T1546.003.mof"
    }
  ]
}