{
  "id": "92c40b3f-c406-4d1f-8d2b-c039bf5009e4",
  "name": "Azure AD - adding service principal to Azure AD role",
  "description": "The adversaries want to add service principal to some Azure AD role. Threat actor \nmay be interested primarily in highly privileged roles, e.g. Global Administrator, Application Administrator, \nPrivileged Authentication Administrator (this role can reset Global Administrator password!).\nBy default, the role Global Reader is assigned to service principal in this test.\n\nThe account you use to run the PowerShell command should have Privileged Role Administrator or Global Administrator role in your Azure AD.\n\nDetection hint - check Activity \"Add member to role\" in Azure AD Audit Logs. In targer you will also see Service Principal as a type.\n",
  "platforms": [
    "azure-ad"
  ],
  "steps": [
    {
      "id": "27286f73-0eb2-4d77-b418-acdfa9a760e1",
      "type": "execute-command",
      "data": {
        "command": "Import-Module -Name AzureAD\n$PWord = ConvertTo-SecureString -String \"#{password}\" -AsPlainText -Force\n$Credential = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList \"#{username}\", $Pword\nConnect-AzureAD -Credential $Credential\n\n$sp = Get-AzureADServicePrincipal -Filter \"DisplayName eq '#{service_principal_name}'\"\nif ($sp -eq $null) { Write-Warning \"Service Principal not found\"; exit }\n$role = Get-AzureADDirectoryRole -Filter \"DisplayName eq '#{role_name}'\"\nif ($role -eq $null) { Write-Warning \"Role not found\"; exit }\nAdd-AzureADDirectoryRoleMember -ObjectId $role.ObjectId -RefObjectId $sp.ObjectId\nWrite-Host \"Service Principal $($sp.DisplayName) was added to $($role.DisplayName)\"\n",
        "command_type": "powershell"
      },
      "elevation_required": false
    },
    {
      "id": "51d80d0e-1396-4f9f-b277-ba2eaf4581f0",
      "type": "execute-command",
      "data": {
        "command": "Import-Module -Name AzureAD -ErrorAction Ignore\n$PWord = ConvertTo-SecureString -String \"#{password}\" -AsPlainText -Force\n$Credential = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList \"#{username}\", $Pword\nConnect-AzureAD -Credential $Credential -ErrorAction Ignore\n\n$sp = Get-AzureADServicePrincipal -Filter \"DisplayName eq '#{service_principal_name}'\"\nif ($sp -eq $null) { Write-Warning \"Service Principal not found\"; exit }\n$role = Get-AzureADDirectoryRole -Filter \"DisplayName eq '#{role_name}'\"\nif ($role -eq $null) { Write-Warning \"Role not found\"; exit }\n\nRemove-AzureADDirectoryRoleMember -ObjectId $role.ObjectId -MemberId $sp.ObjectId\nWrite-Host \"Service Principal $($sp.DisplayName) was removed from $($role.DisplayName) role\"\n",
        "command_type": "powershell"
      },
      "elevation_required": false
    },
    {
      "id": "778b13b4-7ce7-4aac-8966-94bf71d3e6b6",
      "name": "Check dependency 1/1",
      "description": "AzureAD module must be installed.\n",
      "type": "execute-command",
      "data": {
        "command": "try {if (Get-InstalledModule -Name AzureAD -ErrorAction SilentlyContinue) {exit 0} else {exit 1}} catch {exit 1}\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "6091770e-e4ad-4138-9d6d-19eebbd678c9",
      "name": "Resolve dependency 1/1",
      "description": "AzureAD module must be installed.\n",
      "type": "execute-command",
      "data": {
        "command": "Install-Module -Name AzureAD -Force\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "34a34b1a-2761-4011-b4e4-3588627de13a",
      "name": "Re-check dependency 1/1",
      "description": "AzureAD module must be installed.\n",
      "type": "execute-command",
      "data": {
        "command": "try {if (Get-InstalledModule -Name AzureAD -ErrorAction SilentlyContinue) {exit 0} else {exit 1}} catch {exit 1}\n",
        "command_type": ""
      },
      "elevation_required": false
    }
  ],
  "flows": [
    {
      "s": "27286f73-0eb2-4d77-b418-acdfa9a760e1",
      "p": "on-success",
      "o": "51d80d0e-1396-4f9f-b277-ba2eaf4581f0"
    },
    {
      "s": "27286f73-0eb2-4d77-b418-acdfa9a760e1",
      "p": "on-failure",
      "o": "51d80d0e-1396-4f9f-b277-ba2eaf4581f0"
    },
    {
      "s": "778b13b4-7ce7-4aac-8966-94bf71d3e6b6",
      "p": "on-success",
      "o": "27286f73-0eb2-4d77-b418-acdfa9a760e1"
    },
    {
      "s": "778b13b4-7ce7-4aac-8966-94bf71d3e6b6",
      "p": "on-failure",
      "o": "6091770e-e4ad-4138-9d6d-19eebbd678c9"
    },
    {
      "s": "6091770e-e4ad-4138-9d6d-19eebbd678c9",
      "p": "on-success",
      "o": "34a34b1a-2761-4011-b4e4-3588627de13a"
    },
    {
      "s": "34a34b1a-2761-4011-b4e4-3588627de13a",
      "p": "on-failure",
      "o": "27286f73-0eb2-4d77-b418-acdfa9a760e1"
    }
  ],
  "tags": [
    "T1098"
  ],
  "input_arguments": [
    {
      "name": "role_name",
      "type": "string",
      "description": "Name of the targeted Azure AD role",
      "value": "Global Reader"
    },
    {
      "name": "username",
      "type": "string",
      "description": "Azure AD username",
      "value": "jonh@contoso.com"
    },
    {
      "name": "password",
      "type": "string",
      "description": "Azure AD password",
      "value": "p4sswd"
    },
    {
      "name": "service_principal_name",
      "type": "string",
      "description": "Name of the service principal",
      "value": "SuperSP"
    }
  ]
}