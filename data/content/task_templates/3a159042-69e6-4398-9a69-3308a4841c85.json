{
  "id": "3a159042-69e6-4398-9a69-3308a4841c85",
  "name": "GCP - Create Custom IAM Role",
  "description": "This atomic will create a new IAM role. The default role permissions are: *IAM Service Account Get*. The idea for this Atomic came from a Rule published by the Elastic team.\n\nIdentifies an Identity and Access Management (IAM) custom role creation in Google Cloud Platform (GCP). \nCustom roles are user-defined, and allow for the bundling of one or more supported permissions to meet specific needs. \nCustom roles will not be updated automatically and could lead to privilege creep if not carefully scrutinized.\n\nThis atomic will create a new IAM role. The default role permissions are: *IAM Service Account Get*\n\nReference: https://github.com/elastic/detection-rules/blob/main/rules/integrations/gcp/initial_access_gcp_iam_custom_role_creation.toml\n",
  "platforms": [
    "iaas:gcp"
  ],
  "steps": [
    {
      "id": "e0c6ef51-b07b-4c1c-8267-bfeaebe705a6",
      "type": "execute-command",
      "data": {
        "command": "gcloud config set project #{project-id}\ngcloud iam roles create #{role-name} --description=\"#{role-description}\" --permissions=#{roles} --project=#{project-id}",
        "command_type": "sh"
      },
      "elevation_required": false
    },
    {
      "id": "726ba972-4dd9-477a-99fa-8d1dbac29d6f",
      "type": "execute-command",
      "data": {
        "command": "gcloud iam roles delete #{role-name} --project=#{project-id}",
        "command_type": "sh"
      },
      "elevation_required": false
    },
    {
      "id": "2141800f-fc68-4ec1-90f8-418123d0bb93",
      "name": "Check dependency 1/2",
      "description": "Requires gcloud\n",
      "type": "execute-command",
      "data": {
        "command": "if [ -x \"$(command -v gcloud)\" ]; then exit 0; else exit 1; fi;",
        "command_type": "sh"
      },
      "elevation_required": false
    },
    {
      "id": "d7d37307-4295-4142-82d7-a4a7ab20016b",
      "name": "Resolve dependency 1/2",
      "description": "Requires gcloud\n",
      "type": "execute-command",
      "data": {
        "command": "echo \"Please Install Google Cloud SDK before running this atomic test : https://cloud.google.com/sdk/docs/install\"",
        "command_type": "sh"
      },
      "elevation_required": false
    },
    {
      "id": "e85c74dc-0cfb-4498-bdc7-1da2e9239086",
      "name": "Re-check dependency 1/2",
      "description": "Requires gcloud\n",
      "type": "execute-command",
      "data": {
        "command": "if [ -x \"$(command -v gcloud)\" ]; then exit 0; else exit 1; fi;",
        "command_type": "sh"
      },
      "elevation_required": false
    },
    {
      "id": "ff68562c-6dc6-492f-9d3c-fcb27d53f2a8",
      "name": "Check dependency 2/2",
      "description": "Check if user is logged in \n",
      "type": "execute-command",
      "data": {
        "command": "gcloud config get-value account",
        "command_type": "sh"
      },
      "elevation_required": false
    },
    {
      "id": "46f15c9a-bf07-4b06-9464-498d87106611",
      "name": "Resolve dependency 2/2",
      "description": "Check if user is logged in \n",
      "type": "execute-command",
      "data": {
        "command": "gcloud auth login --no-launch-browser",
        "command_type": "sh"
      },
      "elevation_required": false
    },
    {
      "id": "596c2286-8d1f-4a7c-8e0a-c2199fb6b998",
      "name": "Re-check dependency 2/2",
      "description": "Check if user is logged in \n",
      "type": "execute-command",
      "data": {
        "command": "gcloud config get-value account",
        "command_type": "sh"
      },
      "elevation_required": false
    }
  ],
  "flows": [
    {
      "s": "e0c6ef51-b07b-4c1c-8267-bfeaebe705a6",
      "p": "on-success",
      "o": "726ba972-4dd9-477a-99fa-8d1dbac29d6f"
    },
    {
      "s": "e0c6ef51-b07b-4c1c-8267-bfeaebe705a6",
      "p": "on-failure",
      "o": "726ba972-4dd9-477a-99fa-8d1dbac29d6f"
    },
    {
      "s": "2141800f-fc68-4ec1-90f8-418123d0bb93",
      "p": "on-success",
      "o": "e0c6ef51-b07b-4c1c-8267-bfeaebe705a6"
    },
    {
      "s": "2141800f-fc68-4ec1-90f8-418123d0bb93",
      "p": "on-failure",
      "o": "d7d37307-4295-4142-82d7-a4a7ab20016b"
    },
    {
      "s": "d7d37307-4295-4142-82d7-a4a7ab20016b",
      "p": "on-success",
      "o": "e85c74dc-0cfb-4498-bdc7-1da2e9239086"
    },
    {
      "s": "e85c74dc-0cfb-4498-bdc7-1da2e9239086",
      "p": "on-failure",
      "o": "e0c6ef51-b07b-4c1c-8267-bfeaebe705a6"
    },
    {
      "s": "ff68562c-6dc6-492f-9d3c-fcb27d53f2a8",
      "p": "on-success",
      "o": "e0c6ef51-b07b-4c1c-8267-bfeaebe705a6"
    },
    {
      "s": "ff68562c-6dc6-492f-9d3c-fcb27d53f2a8",
      "p": "on-failure",
      "o": "46f15c9a-bf07-4b06-9464-498d87106611"
    },
    {
      "s": "46f15c9a-bf07-4b06-9464-498d87106611",
      "p": "on-success",
      "o": "596c2286-8d1f-4a7c-8e0a-c2199fb6b998"
    },
    {
      "s": "596c2286-8d1f-4a7c-8e0a-c2199fb6b998",
      "p": "on-failure",
      "o": "e0c6ef51-b07b-4c1c-8267-bfeaebe705a6"
    }
  ],
  "tags": [
    "T1078",
    "T1078.004"
  ],
  "input_arguments": [
    {
      "name": "role-description",
      "type": "string",
      "description": "The description of the role to be created.",
      "value": "Atomic Red Team Custom IAM Role"
    },
    {
      "name": "roles",
      "type": "string",
      "description": "List of roles to be applied",
      "value": "iam.serviceAccounts.get"
    },
    {
      "name": "project-id",
      "type": "string",
      "description": "ID of the GCP Project you to execute the command against.",
      "value": "atomic-test-1"
    },
    {
      "name": "role-name",
      "type": "string",
      "description": "The name of the role to be created.",
      "value": "AtomicRedTeamRole"
    }
  ]
}