{
  "id": "e03ada14-0980-4107-aff1-7783b2b59bb1",
  "name": "SharpHound3 - LocalAdmin",
  "description": "This module runs the Windows executable of SharpHound in order to remotely list members of the local Administrators group (SAMR)\n",
  "platforms": [
    "windows"
  ],
  "steps": [
    {
      "id": "08083c77-0892-4705-9ce0-5d3c6b2885f6",
      "type": "execute-command",
      "data": {
        "command": "New-Item -Path \"#{output_path}\" -ItemType Directory \u003e $null\n\u0026 \"#{sharphound_path}\" -d \"#{domain}\" --CollectionMethod LocalAdmin --NoSaveCache --OutputDirectory \"#{output_path}\"\n",
        "command_type": "powershell"
      },
      "elevation_required": false
    },
    {
      "id": "4de20b9b-4013-4946-85df-13da79b93ac7",
      "type": "execute-command",
      "data": {
        "command": "Remove-Item -Recurse #{output_path} -ErrorAction Ignore\n",
        "command_type": "powershell"
      },
      "elevation_required": false
    },
    {
      "id": "8d85c4d9-5971-44e5-b15e-f6b43b396fd2",
      "name": "Check dependency 1/1",
      "description": "SharpHound binary must exist on disk and at specified location (#{sharphound_path}).\nAnd the computer must be domain joined (implicit authentication).\n",
      "type": "execute-command",
      "data": {
        "command": "if (Test-Path \"#{sharphound_path}\") { exit 0 } else { exit 1 }\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "777a34a7-eb6f-4dbd-ade8-968b8bbbeb76",
      "name": "Resolve dependency 1/1",
      "description": "SharpHound binary must exist on disk and at specified location (#{sharphound_path}).\nAnd the computer must be domain joined (implicit authentication).\n",
      "type": "execute-command",
      "data": {
        "command": "New-Item -Type Directory \"PathToAtomicsFolder\\..\\ExternalPayloads\\\" -ErrorAction Ignore -Force | Out-Null\nInvoke-WebRequest \"https://github.com/BloodHoundAD/BloodHound/blob/e062fe73d73c015dccb37fae5089342d009b84b8/Collectors/SharpHound.exe?raw=true\" -OutFile \"#{sharphound_path}\"\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "4a63d7c8-0ae4-4703-bedf-e3b7f50ddd52",
      "name": "Re-check dependency 1/1",
      "description": "SharpHound binary must exist on disk and at specified location (#{sharphound_path}).\nAnd the computer must be domain joined (implicit authentication).\n",
      "type": "execute-command",
      "data": {
        "command": "if (Test-Path \"#{sharphound_path}\") { exit 0 } else { exit 1 }\n",
        "command_type": ""
      },
      "elevation_required": false
    }
  ],
  "flows": [
    {
      "s": "08083c77-0892-4705-9ce0-5d3c6b2885f6",
      "p": "on-success",
      "o": "4de20b9b-4013-4946-85df-13da79b93ac7"
    },
    {
      "s": "08083c77-0892-4705-9ce0-5d3c6b2885f6",
      "p": "on-failure",
      "o": "4de20b9b-4013-4946-85df-13da79b93ac7"
    },
    {
      "s": "8d85c4d9-5971-44e5-b15e-f6b43b396fd2",
      "p": "on-success",
      "o": "08083c77-0892-4705-9ce0-5d3c6b2885f6"
    },
    {
      "s": "8d85c4d9-5971-44e5-b15e-f6b43b396fd2",
      "p": "on-failure",
      "o": "777a34a7-eb6f-4dbd-ade8-968b8bbbeb76"
    },
    {
      "s": "777a34a7-eb6f-4dbd-ade8-968b8bbbeb76",
      "p": "on-success",
      "o": "4a63d7c8-0ae4-4703-bedf-e3b7f50ddd52"
    },
    {
      "s": "4a63d7c8-0ae4-4703-bedf-e3b7f50ddd52",
      "p": "on-failure",
      "o": "08083c77-0892-4705-9ce0-5d3c6b2885f6"
    }
  ],
  "tags": [
    "T1069.001",
    "atomic-red-team"
  ],
  "input_arguments": [
    {
      "name": "domain",
      "type": "string",
      "description": "FQDN of the targeted domain",
      "value": "$env:UserDnsDomain"
    },
    {
      "name": "sharphound_path",
      "type": "path",
      "description": "SharpHound Windows executable",
      "value": "PathToAtomicsFolder\\..\\ExternalPayloads\\SharpHound.exe"
    },
    {
      "name": "output_path",
      "type": "path",
      "description": "Output for SharpHound",
      "value": "$env:TEMP\\SharpHound\\"
    }
  ]
}