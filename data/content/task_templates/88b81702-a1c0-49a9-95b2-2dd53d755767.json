{
  "id": "88b81702-a1c0-49a9-95b2-2dd53d755767",
  "name": "Create and start VirtualBox virtual machine",
  "description": "Create a simple VirtualBox VM and start up the machine\nCleanup command stops and deletes the newly created VM and associated files\nhttps://www.virtualbox.org/manual/ch08.html#vboxmanage-startvm\nhttps://news.sophos.com/en-us/2020/05/21/ragnar-locker-ransomware-deploys-virtual-machine-to-dodge-security/\nhttps://attack.mitre.org/techniques/T1564/006/\n",
  "platforms": [
    "windows"
  ],
  "steps": [
    {
      "id": "d8db0687-7de4-43a7-8e26-38bd6af8101d",
      "type": "execute-command",
      "data": {
        "command": "\"#{vboxmanage_exe}\" createvm --name \"#{vm_name}\" --register\n\"#{vboxmanage_exe}\" modifyvm \"#{vm_name}\" --firmware efi\n\"#{vboxmanage_exe}\" startvm \"#{vm_name}\"\n",
        "command_type": "command_prompt"
      },
      "elevation_required": false
    },
    {
      "id": "12f326a3-a725-4f65-83ad-93962e8c73bf",
      "type": "execute-command",
      "data": {
        "command": "\"#{vboxmanage_exe}\" controlvm \"#{vm_name}\" poweroff\n\"#{vboxmanage_exe}\" unregistervm \"#{vm_name}\" --delete",
        "command_type": "command_prompt"
      },
      "elevation_required": false
    },
    {
      "id": "5ed59858-38a3-49f9-a8a7-7be4ddb5248a",
      "name": "Check dependency 1/2",
      "description": "VirtualBox must exist on disk at specified locations (#{virtualbox_exe})\n",
      "type": "execute-command",
      "data": {
        "command": "if (Test-Path \"#{virtualbox_exe}\") {exit 0} else {exit 1}\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "182170b7-47c2-4304-a337-84cb4f6026c2",
      "name": "Resolve dependency 1/2",
      "description": "VirtualBox must exist on disk at specified locations (#{virtualbox_exe})\n",
      "type": "execute-command",
      "data": {
        "command": "New-Item -Type Directory \"PathToAtomicsFolder\\..\\ExternalPayloads\\\" -ErrorAction Ignore -Force | Out-Null\n$wc = New-Object System.Net.WebClient\n$wc.DownloadFile(\"#{virtualbox_download}\",\"PathToAtomicsFolder\\..\\ExternalPayloads\\#{virtualbox_installer}\")\nstart-process -FilePath \"PathToAtomicsFolder\\..\\ExternalPayloads\\#{virtualbox_installer}\" -ArgumentList \"--silent\" -Wait\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "4cada32b-7c0c-4756-bfa8-c73170fa8bcb",
      "name": "Re-check dependency 1/2",
      "description": "VirtualBox must exist on disk at specified locations (#{virtualbox_exe})\n",
      "type": "execute-command",
      "data": {
        "command": "if (Test-Path \"#{virtualbox_exe}\") {exit 0} else {exit 1}\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "eb059097-5ce0-41c4-89df-7513cadd5dc0",
      "name": "Check dependency 2/2",
      "description": "VBoxManage must exist on disk at specified locations (#{vboxmanage_exe})\n",
      "type": "execute-command",
      "data": {
        "command": "if (Test-Path \"#{vboxmanage_exe}\") {exit 0} else {exit 1}\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "9fb91aae-9281-432d-8cae-44b3b308dc24",
      "name": "Resolve dependency 2/2",
      "description": "VBoxManage must exist on disk at specified locations (#{vboxmanage_exe})\n",
      "type": "execute-command",
      "data": {
        "command": "$wc = New-Object System.Net.WebClient\n$wc.DownloadFile(\"#{virtualbox_download}\",\"PathToAtomicsFolder\\..\\ExternalPayloads\\#{virtualbox_installer}\")\nstart-process -FilePath \"PathToAtomicsFolder\\..\\ExternalPayloads\\#{virtualbox_installer}\" -ArgumentList \"--silent\" -Wait\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "3270c7a7-d2f2-4ac9-a5c3-885c44d33003",
      "name": "Re-check dependency 2/2",
      "description": "VBoxManage must exist on disk at specified locations (#{vboxmanage_exe})\n",
      "type": "execute-command",
      "data": {
        "command": "if (Test-Path \"#{vboxmanage_exe}\") {exit 0} else {exit 1}\n",
        "command_type": ""
      },
      "elevation_required": false
    }
  ],
  "flows": [
    {
      "s": "d8db0687-7de4-43a7-8e26-38bd6af8101d",
      "p": "on-success",
      "o": "12f326a3-a725-4f65-83ad-93962e8c73bf"
    },
    {
      "s": "d8db0687-7de4-43a7-8e26-38bd6af8101d",
      "p": "on-failure",
      "o": "12f326a3-a725-4f65-83ad-93962e8c73bf"
    },
    {
      "s": "5ed59858-38a3-49f9-a8a7-7be4ddb5248a",
      "p": "on-success",
      "o": "d8db0687-7de4-43a7-8e26-38bd6af8101d"
    },
    {
      "s": "5ed59858-38a3-49f9-a8a7-7be4ddb5248a",
      "p": "on-failure",
      "o": "182170b7-47c2-4304-a337-84cb4f6026c2"
    },
    {
      "s": "182170b7-47c2-4304-a337-84cb4f6026c2",
      "p": "on-success",
      "o": "4cada32b-7c0c-4756-bfa8-c73170fa8bcb"
    },
    {
      "s": "4cada32b-7c0c-4756-bfa8-c73170fa8bcb",
      "p": "on-failure",
      "o": "d8db0687-7de4-43a7-8e26-38bd6af8101d"
    },
    {
      "s": "eb059097-5ce0-41c4-89df-7513cadd5dc0",
      "p": "on-success",
      "o": "d8db0687-7de4-43a7-8e26-38bd6af8101d"
    },
    {
      "s": "eb059097-5ce0-41c4-89df-7513cadd5dc0",
      "p": "on-failure",
      "o": "9fb91aae-9281-432d-8cae-44b3b308dc24"
    },
    {
      "s": "9fb91aae-9281-432d-8cae-44b3b308dc24",
      "p": "on-success",
      "o": "3270c7a7-d2f2-4ac9-a5c3-885c44d33003"
    },
    {
      "s": "3270c7a7-d2f2-4ac9-a5c3-885c44d33003",
      "p": "on-failure",
      "o": "d8db0687-7de4-43a7-8e26-38bd6af8101d"
    }
  ],
  "tags": [
    "T1564.006",
    "atomic-red-team"
  ],
  "input_arguments": [
    {
      "name": "vm_name",
      "type": "string",
      "description": "Name of the new virtual machine",
      "value": "Atomic VM"
    },
    {
      "name": "virtualbox_exe",
      "type": "path",
      "description": "Path to the VirtualBox executable",
      "value": "C:\\Program Files\\Oracle\\VirtualBox\\VirtualBox.exe"
    },
    {
      "name": "vboxmanage_exe",
      "type": "path",
      "description": "Path to the executable for VBoxManage, the command-line interface to VirtualBox",
      "value": "C:\\Program Files\\Oracle\\VirtualBox\\VBoxManage.exe"
    },
    {
      "name": "virtualbox_download",
      "type": "url",
      "description": "URL for the current installer for the Windows version of VirtualBox, as of March 2022",
      "value": "https://download.virtualbox.org/virtualbox/6.1.32/VirtualBox-6.1.32-149290-Win.exe"
    },
    {
      "name": "virtualbox_installer",
      "type": "string",
      "description": "Executable for the Virtualbox installer",
      "value": "VirtualBox-6.1.32-149290-Win.exe"
    }
  ]
}