{
  "id": "70bd71e6-eba4-4e00-92f7-617911dbe020",
  "name": "Disable Hypervisor-Enforced Code Integrity (HVCI)",
  "description": "This test disables Hypervisor-Enforced Code Integrity (HVCI) by setting the registry key HKLM:\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\\Scenarios\\HypervisorEnforcedCodeIntegrity \"Enabled\" value to \"0\".\nThe pre-req needs to be ran in order to setup HVCI and have it enabled. \nWe do not recommend running this in production.\n[Black Lotus Campaign](https://www.microsoft.com/en-us/security/blog/2023/04/11/guidance-for-investigating-attacks-using-cve-2022-21894-the-blacklotus-campaign/)\n[Microsoft](https://learn.microsoft.com/en-us/windows/security/threat-protection/device-guard/enable-virtualization-based-protection-of-code-integrity)\n",
  "platforms": [
    "windows"
  ],
  "steps": [
    {
      "id": "c2a03e4b-ed75-4506-8e85-e08394248702",
      "type": "execute-command",
      "data": {
        "command": "reg add \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\\Scenarios\\HypervisorEnforcedCodeIntegrity\" /v \"Enabled\" /t REG_DWORD /d 0 /f",
        "command_type": "powershell"
      },
      "elevation_required": true
    },
    {
      "id": "4c0187c7-b72d-457c-881d-0b5114ad9785",
      "type": "execute-command",
      "data": {
        "command": "reg delete \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\" /v \"EnableVirtualizationBasedSecurity\" /f\nreg delete \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\" /v \"RequirePlatformSecurityFeatures\" /f\nreg delete \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\" /v \"Locked\" /f\nreg delete \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\\Scenarios\\HypervisorEnforcedCodeIntegrity\" /v \"Enabled\" /f\nreg delete \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\\Scenarios\\HypervisorEnforcedCodeIntegrity\" /v \"Locked\" /f",
        "command_type": "powershell"
      },
      "elevation_required": true
    },
    {
      "id": "4c4451fe-e0eb-45b5-b928-e6dd1799158e",
      "name": "Check dependency 1/1",
      "description": "HVCI must be enabled\n",
      "type": "execute-command",
      "data": {
        "command": "if (((cmd.exe /c \"reg query \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\" /v \"EnableVirtualizationBasedSecurity\" 2\u003e nul | findstr EnableVirtualizationBasedSecurity 2\u003e nul\") -and (cmd.exe /c \"reg query \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\" /v \"RequirePlatformSecurityFeatures\" 2\u003e nul | findstr RequirePlatformSecurityFeatures 2\u003e nul\") -and (cmd.exe /c \"reg query \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\" /v \"Locked\" 2\u003e nul | findstr Locked 2\u003e nul\") -and (cmd.exe /c \"reg query \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\\Scenarios\\HypervisorEnforcedCodeIntegrity\" /v \"Enabled\" 2\u003e nul | findstr Enabled 2\u003e nul\") -and (cmd.exe /c \"reg query \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\\Scenarios\\HypervisorEnforcedCodeIntegrity\" /v \"Locked\" 2\u003e nul | findstr Locked 2\u003e nul\"))) { exit 0 } else { exit 1 }",
        "command_type": "powershell"
      },
      "elevation_required": true
    },
    {
      "id": "67b4b820-0167-4b1e-b23a-64dfe3b06823",
      "name": "Resolve dependency 1/1",
      "description": "HVCI must be enabled\n",
      "type": "execute-command",
      "data": {
        "command": "reg add \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\" /v \"EnableVirtualizationBasedSecurity\" /t REG_DWORD /d 1 /f\nreg add \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\" /v \"RequirePlatformSecurityFeatures\" /t REG_DWORD /d 1 /f\nreg add \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\" /v \"Locked\" /t REG_DWORD /d 0 /f\nreg add \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\\Scenarios\\HypervisorEnforcedCodeIntegrity\" /v \"Enabled\" /t REG_DWORD /d 1 /f\nreg add \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\\Scenarios\\HypervisorEnforcedCodeIntegrity\" /v \"Locked\" /t REG_DWORD /d 0 /f",
        "command_type": "powershell"
      },
      "elevation_required": true
    },
    {
      "id": "058bd27f-081e-4319-a5f3-6b21a88ff11f",
      "name": "Re-check dependency 1/1",
      "description": "HVCI must be enabled\n",
      "type": "execute-command",
      "data": {
        "command": "if (((cmd.exe /c \"reg query \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\" /v \"EnableVirtualizationBasedSecurity\" 2\u003e nul | findstr EnableVirtualizationBasedSecurity 2\u003e nul\") -and (cmd.exe /c \"reg query \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\" /v \"RequirePlatformSecurityFeatures\" 2\u003e nul | findstr RequirePlatformSecurityFeatures 2\u003e nul\") -and (cmd.exe /c \"reg query \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\" /v \"Locked\" 2\u003e nul | findstr Locked 2\u003e nul\") -and (cmd.exe /c \"reg query \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\\Scenarios\\HypervisorEnforcedCodeIntegrity\" /v \"Enabled\" 2\u003e nul | findstr Enabled 2\u003e nul\") -and (cmd.exe /c \"reg query \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\\Scenarios\\HypervisorEnforcedCodeIntegrity\" /v \"Locked\" 2\u003e nul | findstr Locked 2\u003e nul\"))) { exit 0 } else { exit 1 }",
        "command_type": "powershell"
      },
      "elevation_required": true
    }
  ],
  "flows": [
    {
      "s": "c2a03e4b-ed75-4506-8e85-e08394248702",
      "p": "on-success",
      "o": "4c0187c7-b72d-457c-881d-0b5114ad9785"
    },
    {
      "s": "c2a03e4b-ed75-4506-8e85-e08394248702",
      "p": "on-failure",
      "o": "4c0187c7-b72d-457c-881d-0b5114ad9785"
    },
    {
      "s": "4c4451fe-e0eb-45b5-b928-e6dd1799158e",
      "p": "on-success",
      "o": "c2a03e4b-ed75-4506-8e85-e08394248702"
    },
    {
      "s": "4c4451fe-e0eb-45b5-b928-e6dd1799158e",
      "p": "on-failure",
      "o": "67b4b820-0167-4b1e-b23a-64dfe3b06823"
    },
    {
      "s": "67b4b820-0167-4b1e-b23a-64dfe3b06823",
      "p": "on-success",
      "o": "058bd27f-081e-4319-a5f3-6b21a88ff11f"
    },
    {
      "s": "058bd27f-081e-4319-a5f3-6b21a88ff11f",
      "p": "on-failure",
      "o": "c2a03e4b-ed75-4506-8e85-e08394248702"
    }
  ],
  "tags": [
    "T1562",
    "T1562.001"
  ]
}