{
  "id": "70bd71e6-eba4-4e00-92f7-617911dbe020",
  "name": "Disable Hypervisor-Enforced Code Integrity (HVCI)",
  "description": "This test disables Hypervisor-Enforced Code Integrity (HVCI) by setting the registry key HKLM:\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\\Scenarios\\HypervisorEnforcedCodeIntegrity \"Enabled\" value to \"0\".\nThe pre-req needs to be ran in order to setup HVCI and have it enabled. \nWe do not recommend running this in production.\n[Black Lotus Campaign](https://www.microsoft.com/en-us/security/blog/2023/04/11/guidance-for-investigating-attacks-using-cve-2022-21894-the-blacklotus-campaign/)\n[Microsoft](https://learn.microsoft.com/en-us/windows/security/threat-protection/device-guard/enable-virtualization-based-protection-of-code-integrity)\n",
  "platforms": [
    "windows"
  ],
  "steps": [
    {
      "id": "6be79174-5bc0-42c6-a3e1-3f8f8bbd4cb5",
      "type": "execute-command",
      "data": {
        "command": "reg add \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\\Scenarios\\HypervisorEnforcedCodeIntegrity\" /v \"Enabled\" /t REG_DWORD /d 0 /f\n",
        "command_type": "powershell"
      },
      "elevation_required": true
    },
    {
      "id": "6a9d6da5-7e22-436f-8b4b-6d3aeea35b19",
      "type": "execute-command",
      "data": {
        "command": "reg delete \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\" /v \"EnableVirtualizationBasedSecurity\" /f\nreg delete \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\" /v \"RequirePlatformSecurityFeatures\" /f\nreg delete \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\" /v \"Locked\" /f\nreg delete \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\\Scenarios\\HypervisorEnforcedCodeIntegrity\" /v \"Enabled\" /f\nreg delete \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\\Scenarios\\HypervisorEnforcedCodeIntegrity\" /v \"Locked\" /f\n",
        "command_type": "powershell"
      },
      "elevation_required": true
    },
    {
      "id": "1662a6c7-4447-4737-beee-8ffe1461fffd",
      "name": "Check dependency 1/1",
      "description": "HVCI must be enabled\n",
      "type": "execute-command",
      "data": {
        "command": "if (((cmd.exe /c \"reg query \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\" /v \"EnableVirtualizationBasedSecurity\" 2\u003e nul | findstr EnableVirtualizationBasedSecurity 2\u003e nul\") -and (cmd.exe /c \"reg query \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\" /v \"RequirePlatformSecurityFeatures\" 2\u003e nul | findstr RequirePlatformSecurityFeatures 2\u003e nul\") -and (cmd.exe /c \"reg query \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\" /v \"Locked\" 2\u003e nul | findstr Locked 2\u003e nul\") -and (cmd.exe /c \"reg query \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\\Scenarios\\HypervisorEnforcedCodeIntegrity\" /v \"Enabled\" 2\u003e nul | findstr Enabled 2\u003e nul\") -and (cmd.exe /c \"reg query \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\\Scenarios\\HypervisorEnforcedCodeIntegrity\" /v \"Locked\" 2\u003e nul | findstr Locked 2\u003e nul\"))) { exit 0 } else { exit 1 }\n",
        "command_type": ""
      },
      "elevation_required": true
    },
    {
      "id": "4e2ac852-91c1-475f-b002-0ddb94e859c6",
      "name": "Resolve dependency 1/1",
      "description": "HVCI must be enabled\n",
      "type": "execute-command",
      "data": {
        "command": "reg add \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\" /v \"EnableVirtualizationBasedSecurity\" /t REG_DWORD /d 1 /f\nreg add \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\" /v \"RequirePlatformSecurityFeatures\" /t REG_DWORD /d 1 /f\nreg add \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\" /v \"Locked\" /t REG_DWORD /d 0 /f\nreg add \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\\Scenarios\\HypervisorEnforcedCodeIntegrity\" /v \"Enabled\" /t REG_DWORD /d 1 /f\nreg add \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\\Scenarios\\HypervisorEnforcedCodeIntegrity\" /v \"Locked\" /t REG_DWORD /d 0 /f\n",
        "command_type": ""
      },
      "elevation_required": true
    },
    {
      "id": "3609fe9f-e192-49e1-af59-e7e139e186ae",
      "name": "Re-check dependency 1/1",
      "description": "HVCI must be enabled\n",
      "type": "execute-command",
      "data": {
        "command": "if (((cmd.exe /c \"reg query \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\" /v \"EnableVirtualizationBasedSecurity\" 2\u003e nul | findstr EnableVirtualizationBasedSecurity 2\u003e nul\") -and (cmd.exe /c \"reg query \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\" /v \"RequirePlatformSecurityFeatures\" 2\u003e nul | findstr RequirePlatformSecurityFeatures 2\u003e nul\") -and (cmd.exe /c \"reg query \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\" /v \"Locked\" 2\u003e nul | findstr Locked 2\u003e nul\") -and (cmd.exe /c \"reg query \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\\Scenarios\\HypervisorEnforcedCodeIntegrity\" /v \"Enabled\" 2\u003e nul | findstr Enabled 2\u003e nul\") -and (cmd.exe /c \"reg query \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\\Scenarios\\HypervisorEnforcedCodeIntegrity\" /v \"Locked\" 2\u003e nul | findstr Locked 2\u003e nul\"))) { exit 0 } else { exit 1 }\n",
        "command_type": ""
      },
      "elevation_required": true
    }
  ],
  "flows": [
    {
      "s": "6be79174-5bc0-42c6-a3e1-3f8f8bbd4cb5",
      "p": "on-success",
      "o": "6a9d6da5-7e22-436f-8b4b-6d3aeea35b19"
    },
    {
      "s": "6be79174-5bc0-42c6-a3e1-3f8f8bbd4cb5",
      "p": "on-failure",
      "o": "6a9d6da5-7e22-436f-8b4b-6d3aeea35b19"
    },
    {
      "s": "1662a6c7-4447-4737-beee-8ffe1461fffd",
      "p": "on-success",
      "o": "6be79174-5bc0-42c6-a3e1-3f8f8bbd4cb5"
    },
    {
      "s": "1662a6c7-4447-4737-beee-8ffe1461fffd",
      "p": "on-failure",
      "o": "4e2ac852-91c1-475f-b002-0ddb94e859c6"
    },
    {
      "s": "4e2ac852-91c1-475f-b002-0ddb94e859c6",
      "p": "on-success",
      "o": "3609fe9f-e192-49e1-af59-e7e139e186ae"
    },
    {
      "s": "3609fe9f-e192-49e1-af59-e7e139e186ae",
      "p": "on-failure",
      "o": "6be79174-5bc0-42c6-a3e1-3f8f8bbd4cb5"
    }
  ],
  "tags": [
    "T1562",
    "T1562.001"
  ]
}