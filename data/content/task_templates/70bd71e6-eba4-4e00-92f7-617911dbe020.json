{
  "id": "70bd71e6-eba4-4e00-92f7-617911dbe020",
  "name": "Disable Hypervisor-Enforced Code Integrity (HVCI)",
  "description": "This test disables Hypervisor-Enforced Code Integrity (HVCI) by setting the registry key HKLM:\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\\Scenarios\\HypervisorEnforcedCodeIntegrity \"Enabled\" value to \"0\".\nThe pre-req needs to be ran in order to setup HVCI and have it enabled. \nWe do not recommend running this in production.\n[Black Lotus Campaign](https://www.microsoft.com/en-us/security/blog/2023/04/11/guidance-for-investigating-attacks-using-cve-2022-21894-the-blacklotus-campaign/)\n[Microsoft](https://learn.microsoft.com/en-us/windows/security/threat-protection/device-guard/enable-virtualization-based-protection-of-code-integrity)\n",
  "platforms": [
    "windows"
  ],
  "steps": [
    {
      "id": "ae5650e0-e0e9-4d28-b43b-b274af9adda0",
      "type": "execute-command",
      "data": {
        "command": "reg add \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\\Scenarios\\HypervisorEnforcedCodeIntegrity\" /v \"Enabled\" /t REG_DWORD /d 0 /f",
        "command_type": "powershell"
      },
      "elevation_required": true
    },
    {
      "id": "3257194e-e28f-4297-bd45-a22b02002223",
      "type": "execute-command",
      "data": {
        "command": "reg delete \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\" /v \"EnableVirtualizationBasedSecurity\" /f\nreg delete \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\" /v \"RequirePlatformSecurityFeatures\" /f\nreg delete \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\" /v \"Locked\" /f\nreg delete \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\\Scenarios\\HypervisorEnforcedCodeIntegrity\" /v \"Enabled\" /f\nreg delete \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\\Scenarios\\HypervisorEnforcedCodeIntegrity\" /v \"Locked\" /f",
        "command_type": "powershell"
      },
      "elevation_required": true
    },
    {
      "id": "8c61cec9-4537-459b-bc95-1372892cfb8f",
      "name": "Check dependency 1/1",
      "description": "HVCI must be enabled\n",
      "type": "execute-command",
      "data": {
        "command": "if (((cmd.exe /c \"reg query \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\" /v \"EnableVirtualizationBasedSecurity\" 2\u003e nul | findstr EnableVirtualizationBasedSecurity 2\u003e nul\") -and (cmd.exe /c \"reg query \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\" /v \"RequirePlatformSecurityFeatures\" 2\u003e nul | findstr RequirePlatformSecurityFeatures 2\u003e nul\") -and (cmd.exe /c \"reg query \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\" /v \"Locked\" 2\u003e nul | findstr Locked 2\u003e nul\") -and (cmd.exe /c \"reg query \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\\Scenarios\\HypervisorEnforcedCodeIntegrity\" /v \"Enabled\" 2\u003e nul | findstr Enabled 2\u003e nul\") -and (cmd.exe /c \"reg query \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\\Scenarios\\HypervisorEnforcedCodeIntegrity\" /v \"Locked\" 2\u003e nul | findstr Locked 2\u003e nul\"))) { exit 0 } else { exit 1 }",
        "command_type": "powershell"
      },
      "elevation_required": true
    },
    {
      "id": "8f85773f-5902-4037-908d-f75f775f2637",
      "name": "Resolve dependency 1/1",
      "description": "HVCI must be enabled\n",
      "type": "execute-command",
      "data": {
        "command": "reg add \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\" /v \"EnableVirtualizationBasedSecurity\" /t REG_DWORD /d 1 /f\nreg add \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\" /v \"RequirePlatformSecurityFeatures\" /t REG_DWORD /d 1 /f\nreg add \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\" /v \"Locked\" /t REG_DWORD /d 0 /f\nreg add \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\\Scenarios\\HypervisorEnforcedCodeIntegrity\" /v \"Enabled\" /t REG_DWORD /d 1 /f\nreg add \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\\Scenarios\\HypervisorEnforcedCodeIntegrity\" /v \"Locked\" /t REG_DWORD /d 0 /f",
        "command_type": "powershell"
      },
      "elevation_required": true
    },
    {
      "id": "9eda11b7-fe01-4a0a-ae9b-becbc95bb4f0",
      "name": "Re-check dependency 1/1",
      "description": "HVCI must be enabled\n",
      "type": "execute-command",
      "data": {
        "command": "if (((cmd.exe /c \"reg query \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\" /v \"EnableVirtualizationBasedSecurity\" 2\u003e nul | findstr EnableVirtualizationBasedSecurity 2\u003e nul\") -and (cmd.exe /c \"reg query \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\" /v \"RequirePlatformSecurityFeatures\" 2\u003e nul | findstr RequirePlatformSecurityFeatures 2\u003e nul\") -and (cmd.exe /c \"reg query \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\" /v \"Locked\" 2\u003e nul | findstr Locked 2\u003e nul\") -and (cmd.exe /c \"reg query \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\\Scenarios\\HypervisorEnforcedCodeIntegrity\" /v \"Enabled\" 2\u003e nul | findstr Enabled 2\u003e nul\") -and (cmd.exe /c \"reg query \"HKLM\\SYSTEM\\CurrentControlSet\\Control\\DeviceGuard\\Scenarios\\HypervisorEnforcedCodeIntegrity\" /v \"Locked\" 2\u003e nul | findstr Locked 2\u003e nul\"))) { exit 0 } else { exit 1 }",
        "command_type": "powershell"
      },
      "elevation_required": true
    }
  ],
  "flows": [
    {
      "s": "ae5650e0-e0e9-4d28-b43b-b274af9adda0",
      "p": "on-success",
      "o": "3257194e-e28f-4297-bd45-a22b02002223"
    },
    {
      "s": "ae5650e0-e0e9-4d28-b43b-b274af9adda0",
      "p": "on-failure",
      "o": "3257194e-e28f-4297-bd45-a22b02002223"
    },
    {
      "s": "8c61cec9-4537-459b-bc95-1372892cfb8f",
      "p": "on-success",
      "o": "ae5650e0-e0e9-4d28-b43b-b274af9adda0"
    },
    {
      "s": "8c61cec9-4537-459b-bc95-1372892cfb8f",
      "p": "on-failure",
      "o": "8f85773f-5902-4037-908d-f75f775f2637"
    },
    {
      "s": "8f85773f-5902-4037-908d-f75f775f2637",
      "p": "on-success",
      "o": "9eda11b7-fe01-4a0a-ae9b-becbc95bb4f0"
    },
    {
      "s": "9eda11b7-fe01-4a0a-ae9b-becbc95bb4f0",
      "p": "on-failure",
      "o": "ae5650e0-e0e9-4d28-b43b-b274af9adda0"
    }
  ],
  "tags": [
    "T1562",
    "T1562.001"
  ],
  "input_arguments": null
}