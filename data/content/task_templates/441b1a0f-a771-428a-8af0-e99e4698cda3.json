{
  "id": "441b1a0f-a771-428a-8af0-e99e4698cda3",
  "name": "Code Executed Via Excel Add-in File (XLL)",
  "description": "Loads an XLL file using the excel add-ins library.\nThis causes excel to launch Notepad.exe as a child process. This atomic test does not include persistent code execution as you would typically see when this is implemented in malware.\n",
  "platforms": [
    "windows"
  ],
  "steps": [
    {
      "id": "db56540e-fee2-40f1-893e-48dca8fc6f7e",
      "type": "execute-command",
      "data": {
        "command": "$excelApp = New-Object -COMObject \"Excel.Application\"\nif(-not $excelApp.path.contains(\"Program Files (x86)\")){\n    Write-Host \"64-bit Office\"\n    $excelApp.RegisterXLL(\"PathToAtomicsFolder\\T1137.006\\bin\\Addins\\excelxll_x64.xll\")\n}\nelse{\n  Write-Host \"32-bit Office\"\n  $excelApp.RegisterXLL(\"PathToAtomicsFolder\\T1137.006\\bin\\Addins\\excelxll_x86.xll\")\n}\n",
        "command_type": "powershell"
      },
      "elevation_required": false
    },
    {
      "id": "76a98a32-210d-4cbc-95af-2258827cc932",
      "type": "execute-command",
      "data": {
        "command": "Stop-Process -Name \"notepad\",\"Excel\" -ErrorAction Ignore\n",
        "command_type": "powershell"
      },
      "elevation_required": false
    },
    {
      "id": "eafeb9fb-e310-426e-9c0e-8edc2d9cc9bb",
      "name": "Check dependency 1/2",
      "description": "Microsoft Excel must be installed\n",
      "type": "execute-command",
      "data": {
        "command": "try {\n  New-Object -COMObject \"Excel.Application\" | Out-Null\n  Stop-Process -Name \"Excel\"\n  exit 0\n} catch { exit 1 }\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "b375cc2a-ccd9-4a30-b3a8-782b108df73e",
      "name": "Resolve dependency 1/2",
      "description": "Microsoft Excel must be installed\n",
      "type": "execute-command",
      "data": {
        "command": "Write-Host \"You will need to install Microsoft Excel manually to meet this requirement\"\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "fda20410-9bb3-468d-a8bd-d51dec3ce21a",
      "name": "Re-check dependency 1/2",
      "description": "Microsoft Excel must be installed\n",
      "type": "execute-command",
      "data": {
        "command": "try {\n  New-Object -COMObject \"Excel.Application\" | Out-Null\n  Stop-Process -Name \"Excel\"\n  exit 0\n} catch { exit 1 }\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "8946c894-cbb2-4a29-b09c-28a799a2f02a",
      "name": "Check dependency 2/2",
      "description": "XLL files must exist on disk at specified location",
      "type": "execute-command",
      "data": {
        "command": "if ((Test-Path \"PathToAtomicsFolder\\T1137.006\\bin\\Addins\\excelxll_x64.xll\") -and (Test-Path \"PathToAtomicsFolder\\T1137.006\\bin\\Addins\\excelxll_x86.xll\")) {exit 0} else {exit 1}\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "f08c41dd-2dfe-43ea-97bd-59db96fdcc77",
      "name": "Resolve dependency 2/2",
      "description": "XLL files must exist on disk at specified location",
      "type": "execute-command",
      "data": {
        "command": "New-Item -Type Directory \"PathToAtomicsFolder\\T1137.006\\bin\\Addins\\\" -Force | Out-Null\nInvoke-Webrequest -Uri \"https://github.com/redcanaryco/atomic-red-team/raw/master/atomics/T1137.006/bin/Addins/excelxll_x64.xll\" -UseBasicParsing -OutFile \"PathToAtomicsFolder\\T1137.006\\bin\\Addins\\excelxll_x64.xll\"\nInvoke-Webrequest -Uri \"https://github.com/redcanaryco/atomic-red-team/raw/master/atomics/T1137.006/bin/Addins/excelxll_x86.xll\" -UseBasicParsing -OutFile \"PathToAtomicsFolder\\T1137.006\\bin\\Addins\\excelxll_x86.xll\"",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "2bff72aa-30b5-4c18-aa4c-a454a74c8743",
      "name": "Re-check dependency 2/2",
      "description": "XLL files must exist on disk at specified location",
      "type": "execute-command",
      "data": {
        "command": "if ((Test-Path \"PathToAtomicsFolder\\T1137.006\\bin\\Addins\\excelxll_x64.xll\") -and (Test-Path \"PathToAtomicsFolder\\T1137.006\\bin\\Addins\\excelxll_x86.xll\")) {exit 0} else {exit 1}\n",
        "command_type": ""
      },
      "elevation_required": false
    }
  ],
  "flows": [
    {
      "s": "db56540e-fee2-40f1-893e-48dca8fc6f7e",
      "p": "on-success",
      "o": "76a98a32-210d-4cbc-95af-2258827cc932"
    },
    {
      "s": "db56540e-fee2-40f1-893e-48dca8fc6f7e",
      "p": "on-failure",
      "o": "76a98a32-210d-4cbc-95af-2258827cc932"
    },
    {
      "s": "eafeb9fb-e310-426e-9c0e-8edc2d9cc9bb",
      "p": "on-success",
      "o": "db56540e-fee2-40f1-893e-48dca8fc6f7e"
    },
    {
      "s": "eafeb9fb-e310-426e-9c0e-8edc2d9cc9bb",
      "p": "on-failure",
      "o": "b375cc2a-ccd9-4a30-b3a8-782b108df73e"
    },
    {
      "s": "b375cc2a-ccd9-4a30-b3a8-782b108df73e",
      "p": "on-success",
      "o": "fda20410-9bb3-468d-a8bd-d51dec3ce21a"
    },
    {
      "s": "fda20410-9bb3-468d-a8bd-d51dec3ce21a",
      "p": "on-failure",
      "o": "db56540e-fee2-40f1-893e-48dca8fc6f7e"
    },
    {
      "s": "8946c894-cbb2-4a29-b09c-28a799a2f02a",
      "p": "on-success",
      "o": "db56540e-fee2-40f1-893e-48dca8fc6f7e"
    },
    {
      "s": "8946c894-cbb2-4a29-b09c-28a799a2f02a",
      "p": "on-failure",
      "o": "f08c41dd-2dfe-43ea-97bd-59db96fdcc77"
    },
    {
      "s": "f08c41dd-2dfe-43ea-97bd-59db96fdcc77",
      "p": "on-success",
      "o": "2bff72aa-30b5-4c18-aa4c-a454a74c8743"
    },
    {
      "s": "2bff72aa-30b5-4c18-aa4c-a454a74c8743",
      "p": "on-failure",
      "o": "db56540e-fee2-40f1-893e-48dca8fc6f7e"
    }
  ],
  "tags": [
    "T1137.006",
    "atomic-red-team"
  ]
}