{
  "id": "766b6c3c-9353-4033-8b7e-38b309fa3a93",
  "name": "Append to existing loginwindow for Re-Opened Applications",
  "description": "Appends an entry to launch Calculator hidden loginwindow.*.plist for next login.\nNote that the change may not result in the added Calculator program launching on next user login.\nIt may depend on which version of macOS you are running on.\n",
  "platforms": [
    "darwin"
  ],
  "steps": [
    {
      "id": "7a7282a5-b5cf-440a-a720-0162866d1e16",
      "type": "execute-command",
      "data": {
        "command": "FILE=`find ~/Library/Preferences/ByHost/com.apple.loginwindow.*.plist -type f | head -1`\nif [ -z \"${FILE}\" ] ; then echo \"No loginwindow plist file found\" \u0026\u0026 exit 1 ; fi\necho save backup copy to /tmp/\ncp ${FILE} /tmp/t1547007_loginwindow-backup.plist\necho before\nplutil -p ${FILE}\necho overwriting...\n#{exe_path} ${FILE} \u0026\u0026 echo after \u0026\u0026 plutil -p ${FILE}\n",
        "command_type": "sh"
      },
      "elevation_required": false
    },
    {
      "id": "9bcf1cac-4d9a-4f0f-843c-160f235af10c",
      "type": "execute-command",
      "data": {
        "command": "rm -f #{exe_path}\n# revert to backup copy\nFILE=`find ~/Library/Preferences/ByHost/com.apple.loginwindow.*.plist -type f | head -1`\nif [ -z \"${FILE}\" ] ; then\n   exit 0\nfi\nmv /tmp/t1547007_loginwindow-backup.plist ${FILE}\n",
        "command_type": "sh"
      },
      "elevation_required": false
    },
    {
      "id": "6f71e38d-61f7-4d24-9063-7abbf359ca55",
      "name": "Check dependency 1/1",
      "description": "compile C program\n",
      "type": "execute-command",
      "data": {
        "command": "if [ -f \"#{exe_path}\" ]; then exit 0 ; else exit 1; fi\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "07527347-53a2-48c1-8951-f39e6b9e84b8",
      "name": "Resolve dependency 1/1",
      "description": "compile C program\n",
      "type": "execute-command",
      "data": {
        "command": "cc #{objc_source_path} -o #{exe_path} -framework Cocoa\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "b889ace8-91fb-4133-acd0-9c7c41c892bd",
      "name": "Re-check dependency 1/1",
      "description": "compile C program\n",
      "type": "execute-command",
      "data": {
        "command": "if [ -f \"#{exe_path}\" ]; then exit 0 ; else exit 1; fi\n",
        "command_type": ""
      },
      "elevation_required": false
    }
  ],
  "flows": [
    {
      "s": "7a7282a5-b5cf-440a-a720-0162866d1e16",
      "p": "on-success",
      "o": "9bcf1cac-4d9a-4f0f-843c-160f235af10c"
    },
    {
      "s": "7a7282a5-b5cf-440a-a720-0162866d1e16",
      "p": "on-failure",
      "o": "9bcf1cac-4d9a-4f0f-843c-160f235af10c"
    },
    {
      "s": "6f71e38d-61f7-4d24-9063-7abbf359ca55",
      "p": "on-success",
      "o": "7a7282a5-b5cf-440a-a720-0162866d1e16"
    },
    {
      "s": "6f71e38d-61f7-4d24-9063-7abbf359ca55",
      "p": "on-failure",
      "o": "07527347-53a2-48c1-8951-f39e6b9e84b8"
    },
    {
      "s": "07527347-53a2-48c1-8951-f39e6b9e84b8",
      "p": "on-success",
      "o": "b889ace8-91fb-4133-acd0-9c7c41c892bd"
    },
    {
      "s": "b889ace8-91fb-4133-acd0-9c7c41c892bd",
      "p": "on-failure",
      "o": "7a7282a5-b5cf-440a-a720-0162866d1e16"
    }
  ],
  "tags": [
    "T1547.007",
    "atomic-red-team"
  ],
  "input_arguments": [
    {
      "name": "objc_source_path",
      "type": "path",
      "description": "path to objective C program",
      "value": "PathToAtomicsFolder/T1547.007/src/append_reopen_loginwindow.m"
    },
    {
      "name": "exe_path",
      "type": "path",
      "description": "path to compiled program",
      "value": "/tmp/t1547007_append_exe"
    }
  ]
}