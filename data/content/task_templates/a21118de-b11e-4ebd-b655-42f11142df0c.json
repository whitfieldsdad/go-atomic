{
  "id": "a21118de-b11e-4ebd-b655-42f11142df0c",
  "name": "AWS - Retrieve EC2 Password Data using stratus",
  "description": "This atomic runs an API call GetPasswordData from a role that does not have permission to do so. This simulates an attacker attempting to retrieve RDP passwords on a high number of Windows EC2 instances. This atomic test leverages a tool called stratus-red-team built by DataDog (https://github.com/DataDog/stratus-red-team). Stratus Red Team is a self-contained binary. You can use it to easily detonate offensive attack techniques against a live cloud environment. Ref: https://stratus-red-team.cloud/attack-techniques/AWS/aws.credential-access.ec2-get-password-data/\n",
  "platforms": [
    "linux",
    "darwin",
    "iaas:aws"
  ],
  "steps": [
    {
      "id": "76236bf8-1f72-4f34-ad8c-fca19109494f",
      "type": "execute-command",
      "data": {
        "command": "export AWS_REGION=#{aws_region} \ncd #{stratus_path}\necho \"starting warmup\"\n./stratus warmup aws.credential-access.ec2-get-password-data\necho \"starting detonate\"\n./stratus detonate aws.credential-access.ec2-get-password-data --force\n",
        "command_type": "sh"
      },
      "elevation_required": false
    },
    {
      "id": "255edfdc-6b6d-4074-a321-c691e1d27d01",
      "type": "execute-command",
      "data": {
        "command": "export AWS_REGION=#{aws_region}\necho \"Cleanup detonation\"\ncd #{stratus_path}\n./stratus cleanup --all\nrm -rf stratus*\n",
        "command_type": "sh"
      },
      "elevation_required": false
    },
    {
      "id": "667edf59-163b-42c6-a769-73de6323ea8a",
      "name": "Check dependency 1/2",
      "description": "Stratus binary must be present at the (#{stratus_path}/stratus)\n",
      "type": "execute-command",
      "data": {
        "command": "if [ -f #{stratus_path}/stratus ]; then exit 0; else exit 1; fi;\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "d6ff2003-2825-4363-b562-08658d5c90ea",
      "name": "Resolve dependency 1/2",
      "description": "Stratus binary must be present at the (#{stratus_path}/stratus)\n",
      "type": "execute-command",
      "data": {
        "command": "if [ \"$(uname)\" == \"Darwin\" ]\nthen DOWNLOAD_URL=$(curl -s https://api.github.com/repos/DataDog/stratus-red-team/releases/latest | grep browser_download_url | grep Darwin_x86_64 | cut -d '\"' -f 4); wget -q -O #{stratus_path}/stratus-red-team-latest.tar.gz $DOWNLOAD_URL\n  tar -xzvf #{stratus_path}/stratus-red-team-latest.tar.gz --directory #{stratus_path}/\nelif [ \"$(expr substr $(uname) 1 5)\" == \"Linux\" ]\nthen DOWNLOAD_URL=$(curl -s https://api.github.com/repos/DataDog/stratus-red-team/releases/latest | grep browser_download_url | grep Linux_x86_64 | cut -d '\"' -f 4) \n  wget -q -O #{stratus_path}/stratus-red-team-latest.tar.gz $DOWNLOAD_URL\n  tar -xzvf #{stratus_path}/stratus-red-team-latest.tar.gz --directory #{stratus_path}/\nfi\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "2d683f65-5adb-4d48-9063-375cc00cd1dd",
      "name": "Re-check dependency 1/2",
      "description": "Stratus binary must be present at the (#{stratus_path}/stratus)\n",
      "type": "execute-command",
      "data": {
        "command": "if [ -f #{stratus_path}/stratus ]; then exit 0; else exit 1; fi;\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "09f1d662-914a-41f4-b833-f7f70c35ceb9",
      "name": "Check dependency 2/2",
      "description": "Check if ~/.aws/credentials file has a default stanza is configured\n",
      "type": "execute-command",
      "data": {
        "command": "cat ~/.aws/credentials | grep \"default\"\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "8b4ce440-bce2-4a4d-a384-9dd26f5d6f2f",
      "name": "Resolve dependency 2/2",
      "description": "Check if ~/.aws/credentials file has a default stanza is configured\n",
      "type": "execute-command",
      "data": {
        "command": "echo Please install the aws-cli and configure your AWS defult profile using: aws configure\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "75a9e252-7a67-4318-ad32-96e5cf89fd3f",
      "name": "Re-check dependency 2/2",
      "description": "Check if ~/.aws/credentials file has a default stanza is configured\n",
      "type": "execute-command",
      "data": {
        "command": "cat ~/.aws/credentials | grep \"default\"\n",
        "command_type": ""
      },
      "elevation_required": false
    }
  ],
  "flows": [
    {
      "s": "76236bf8-1f72-4f34-ad8c-fca19109494f",
      "p": "on-success",
      "o": "255edfdc-6b6d-4074-a321-c691e1d27d01"
    },
    {
      "s": "76236bf8-1f72-4f34-ad8c-fca19109494f",
      "p": "on-failure",
      "o": "255edfdc-6b6d-4074-a321-c691e1d27d01"
    },
    {
      "s": "667edf59-163b-42c6-a769-73de6323ea8a",
      "p": "on-success",
      "o": "76236bf8-1f72-4f34-ad8c-fca19109494f"
    },
    {
      "s": "667edf59-163b-42c6-a769-73de6323ea8a",
      "p": "on-failure",
      "o": "d6ff2003-2825-4363-b562-08658d5c90ea"
    },
    {
      "s": "d6ff2003-2825-4363-b562-08658d5c90ea",
      "p": "on-success",
      "o": "2d683f65-5adb-4d48-9063-375cc00cd1dd"
    },
    {
      "s": "2d683f65-5adb-4d48-9063-375cc00cd1dd",
      "p": "on-failure",
      "o": "76236bf8-1f72-4f34-ad8c-fca19109494f"
    },
    {
      "s": "09f1d662-914a-41f4-b833-f7f70c35ceb9",
      "p": "on-success",
      "o": "76236bf8-1f72-4f34-ad8c-fca19109494f"
    },
    {
      "s": "09f1d662-914a-41f4-b833-f7f70c35ceb9",
      "p": "on-failure",
      "o": "8b4ce440-bce2-4a4d-a384-9dd26f5d6f2f"
    },
    {
      "s": "8b4ce440-bce2-4a4d-a384-9dd26f5d6f2f",
      "p": "on-success",
      "o": "75a9e252-7a67-4318-ad32-96e5cf89fd3f"
    },
    {
      "s": "75a9e252-7a67-4318-ad32-96e5cf89fd3f",
      "p": "on-failure",
      "o": "76236bf8-1f72-4f34-ad8c-fca19109494f"
    }
  ],
  "tags": [
    "T1552",
    "atomic-red-team"
  ],
  "input_arguments": [
    {
      "name": "stratus_path",
      "type": "path",
      "description": "Path of stratus binary",
      "value": "$PathToAtomicsFolder/T1552/src"
    },
    {
      "name": "aws_region",
      "type": "string",
      "description": "AWS region to detonate",
      "value": "us-west-2"
    }
  ]
}