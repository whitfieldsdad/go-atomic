{
  "id": "687dcb93-9656-4853-9c36-9977315e9d23",
  "name": "Linux - Load Kernel Module via insmod",
  "description": "This test uses the insmod command to load a kernel module for Linux.\n",
  "platforms": [
    "linux"
  ],
  "steps": [
    {
      "id": "62502c9e-2c6f-4528-a921-e370e9210f6d",
      "type": "execute-command",
      "data": {
        "command": "sudo insmod #{module_path}\n",
        "command_type": "bash"
      },
      "elevation_required": false
    },
    {
      "id": "6cd5a3b7-5255-4a51-88d1-b12bd21030c9",
      "type": "execute-command",
      "data": {
        "command": "sudo rmmod #{module_name}\n[ -f #{temp_folder}/safe_to_delete ] \u0026\u0026 rm -rf #{temp_folder}\n",
        "command_type": "bash"
      },
      "elevation_required": false
    },
    {
      "id": "c36ce7b0-ee23-40e8-bc56-808dd7fe3e96",
      "name": "Check dependency 1/1",
      "description": "The kernel module must exist on disk at specified location\n",
      "type": "execute-command",
      "data": {
        "command": "if [ -f #{module_path} ]; then exit 0; else exit 1; fi;\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "27c22e52-60cc-47eb-8ce7-023eb5bce934",
      "name": "Resolve dependency 1/1",
      "description": "The kernel module must exist on disk at specified location\n",
      "type": "execute-command",
      "data": {
        "command": "if [ ! -d #{temp_folder} ]; then mkdir #{temp_folder}; touch #{temp_folder}/safe_to_delete; fi;\ncp #{module_source_path}/* #{temp_folder}/\ncd #{temp_folder}; make\nif [ ! -f #{module_path} ]; then mv #{temp_folder}/#{module_name}.ko #{module_path}; fi;\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "b6bb66d5-3516-4ed0-b0bc-f54865336ab4",
      "name": "Re-check dependency 1/1",
      "description": "The kernel module must exist on disk at specified location\n",
      "type": "execute-command",
      "data": {
        "command": "if [ -f #{module_path} ]; then exit 0; else exit 1; fi;\n",
        "command_type": ""
      },
      "elevation_required": false
    }
  ],
  "flows": [
    {
      "s": "62502c9e-2c6f-4528-a921-e370e9210f6d",
      "p": "on-success",
      "o": "6cd5a3b7-5255-4a51-88d1-b12bd21030c9"
    },
    {
      "s": "62502c9e-2c6f-4528-a921-e370e9210f6d",
      "p": "on-failure",
      "o": "6cd5a3b7-5255-4a51-88d1-b12bd21030c9"
    },
    {
      "s": "c36ce7b0-ee23-40e8-bc56-808dd7fe3e96",
      "p": "on-success",
      "o": "62502c9e-2c6f-4528-a921-e370e9210f6d"
    },
    {
      "s": "c36ce7b0-ee23-40e8-bc56-808dd7fe3e96",
      "p": "on-failure",
      "o": "27c22e52-60cc-47eb-8ce7-023eb5bce934"
    },
    {
      "s": "27c22e52-60cc-47eb-8ce7-023eb5bce934",
      "p": "on-success",
      "o": "b6bb66d5-3516-4ed0-b0bc-f54865336ab4"
    },
    {
      "s": "b6bb66d5-3516-4ed0-b0bc-f54865336ab4",
      "p": "on-failure",
      "o": "62502c9e-2c6f-4528-a921-e370e9210f6d"
    }
  ],
  "tags": [
    "T1547.006",
    "atomic-red-team"
  ],
  "input_arguments": [
    {
      "name": "module_name",
      "type": "string",
      "description": "Name of the kernel module name.",
      "value": "T1547006"
    },
    {
      "name": "module_path",
      "type": "path",
      "description": "Folder used to store the module.",
      "value": "/tmp/T1547.006/T1547006.ko"
    },
    {
      "name": "temp_folder",
      "type": "path",
      "description": "Temp folder used to compile the code.",
      "value": "/tmp/T1547.006"
    },
    {
      "name": "module_source_path",
      "type": "url",
      "description": "Path to download Gsecdump binary file",
      "value": "PathToAtomicsFolder/T1547.006/src"
    }
  ]
}