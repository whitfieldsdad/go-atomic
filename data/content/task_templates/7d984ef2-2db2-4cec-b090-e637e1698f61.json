{
  "id": "7d984ef2-2db2-4cec-b090-e637e1698f61",
  "name": "Domain Password Policy Check: No Special Character in Password",
  "description": "Attempt to change the password of the current domain user in order to check password policy. Ideally, you would only run this atomic test to verify that your password policy is blocking the use of the new password.\nIf the password is succesfully changed to the new password, the credential file will be updated to reflect the new password. You can then run the atomic manually and specify a new password of your choosing, however the\npassword policy will likely prevent you from setting the password back to what it was. \n",
  "platforms": [
    "windows"
  ],
  "steps": [
    {
      "id": "2e2a3093-0a43-4d49-8116-7a3cd936d6f0",
      "type": "execute-command",
      "data": {
        "command": "$credFile = \"#{cred_file}\"\nif (Test-Path $credFile) {\n    $cred = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList $env:USERNAME, (Get-Content $credFile | ConvertTo-SecureString)\n    if($cred.GetNetworkCredential().Password -eq \"#{new_password}\"){\n      Write-Host -ForegroundColor Yellow \"The new password is the same as the password stored in the credential file. Please specify a different new password.\"; exit -1\n    }\n    try {\n        $newPassword = ConvertTo-SecureString #{new_password} -AsPlainText -Force\n        Set-ADAccountPassword -Identity $env:USERNAME -OldPassword $cred.password -NewPassword $newPassword\n    }\n    catch { \n        $_.Exception\n        $errCode = $_.Exception.ErrorCode\n        Write-Host \"Error code: $errCode\"\n        if ($errCode -eq 86) {\n            Write-Host -ForegroundColor Yellow \"The stored password for the current user is incorrect. Please run the prereq commands to set the correct credentials\"\n            Remove-Item $credFile\n        }\n        exit $errCode\n    }\n    Write-Host -ForegroundColor Cyan \"Successfully changed the password to #{new_password}\"\n    $newCred = New-Object System.Management.Automation.PSCredential ($env:USERNAME, $(ConvertTo-SecureString \"#{new_password}\" -AsPlainText -Force))\n    $newCred.Password | ConvertFrom-SecureString | Out-File $credFile\n}\nelse {\n    Write-Host -ForegroundColor Yellow \"You must store the password of the current user by running the prerequisite commands first\"\n}\n",
        "command_type": "powershell"
      },
      "elevation_required": false
    },
    {
      "id": "d036a4b6-c876-4afd-ada7-079b585e66d2",
      "name": "Check dependency 1/1",
      "description": "Password for current user must be stored in a credential file\n",
      "type": "execute-command",
      "data": {
        "command": "if (Test-Path #{cred_file}) {exit 0} else {exit 1}\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "81407e65-a1bd-4b9d-8395-77dec5ea8fd8",
      "name": "Resolve dependency 1/1",
      "description": "Password for current user must be stored in a credential file\n",
      "type": "execute-command",
      "data": {
        "command": "New-Item -Type Directory (split-path \"#{cred_file}\") -ErrorAction Ignore | Out-Null\n$cred = Get-Credential -UserName  $env:USERNAME -message \"Enter password for $env:USERNAME to use during password change attempt\"\n$cred.Password | ConvertFrom-SecureString | Out-File \"#{cred_file}\"\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "8eba33df-6ba7-40c1-8ce7-03cb7d7fc7df",
      "name": "Re-check dependency 1/1",
      "description": "Password for current user must be stored in a credential file\n",
      "type": "execute-command",
      "data": {
        "command": "if (Test-Path #{cred_file}) {exit 0} else {exit 1}\n",
        "command_type": ""
      },
      "elevation_required": false
    }
  ],
  "flows": [
    {
      "s": "d036a4b6-c876-4afd-ada7-079b585e66d2",
      "p": "on-success",
      "o": "2e2a3093-0a43-4d49-8116-7a3cd936d6f0"
    },
    {
      "s": "d036a4b6-c876-4afd-ada7-079b585e66d2",
      "p": "on-failure",
      "o": "81407e65-a1bd-4b9d-8395-77dec5ea8fd8"
    },
    {
      "s": "81407e65-a1bd-4b9d-8395-77dec5ea8fd8",
      "p": "on-success",
      "o": "8eba33df-6ba7-40c1-8ce7-03cb7d7fc7df"
    },
    {
      "s": "8eba33df-6ba7-40c1-8ce7-03cb7d7fc7df",
      "p": "on-failure",
      "o": "2e2a3093-0a43-4d49-8116-7a3cd936d6f0"
    }
  ],
  "tags": [
    "T1098"
  ],
  "input_arguments": [
    {
      "name": "new_password",
      "type": "string",
      "description": "The password to set for the current domain user (default is long and has upper and lower case and number but no special character)",
      "value": "UpperLowerLong333noSpecialChar"
    },
    {
      "name": "cred_file",
      "type": "path",
      "description": "A file containing the password of the current user",
      "value": "$env:LOCALAPPDATA\\AtomicRedTeam\\$env:USERNAME.txt"
    }
  ]
}