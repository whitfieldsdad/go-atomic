{
  "id": "53adbdfa-8200-490c-871c-d3b1ab3324b2",
  "name": "Install IIS Module using AppCmd.exe",
  "description": "The following Atomic will utilize AppCmd.exe to install a new IIS Module. IIS must be installed.\nThis atomic utilizes a DLL on disk, but to test further suspiciousness, compile and load [IIS-Raid](https://www.mdsec.co.uk/2020/02/iis-raid-backdooring-iis-using-native-modules/).\nA successful execution will install a module into IIS using AppCmd.exe.\n[Managing and installing Modules Reference](https://learn.microsoft.com/en-us/iis/get-started/introduction-to-iis/iis-modules-overview#to-install-a-module-using-appcmdexe)\n[IIS Modules](https://www.microsoft.com/en-us/security/blog/2022/12/12/iis-modules-the-evolution-of-web-shells-and-how-to-detect-them/)\n",
  "platforms": [
    "windows"
  ],
  "steps": [
    {
      "id": "67740c54-3bb6-4313-a2e5-11cac6cca3ba",
      "type": "execute-command",
      "data": {
        "command": "%windir%\\system32\\inetsrv\\appcmd.exe install module /name:#{module_name} /image:#{dll_path}",
        "command_type": "command_prompt"
      },
      "elevation_required": false
    },
    {
      "id": "e7bc9289-d0a9-4255-8b18-9c47e4ab58c6",
      "type": "execute-command",
      "data": {
        "command": "%windir%\\system32\\inetsrv\\appcmd.exe uninstall module #{module_name}",
        "command_type": "command_prompt"
      },
      "elevation_required": false
    },
    {
      "id": "f8ddfd28-9cf3-4be4-8120-16926e98ba3e",
      "name": "Check dependency 1/1",
      "description": "IIS must be installed in order to add a module to IIS.\n",
      "type": "execute-command",
      "data": {
        "command": "$service = get-service w3svc -ErrorAction SilentlyContinue\nif($service){ Write-Host \"IIS installed on $env:computername\" } else { Write-Host \"IIS is not installed on $env:computername\" }",
        "command_type": "command_prompt"
      },
      "elevation_required": false
    },
    {
      "id": "5866ac01-c1b8-4d95-a249-6278106a6beb",
      "name": "Resolve dependency 1/1",
      "description": "IIS must be installed in order to add a module to IIS.\n",
      "type": "execute-command",
      "data": {
        "command": "Install IIS to continue.",
        "command_type": "command_prompt"
      },
      "elevation_required": false
    },
    {
      "id": "971bffc2-3ca1-4ede-8833-626d16e95aff",
      "name": "Re-check dependency 1/1",
      "description": "IIS must be installed in order to add a module to IIS.\n",
      "type": "execute-command",
      "data": {
        "command": "$service = get-service w3svc -ErrorAction SilentlyContinue\nif($service){ Write-Host \"IIS installed on $env:computername\" } else { Write-Host \"IIS is not installed on $env:computername\" }",
        "command_type": "command_prompt"
      },
      "elevation_required": false
    }
  ],
  "flows": [
    {
      "s": "67740c54-3bb6-4313-a2e5-11cac6cca3ba",
      "p": "on-success",
      "o": "e7bc9289-d0a9-4255-8b18-9c47e4ab58c6"
    },
    {
      "s": "67740c54-3bb6-4313-a2e5-11cac6cca3ba",
      "p": "on-failure",
      "o": "e7bc9289-d0a9-4255-8b18-9c47e4ab58c6"
    },
    {
      "s": "f8ddfd28-9cf3-4be4-8120-16926e98ba3e",
      "p": "on-success",
      "o": "67740c54-3bb6-4313-a2e5-11cac6cca3ba"
    },
    {
      "s": "f8ddfd28-9cf3-4be4-8120-16926e98ba3e",
      "p": "on-failure",
      "o": "5866ac01-c1b8-4d95-a249-6278106a6beb"
    },
    {
      "s": "5866ac01-c1b8-4d95-a249-6278106a6beb",
      "p": "on-success",
      "o": "971bffc2-3ca1-4ede-8833-626d16e95aff"
    },
    {
      "s": "971bffc2-3ca1-4ede-8833-626d16e95aff",
      "p": "on-failure",
      "o": "67740c54-3bb6-4313-a2e5-11cac6cca3ba"
    }
  ],
  "tags": [
    "T1505",
    "T1505.004"
  ],
  "input_arguments": [
    {
      "name": "module_name",
      "type": "string",
      "description": "The name of the IIS module",
      "value": "DefaultDocumentModule_Atomic"
    },
    {
      "name": "dll_path",
      "type": "path",
      "description": "The path to the DLL to be loaded",
      "value": "%windir%\\system32\\inetsrv\\defdoc.dll"
    }
  ]
}